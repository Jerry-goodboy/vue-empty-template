// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper dojo/i18n!dojo/cldr/nls/number ../../Graphic ../../core/date ../../core/Error ../../core/Handles ../../core/lang ../../core/Logger ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../support/arcadeUtils ./support/featureUtils ./support/RelatedFeatures ../support/widget".split(" "),function(M,N,E,p,O,w,F,x,G,H,f,I,q,J,m,r,n,K,
y){function v(f,c){return f&&"feature"===f.type?f.getField(c):null}function L(f){return f.replace(/[\u00A0-\u99999<>\&]/gim,function(c){return"\x26#"+c.charCodeAt(0)+";"})}var A=I.getLogger("esri.widgets.FeatureViewModel"),B=/^\s*expression\//i,C=new G("cancelled-query","cancelled feature query"),D=x.getFormat("short-date-short-time"),t="DateFormat"+D;return function(z){function c(a){a=z.call(this)||this;a._handles=new H;a._featurePromise=void 0;a._layerDateFields=[];a.content=null;a.contentEnabled=
!0;a.formattedAttributes=null;a.title="";a.view=null;return a}E(c,z);c.prototype.destroy=function(){this._clear();this._handles.destroy();this.graphic=this.view=this._handles=null};Object.defineProperty(c.prototype,"graphic",{get:function(){return this._get("graphic")||null},set:function(a){if(a){var b=n.getSourceLayer(a);this._layerDateFields=b?this._getDateFields(b):[]}this._set("graphic",a);this._graphicChanged(a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"waitingForContent",
{get:function(){var a=this._featurePromise;return a?!a.isFulfilled():!1},enumerable:!0,configurable:!0});c.prototype._clear=function(){this._cancelFeatureQuery();this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};c.prototype._graphicChanged=function(a){var b=this,e=this._handles;e&&(e.remove("graphic"),this._clear(),a&&(e.add(J.watch(this,["graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","contentEnabled"],function(){b._graphicChanged(b.graphic)}),
"graphic"),this._featurePromise=this._queryFeature().then(function(){b.notifyChange("waitingForContent")}).catch(function(a){b.notifyChange("waitingForContent");a!==C&&A.log("error","error loading template",a);throw a;}),this.notifyChange("waitingForContent")))};c.prototype._cancelFeatureQuery=function(){var a=this._featurePromise;a&&!a.isFulfilled()&&a.cancel(C)};c.prototype._compileContent=function(a,b){var e=this;if(a&&(a.nodeName||a&&y.isWidgetBase(a)||y.isWidget(a)))return a;if("string"===typeof a)return this._compileText({type:"text",
text:a}).text;if(Array.isArray(a))return a.map(function(a,h){h=(h=b&&b[h])&&h.value;var d=a.type;if("attachments"===d)return e._compileAttachments(a,h);if("fields"===d)return e._compileFields(a);if("media"===d)return e._compileMedia(a);if("text"===d)return e._compileText(a)});a&&A.warn("invalid content type.")};c.prototype._compileFields=function(a){var b=this,e=this.graphic;a=f.clone(a);var d=e.get("popupTemplate.expressionInfos"),e=a.fieldInfos?void 0:e.get("popupTemplate.fieldInfos"),e=a.fieldInfos||
f.clone(e),h=[];e&&e.forEach(function(a){var e=a.fieldName.toLowerCase();if(!a.hasOwnProperty("visible")||a.visible)e=b._isExpressionField(e)?b._getExpressionInfo(d,e):null,a.label=e?e.title:a.label,h.push(a)});a.fieldInfos=h;return a};c.prototype._setImageValue=function(a,b,e){var d=a.linkURL;a.sourceURL=f.substitute(b,this._fixTokens(a.sourceURL,e));a.sourceURL&&d&&(a.linkURL=(""+f.substitute(b,this._fixTokens(d,e))).trim())};c.prototype._compileMedia=function(a){var b=this,e=this._layerDateFields,
d=this.graphic;a=f.clone(a);var h=a.mediaInfos||[],c=d.attributes,l=n.getSourceLayer(d),k=this.formattedAttributes.global,u={dateFormat:{properties:e,formatter:t}};a.mediaInfos=h.map(function(a){if(a=f.clone(a)){var e=a.value,d=a.type,h=a.title?b._processFieldsInLinks(b._fixTokens(a.title,l),c):"",g=a.caption?b._processFieldsInLinks(b._fixTokens(a.caption,l),c):"";a.title=h?(""+f.substitute(k,h,u)).trim():"";a.caption=g?(""+f.substitute(k,g,u)).trim():"";if("image"===d)return b._setImageValue(e,k,
l),a;if("pie-chart"===d||"line-chart"===d||"column-chart"===d||"bar-chart"===d)return b._setChartValue(e,k,l),a}});return a};c.prototype._compileText=function(a){var b=this._layerDateFields,e=this.graphic;if((a=f.clone(a))&&a.text){var d=n.getSourceLayer(e),h=e.attributes,e=this.formattedAttributes.global,b={dateFormat:{properties:b,formatter:t}},d=this._processFieldsInLinks(this._fixTokens(a.text,d),h);a.text=(""+f.substitute(e,d,b)).trim()}return a};c.prototype._compileTitle=function(){var a=this._layerDateFields,
b=this.graphic,e=b.get("popupTemplate.title"),d=b.attributes,h=n.getSourceLayer(b),a={dateFormat:{properties:a,formatter:t}},c=this.formattedAttributes.global;return"function"===typeof e?e.call(null,{graphic:b}):"string"===typeof e&&e?(b=this._processFieldsInLinks(this._fixTokens(e,h),d),(""+f.substitute(c,b,a)).trim()):""};c.prototype._getExpressionInfo=function(a,b){if(this._isExpressionField(b)){var e=b.replace(B,"").toLowerCase(),d;a.some(function(a){if(a.name.toLowerCase()===e)return d=a,!0});
return d}};c.prototype._fixTokens=function(a,b){return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,d,h){return(a=v(b,h))?"{"+a.name+"}":d})};c.prototype._encodeAttributes=function(a){var b=a?f.clone(a):{};Object.keys(b).forEach(function(a){var d=b[a];"string"===typeof d&&(d=encodeURIComponent(d).replace(/\'/g,"\x26apos;"),b[a]=d)});return b};c.prototype._formatAttributesToFieldInfos=function(a,b,e){var d=this,h=f.clone(this._layerDateFields);a.forEach(function(c){var g=d._getFixedFieldName(c.fieldName,
b);c.fieldName=g;e[g]=d._formatValue(e[g],{fieldInfos:a,fieldName:g,layer:b});h&&c.format&&c.format.dateFormat&&(c=h.indexOf(g),-1<c&&h.splice(c,1))})};c.prototype._getArcadeViewingMode=function(a){return a&&"local"===a.viewingMode?"localScene":"globalScene"};c.prototype._getViewInfo=function(){var a=this.view;if(a){var b="3d"===a.type?this._getArcadeViewingMode(a):"map";return r.getViewInfo({viewingMode:b,scale:a.scale,spatialReference:a.spatialReference})}};c.prototype._formatAttributes=function(a,
b,e){var d=this,c=this.graphic,g=c.attributes,l=n.getSourceLayer(c),k=g?f.clone(g):{};b&&b.forEach(function(a){var b="expression/"+a.name;a=e.get(a.name);var h=d._getViewInfo();a=r.executeFunction(a,r.createExecContext(c,h));k[b]="string"===typeof a?L(a):a});this.addRelatedFeatureAttributes(k);a&&this._formatAttributesToFieldInfos(a,l,k);if(l){var u=l.typeIdField;g&&Object.keys(g).forEach(function(a){if(!d.isRelatedField(a)){var b=g[a];f.isDefined(b)&&(b=d._getDomainName(a,b),f.isDefined(b)?k[a]=
b:a===u&&(b=d._getTypeName(),f.isDefined(b)&&(k[a]=b)))}})}return k};c.prototype._formatValue=function(a,b){var e={dateFormat:{properties:this._layerDateFields,formatter:t}},d=b.fieldName,c=this._getFieldInfo(b.fieldInfos,d),g=f.clone(c),c=b.preventPlacesFormatting;(b=v(b.layer,d))&&"date"===b.type&&(b=g.format||{},b.dateFormat=b.dateFormat||"short-date-short-time",g.format=b);d=g&&g.format;if(!f.isDefined(a)||!g||!f.isDefined(d))return a;var l=[],g=d.hasOwnProperty("places")||d.hasOwnProperty("digitSeparator");
b=d.hasOwnProperty("digitSeparator")?d.digitSeparator:!0;c=f.isDefined(d.places)&&(!c||0<d.places);g&&c&&l.push("places: "+Number(d.places));c=g?c?"NumberFormat("+l.join(",")+")":"NumberFormat":d.dateFormat?"DateFormat"+(x.getFormat(d.dateFormat)||D):void 0;if(!c)return a;a=f.substitute({myKey:a},"{myKey:"+c+"}",e)||"";return g&&!b&&w.group?a.replace(new RegExp("\\"+w.group,"g"),""):a};c.prototype._getDomainName=function(a,b){var e=this.graphic,d=n.getSourceLayer(e);return d&&"feature"===d.type?(a=
d.getFieldDomain(a,{feature:e}))&&"coded-value"===a.type?a.getName(b):null:null};c.prototype._getFieldInfo=function(a,b){if(a&&a.length&&b){var e=b.toLowerCase(),d=void 0;a.some(function(a){if(a.fieldName&&a.fieldName.toLowerCase()===e)return d=a,!0});return d}};c.prototype._getTypeName=function(){var a=this.graphic,b=n.getSourceLayer(a);if(b&&"feature"===b.type&&(a=b.getFeatureType(a),!a))return a.name};c.prototype._processFieldsInLinks=function(a,b){var e=this._encodeAttributes(b),d=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/ig;
return a?a.replace(d,function(a,d,c){d=(""+(d||c)).trim();return f.substitute(d&&"{"===d[0]?b:e,a)}):a};c.prototype._compileAttachments=function(a,b){a=f.clone(a);if(!b)return a;a.attachmentInfos=b;return a};c.prototype._queryAttachments=function(){var a=this.graphic,b=n.getSourceLayer(a);return b?(b="scene"===b.type&&b.associatedLayer?b.associatedLayer:b)&&"feature"===b.type?b.queryFeatureAttachments(a):q.resolve([]):q.resolve([])};c.prototype._queryContentElements=function(a){var b=this;if(!Array.isArray(a))return q.resolve();
var e={};a.forEach(function(a,c){"attachments"===a.type&&(a=b._queryAttachments())&&(e[c]=a)});return Object.keys(e).length?q.eachAlways(e):q.resolve()};c.prototype._getContent=function(){var a=this.graphic;if(!this.contentEnabled)return q.resolve();var b=a.get("popupTemplate.content"),a="function"===typeof b?b.call(null,{graphic:a}):b;return q.isThenable(a)?a:q.resolve(a)};c.prototype._queryFeature=function(){var a=this;return this._getContent().then(function(b){return a._checkForRelatedFeatures(b).then(function(){a._set("formattedAttributes",
a._createFormattedAttributes(b));a._set("title",a._compileTitle());return a._queryContentElements(b).then(function(e){e=a._compileContent(b,e);a._set("content",e||null);return e})})})};c.prototype._isExpressionField=function(a){return B.test(a)};c.prototype._createCompiledExpressionDictionary=function(a){var b=new Map;if(!a)return b;a.forEach(function(a){return b.set(a.name,r.createFunction(a.expression))});return b};c.prototype._getDateFields=function(a){return(a=a.fields)?a.filter(function(a){return"date"===
a.type}).map(function(a){return a.name}):[]};c.prototype._createFormattedAttributes=function(a){var b=this,e=this.graphic,d=e.get("popupTemplate.fieldInfos"),c=e.get("popupTemplate.expressionInfos"),g=this._createCompiledExpressionDictionary(c),f={global:this._formatAttributes(d,c,g),content:[]};Array.isArray(a)&&a.forEach(function(a,d){"fields"===a.type&&a.fieldInfos&&(f.content[d]=b._formatAttributes(a.fieldInfos,c,g))});return f};c.prototype._getAllFieldInfos=function(a){var b=[],e=this.graphic.get("popupTemplate.fieldInfos");
e&&b.push.apply(b,e);if(!a||!Array.isArray(a))return b;a.forEach(function(a){b.push.apply(b,a&&a.fieldInfos)});return b};c.prototype._checkForRelatedFeatures=function(a){var b=this.graphic;a=this._getAllFieldInfos(a);return this.queryRelatedInfos(b,a)};c.prototype._getChartOption=function(a,b,e,d,c){var g=n.getSourceLayer(this.graphic),f=b.normalizeField;b=b.tooltipField;f=f?this.isRelatedField(f)?e[this.getRelatedFieldInfo(f).fieldName]:e[f]:null;a=parseFloat(e[a]);var h=void 0===a?null:a&&f?a/f:
a;a={y:h,tooltip:""+h};if(!b)return a;if(this.isRelatedField(b))return d=this.getRelatedFieldInfo(b).fieldName,e=e[d],c=this._formatValue(h,{fieldInfos:c,fieldName:e,layer:g,preventPlacesFormatting:!!f}),a.tooltip=e+":"+c,a;e=this._getFieldInfo(c,d);d=this._getFixedFieldName(d,g);c=this._formatValue(h,{fieldInfos:c,fieldName:b,layer:g,preventPlacesFormatting:!!f});a.tooltip=(e?e.fieldName:d)+":"+c;return a};c.prototype._getFixedFieldName=function(a,b){return(b=v(b,a))?b.name:a};c.prototype._getFixedFieldNames=
function(a,b){var c=this;return a&&a.map(function(a){return c._getFixedFieldName(a,b)})};c.prototype._setChartValue=function(a,b,c){var d=this,e=this.graphic,g=this.relatedInfoCount,l=a.fields,k=a.normalizeField;a.fields=this._getFixedFieldNames(l,c);k&&(a.normalizeField=this._getFixedFieldName(k,c));if(l.some(function(a){return!!(f.isDefined(b[a])||d.isRelatedField(a)&&g)})){var m=e.get("popupTemplate.fieldInfos");a.chartOptions=a.chartOptions||[];l.forEach(function(c){d.isRelatedField(c)?a.chartOptions=
a.chartOptions.concat(d._getRelatedChartInfos(m,c,a,b)):(c=d._getChartOption(c,a,b,c,m),a.chartOptions.push(c))})}};c.prototype._getRelatedChartInfos=function(a,b,c,d){var e=this,f=[];d=this.getRelatedFieldInfo(b);var l=d.fieldName,k=this.getRelatedInfo(d.layerId);if(!k)return f;d=k.relatedFeatures;k=k.relation;if(!k||!d)return f;k=k.cardinality;d.forEach(function(d){var g=d.attributes;g&&Object.keys(g).forEach(function(d){d===l&&f.push(e._getChartOption(d,c,g,b,a))})});return"one-to-many"===k||"many-to-many"===
k?f:[f[0]]};p([m.property({readOnly:!0})],c.prototype,"content",void 0);p([m.property()],c.prototype,"contentEnabled",void 0);p([m.property({readOnly:!0})],c.prototype,"formattedAttributes",void 0);p([m.property({type:F})],c.prototype,"graphic",null);p([m.property({readOnly:!0})],c.prototype,"title",void 0);p([m.property()],c.prototype,"view",void 0);p([m.property({readOnly:!0})],c.prototype,"waitingForContent",null);return c=p([m.subclass("esri.widgets.FeatureViewModel")],c)}(m.declared(K))});