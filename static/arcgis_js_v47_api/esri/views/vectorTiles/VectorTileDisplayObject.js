// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/ObjectPool ../../core/libs/gl-matrix/mat4 ../../core/libs/gl-matrix/vec2 ../../geometry/support/spatialReferenceUtils ../2d/engine/DisplayObject ../2d/tiling/TileKey ./RenderBucket ../webgl/BufferObject".split(" "),function(z,A,r,t,u,v,w,x,y,p,f){return function(q){function g(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];c=q.call(this)||this;c._renderBuckets=[];c._vectorTileData=null;c._symbolUpdateData=null;c.status=
5;c.coords=[0,0];c.bounds=[0,0,0,0];c.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]};c.stencilData={mask:0,reference:0};c.status=0;c.tileTransform.transform=u.create();c.tileTransform.displayCoord=v.create();0<a.length&&(f=c.acquire).call.apply(f,[c].concat(a));return c;var f}r(g,q);g.prototype.reset=function(){y.pool.release(this.key);this.refKey=this.key=null;this.coords[0]=0;this.coords[1]=0;this.bounds[0]=0;this.bounds[1]=0;this.bounds[2]=0;this.height=this.width=this.bounds[3]=
0;this.resolution=null;this.rotation=0;this.id=this.client=this.styleLayers=this._vectorTileData=null;this.tileTransform.transform.fill(0);this.tileTransform.displayCoord.fill(0);this.stencilData.mask=0;this.stencilData.reference=0;this._renderBuckets.length=0;this._symbolUpdateData=null;this.status=0};g.prototype.acquire=function(a,c,f,b,k){this.key=a;this.refKey=c;c=f.lodAt(a.level).resolution;var d=f.size[0]*c,e=f.origin,h=a.col*d,m=a.row*d,l=f.spatialReference,g=0;l&&(l._isWrappable?l._isWrappable():
l.isWrappable)&&(l=w.getInfo(l),g=l.valid[1]-l.valid[0]);h=e.x+h+a.world*g;e=e.y-m;this.coords[0]=h;this.coords[1]=e;this.bounds[0]=h;this.bounds[1]=e;this.bounds[2]=h+d;this.bounds[3]=e-d;this.widthInPixels=f.size[1];this.coordRange=4096;this.resolution=c;this.rotation=k;this.styleLayers=b;this.id=a.id;this.status=1};g.prototype.setData=function(a,c){this._vectorTileData=a;this.client=c;this.status=3};g.prototype.updateSymbolData=function(a){a&&(this._symbolUpdateData=a,this.requestRender())};g.prototype.dispose=
function(){this.fillVertexArrayObject&&(this.fillVertexArrayObject.dispose(),this.fillVertexArrayObject=null);this.fillDDVertexArrayObject&&(this.fillDDVertexArrayObject.dispose(),this.fillDDVertexArrayObject=null);this.outlineVertexArrayObject&&(this.outlineVertexArrayObject.dispose(),this.outlineVertexArrayObject=null);this.outlineDDVertexArrayObject&&(this.outlineDDVertexArrayObject.dispose(),this.outlineDDVertexArrayObject=null);this.lineVertexArrayObject&&(this.lineVertexArrayObject.dispose(),
this.lineVertexArrayObject=null);this.lineDDVertexArrayObject&&(this.lineDDVertexArrayObject.dispose(),this.lineDDVertexArrayObject=null);this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),
this.textDDVertexArrayObject=null);this.circleVertexArrayObject&&(this.circleVertexArrayObject.dispose(),this.circleVertexArrayObject=null);this.fillVertexBuffer&&(this.fillVertexBuffer.dispose(),this.fillVertexBuffer=null);this.fillDDVertexBuffer&&(this.fillDDVertexBuffer.dispose(),this.fillDDVertexBuffer=null);this.fillIndexBuffer&&(this.fillIndexBuffer.dispose(),this.fillIndexBuffer=null);this.outlineVertexBuffer&&(this.outlineVertexBuffer.dispose(),this.outlineVertexBuffer=null);this.outlineDDVertexBuffer&&
(this.outlineDDVertexBuffer.dispose(),this.outlineDDVertexBuffer=null);this.outlineIndexBuffer&&(this.outlineIndexBuffer.dispose(),this.outlineIndexBuffer=null);this.lineVertexBuffer&&(this.lineVertexBuffer.dispose(),this.lineVertexBuffer=null);this.lineDDVertexBuffer&&(this.lineDDVertexBuffer.dispose(),this.lineDDVertexBuffer=null);this.lineIndexBuffer&&(this.lineIndexBuffer.dispose(),this.lineIndexBuffer=null);this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconDDVertexBuffer&&
(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null);this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null);this.circleVertexBuffer&&(this.circleVertexBuffer.dispose(),this.circleVertexBuffer=null);this.circleIndexBuffer&&
(this.circleIndexBuffer.dispose(),this.circleIndexBuffer=null);this.texture&&(this.texture.dispose(),this.texture=null);this._renderBuckets.length=0;this.status=7};g.prototype.getCpuMemoryUsage=function(){return null!=this._vectorTileData&&this._vectorTileData.bufferData?this._vectorTileData.bufferData.reduce(function(a,c){return a+c.byteLength},0)+this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength:0};g.prototype.getGpuMemoryUsage=function(){var a=0;this.fillVertexBuffer&&
(a+=this.fillVertexBuffer.size);this.fillDDVertexBuffer&&(a+=this.fillDDVertexBuffer.size);this.fillIndexBuffer&&(a+=this.fillIndexBuffer.size);this.outlineVertexBuffer&&(a+=this.outlineVertexBuffer.size);this.outlineDDVertexBuffer&&(a+=this.outlineDDVertexBuffer.size);this.outlineIndexBuffer&&(a+=this.outlineIndexBuffer.size);this.lineVertexBuffer&&(a+=this.lineVertexBuffer.size);this.lineDDVertexBuffer&&(a+=this.lineDDVertexBuffer.size);this.lineIndexBuffer&&(a+=this.lineIndexBuffer.size);this.iconVertexBuffer&&
(a+=this.iconVertexBuffer.size);this.iconDDVertexBuffer&&(a+=this.iconDDVertexBuffer.size);this.iconIndexBuffer&&(a+=this.iconIndexBuffer.size);this.textVertexBuffer&&(a+=this.textVertexBuffer.size);this.textDDVertexBuffer&&(a+=this.textDDVertexBuffer.size);this.textIndexBuffer&&(a+=this.textIndexBuffer.size);this.circleVertexBuffer&&(a+=this.circleVertexBuffer.size);this.circleIndexBuffer&&(a+=this.circleIndexBuffer.size);this.texture&&(a+=this.texture.descriptor.width*this.texture.descriptor.height*
4);return a};g.prototype.attach=function(a){if(4===this.status)return!0;this.status=3;if(!this._vectorTileData||!this._vectorTileData.bufferDataInfo)return this.status=4,!0;if(0===this._renderBuckets.length)for(var c=new Uint32Array(this._vectorTileData.bucketDataInfo),g=c.length,b=0;b<g;){var k=c[b],d=c[b+1];if(0===d)d=new p.BackgroundRenderBucket,d.layerID=k,this._renderBuckets.push(d),b+=2;else if(1===d)d=new p.FillRenderBucket,d.layerID=k,d.triangleElementStart=c[b+2],d.triangleElementCount=c[b+
3],d.outlineElementStart=c[b+4],d.outlineElementCount=c[b+5],this._renderBuckets.push(d),b+=6;else if(2===d)d=new p.LineRenderBucket,d.layerID=k,d.triangleElementStart=c[b+2],d.triangleElementCount=c[b+3],this._renderBuckets.push(d),b+=4;else if(3===d){d=new p.SymbolRenderBucket;d.layerID=k;d.isSDF=0!==c[b+2];var e=b+3,k=c[e];e++;if(0<k)for(var h=void 0,m=void 0,l=void 0,n=0;n<k;n++)h=c[e],m=c[e+1],l=c[e+2],d.markerPerPageElementsMap.set(h,[m,l]),e+=3;var q=c[e];e++;if(0<q)for(l=m=h=void 0,n=0;n<
q;n++)h=c[e],m=c[e+1],l=c[e+2],d.glyphPerPageElementsMap.set(h,[m,l]),e+=3;this._renderBuckets.push(d);b+=5+3*k+3*q}else 4===d?(d=new p.CircleRenderBucket,d.layerID=k,d.triangleElementStart=c[b+2],d.triangleElementCount=c[b+3],this._renderBuckets.push(d),b+=4):console.error("Bad bucket type!")}a=a.context;c=new Uint32Array(this._vectorTileData.bufferDataInfo);g=c.length;for(d=b=0;d<g;d+=2,b++)if(!(0>=c[d+1]||0===this._vectorTileData.bufferData[b].byteLength))switch(c[d]){case 1:this.fillVertexBuffer?
this.fillVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.fillVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 2:this.fillDDVertexBuffer?this.fillDDVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.fillDDVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 3:this.fillIndexBuffer?this.fillIndexBuffer.setData(this._vectorTileData.bufferData[b]):this.fillIndexBuffer=f.createIndex(a,35044,this._vectorTileData.bufferData[b]);
break;case 4:this.outlineVertexBuffer?this.outlineVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.outlineVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 5:this.outlineDDVertexBuffer?this.outlineDDVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.outlineDDVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 6:this.outlineIndexBuffer?this.outlineIndexBuffer.setData(this._vectorTileData.bufferData[b]):this.outlineIndexBuffer=
f.createIndex(a,35044,this._vectorTileData.bufferData[b]);break;case 7:this.lineVertexBuffer?this.lineVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.lineVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 8:this.lineDDVertexBuffer?this.lineDDVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.lineDDVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 9:this.lineIndexBuffer?this.lineIndexBuffer.setData(this._vectorTileData.bufferData[b]):
this.lineIndexBuffer=f.createIndex(a,35044,this._vectorTileData.bufferData[b]);break;case 10:this.iconVertexBuffer?this.iconVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.iconVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 11:this.iconDDVertexBuffer?this.iconDDVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.iconDDVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 12:this.iconIndexBuffer?this.iconIndexBuffer.setData(this._vectorTileData.bufferData[b]):
this.iconIndexBuffer=f.createIndex(a,35044,this._vectorTileData.bufferData[b]);break;case 13:this.textVertexBuffer?this.textVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.textVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 14:this.textDDVertexBuffer?this.textDDVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.textDDVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 15:this.textIndexBuffer?this.textIndexBuffer.setData(this._vectorTileData.bufferData[b]):
this.textIndexBuffer=f.createIndex(a,35044,this._vectorTileData.bufferData[b]);break;case 16:this.circleVertexBuffer?this.circleVertexBuffer.setData(this._vectorTileData.bufferData[b]):this.circleVertexBuffer=f.createVertex(a,35044,this._vectorTileData.bufferData[b]);break;case 17:this.circleIndexBuffer?this.circleIndexBuffer.setData(this._vectorTileData.bufferData[b]):this.circleIndexBuffer=f.createIndex(a,35044,this._vectorTileData.bufferData[b])}this._vectorTileData=null;this.status=4;return!0};
g.prototype.detach=function(a){this.client&&6!==this.status&&7!==this.status&&this.client.invoke("destructTileData",this.id);this.dispose();q.prototype.detach.call(this,a)};g.prototype.doRender=function(a){if(this.visible&&4===this.status){var c=a.context,f=a.renderer;if(c&&f){var b=a.drawphase;this._symbolUpdateData&&this._updateSymbolData(a);c.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var k=this.styleLayers,d=void 0!==a.layerOpacity?a.layerOpacity:1;if(0!==d){var e,
h=this._renderBuckets.length,g=0;if(0===b)for(g=h-1;0<=g;g--)e=this._renderBuckets[g],3!==e.type&&e.hasData()&&f.renderBucket(c,e,a.displayLevel,a.requiredLevel,b,this,k.layers[e.layerID],d);else for(g=0;g<h;g++)e=this._renderBuckets[g],e.hasData()&&f.renderBucket(c,e,a.displayLevel,a.requiredLevel,b,this,k.layers[e.layerID],d)}}}};g.prototype._updateSymbolData=function(a){if(!this._symbolUpdateData.bucketDataInfo)return!0;var c=new Uint32Array(this._symbolUpdateData.bucketDataInfo),g=c.length;if(0===
g)return this._symbolUpdateData=null,!0;if(4!==this.status)return this.requestRender(),!1;a=a.context;for(var b=new Uint32Array(this._symbolUpdateData.bufferDataInfo),k=b.length,d=0,e=0;e<k;e+=2,d++)switch(b[e]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null);this.iconVertexBuffer=f.createVertex(a,35044,this._symbolUpdateData.bufferData[d]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null);this.iconDDVertexBuffer=
f.createVertex(a,35044,this._symbolUpdateData.bufferData[d]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null);this.iconIndexBuffer=f.createIndex(a,35044,this._symbolUpdateData.bufferData[d]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null);this.textVertexBuffer=f.createVertex(a,35044,this._symbolUpdateData.bufferData[d]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=
null);this.textDDVertexBuffer=f.createVertex(a,35044,this._symbolUpdateData.bufferData[d]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=f.createIndex(a,35044,this._symbolUpdateData.bufferData[d])}a=this._renderBuckets.length;for(b=0;b<a;b++)this._renderBuckets[b]instanceof p.SymbolRenderBucket&&(k=this._renderBuckets[b],k.markerPerPageElementsMap.clear(),k.glyphPerPageElementsMap.clear());for(a=0;a<g;){k=c[a];d=-1;e=this._renderBuckets.length;
for(b=0;b<e;b++)if(this._renderBuckets[b].layerID===k){d=b;break}b=this._renderBuckets[d];b||(b=new p.SymbolRenderBucket,b.layerID=k,b.isSDF=0!==c[a+2],this._renderBuckets.push(b));var h=a+3,k=c[h];h++;if(0<k)for(var m=e=d=void 0,l=0;l<k;l++)d=c[h],e=c[h+1],m=c[h+2],b.markerPerPageElementsMap.set(d,[e,m]),h+=3;var n=c[h];h++;if(0<n)for(m=e=d=void 0,l=0;l<n;l++)d=c[h],e=c[h+1],m=c[h+2],b.glyphPerPageElementsMap.set(d,[e,m]),h+=3;a+=5+3*k+3*n}this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),
this.iconVertexArrayObject=null);this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null);this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null);this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null);this._symbolUpdateData=null;return!0};g.pool=new t(g);return g}(x)});