// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Error ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../tasks/QueryTask ../../../../tasks/support/StatisticDefinition ./util".split(" "),function(r,t,h,g,k,l,m,f,n,p,q){var e;(function(d){d[d.Snapshot=0]="Snapshot";d[d.OnDemand=1]="OnDemand"})(e||(e={}));return function(d){function a(){return null!==d&&d.apply(this,
arguments)||this}h(a,d);Object.defineProperty(a.prototype,"_countThresholdForAuto",{get:function(){var b=this.layerView.layer.geometryType,c;"polyline"===b||"polygon"===b||"multipoint"===b?c=2E3:"point"===b&&(c=4E3);return c},enumerable:!0,configurable:!0});a.prototype.updateControllerConfiguration=function(){var b=this;return this._getModePromise().then(function(c){b._set("controllerConfiguration",{type:c===e.Snapshot?"snapshot":"on-demand",url:b.layerView.layer.parsedUrl.path,capabilities:{supportsQuantization:b.layerView.layer.capabilities.query.supportsQuantization},
definitionExpression:b.layerView.layer.definitionExpression,queryInMainThread:b.layerView.layer.source&&"esri.layers.graphics.sources.CSVSource"===b.layerView.layer.source.declaredClass,processing:b.layerView.layer.processing&&b.layerView.layer.processing.toWorker()||null,objectIdField:b.layerView.layer.objectIdField,geometryType:q.toJSONGeometryType(b.layerView.layer.geometryType),outFields:b.layerView.layer.outFields,spatialReference:b.layerView.view.spatialReference.toJSON()})})};a.prototype._getModePromise=
function(){var b=this;return this.layerView.layer.source.parsedUrl?this.layerView.layer.when(function(){b._verifyCapabilities()}).then(function(){return b._figureOutMode().then(function(b){return b})}):m.reject()};a.prototype._figureOutMode=function(){return this._isStatisticsSupported()?this._checkByStatistics():this._checkByCount()};a.prototype._isStatisticsSupported=function(){return/(https?:)?\/\/services.*\.arcgis\.com/i.test(this.layerView.layer.source.parsedUrl.path)};a.prototype._checkByStatistics=
function(){var b=this,c=this.layerView.layer,a=c.source.parsedUrl.path,c=c.createQuery();c.outStatistics=[new p({statisticType:"exceedslimit",maxPointCount:4E3,maxRecordCount:2E3,maxVertexCount:25E4,outStatisticFieldName:"exceedslimit"})];return(new n({url:a+"/query"})).execute(c).then(function(a){a=a&&a.features&&a.features[0];if(0===(a&&a.attributes&&a.attributes.exceedslimit)){a=b.layerView.layer;var c=a.maxRecordCount;if(a.get("capabilities.query.supportsPagination")||c>=b._countThresholdForAuto)return e.Snapshot}return e.OnDemand})};
a.prototype._checkByCount=function(){var b=this,a=this.layerView.layer;return a.queryFeatureCount().then(function(c){return c<=b._countThresholdForAuto&&c<=a.maxRecordCount?e.Snapshot:e.OnDemand})};a.prototype._verifyCapabilities=function(){if(!this.layerView.layer.capabilities.operations.supportsQuery)throw new l("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:this.layerView.layer});};g([f.property()],a.prototype,"layerView",
void 0);g([f.property({readOnly:!0})],a.prototype,"controllerConfiguration",void 0);return a=g([f.subclass("esri.views.2d.layers.support.AutoControllerConfigurator")],a)}(f.declared(k))});