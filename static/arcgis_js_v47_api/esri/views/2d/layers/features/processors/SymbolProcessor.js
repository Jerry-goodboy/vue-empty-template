// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/executeAsync ../../../../../core/MapPool ../../../../../core/promiseUtils ../../../../../core/SetPool ../../../../../core/accessorSupport/decorators ../../../../../renderers/support/jsonUtils ../../../engine/webgl/displayObjectUtils ../../../engine/webgl/rendererInfoUtils ../../../engine/webgl/TileData ../../../engine/webgl/Utils ./BaseProcessor".split(" "),function(v,
w,B,p,x,q,t,u,n,C,y,D,z,r,E){function F(d){return d&&("unique-value"===d.type||"class-breaks"===d.type)&&null!==d.backgroundFillSymbol}function A(d,c){r.isMarkerSymbol(d)||r.isLineSymbol(d)?c.add(d):r.isFillSymbol(d)&&(c.add(d),d.outline&&"none"!==d.outline.style&&c.add(d.outline))}function G(d,c){if(!c.has(d)){c.set(d,new Set);var b=d.text;d=c.get(d);c=b.length;for(var a=0;a<c;a++){var e=b.charCodeAt(a);d.add(e)}}}Object.defineProperty(w,"__esModule",{value:!0});v=function(d){function c(){var b=
null!==d&&d.apply(this,arguments)||this;b.type="symbol";b._symbolToMosaicItemMap=new Map;b._visualSetPromises=new Map;return b}B(c,d);c.prototype.destroy=function(){this._visualSetPromises.forEach(function(b,a){b.cancel()});this._visualSetPromises.clear();this._symbolToMosaicItemMap.clear();this.notifyChange("updating")};Object.defineProperty(c.prototype,"queryInfo",{get:function(){var b=this.configuration,a=b.renderer,e=b.definitionExpression,c=b.outFields,d=b.gdbVersion,b=b.historicMoment,f=this.service.geometryType,
h=this._getReturnCentroid(this.rendererInfo.renderer),f="esriGeometryPoint"===f||"esriGeometryMultipoint"===f||h?20:0,g=null;(a=a.visualVariables)&&a.some(function(b){if("size"===b.type&&b.field&&!b.normalizationField)return g=[b.field+" DESC"],!0});return{definitionExpression:e,orderByFields:g,outFields:c,pixelBuffer:f,returnCentroid:h,returnGeometry:!0,gdbVersion:d,historicMoment:b}},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererInfo",{get:function(){return this.configuration?
D.createRendererInfo(C.fromJSON(this.configuration.renderer),this.tileStore.spatialReference,{fields:this.service.fields}):null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._visualSetPromises.size},enumerable:!0,configurable:!0});c.prototype.featureSetReady=function(b,a,e){var c=this;!e&&a&&a.features&&0!==a.features.length?(e=t.when(this._getMosaicItems(a.features)).then(function(){return c._createTileData(a.features)}).then(function(a){var e=
a.serialize();a=e.result;e=e.transferList;c._visualSetPromises.delete(b);c.notifyChange("updating");c.remoteClient.invoke("setTileVisuals",{tileKey:b.id,data:a},e)}).catch(function(a){c._visualSetPromises.delete(b);c.notifyChange("updating");if(a&&"cancel"!==a.dojoType)return c.remoteClient.invoke("setTileVisuals",{tileKey:b.id,data:null,error:a.message}),t.reject(a)}),this._visualSetPromises.set(b,e),this.notifyChange("updating")):this.remoteClient.invoke("setTileVisuals",{tileKey:b.id,data:null,
error:e})};c.prototype.featurePatchReady=function(b,a){var e=this;this._getMosaicItems(a.addOrUpdate||[]).then(function(){if(!a.addOrUpdate||0===a.addOrUpdate.length)return e.remoteClient.invoke("patchTileVisuals",{tileKey:b.id,data:{remove:a.remove,addOrUpdate:null}}),t.resolve();var c=[],d={},f=a.addOrUpdate.length,h,g=0;return x(function(){h=a.addOrUpdate[g];g++;c.push(y.getDisplayObject(h,e.service.objectIdField,e.rendererInfo,e.service.geometryType,e.configuration.devicePixelRatio,e._symbolToMosaicItemMap,
d));return g===f}).then(function(){var f=z.create(c,d).serialize();e.remoteClient.invoke("patchTileVisuals",{tileKey:b.id,data:{remove:a.remove,addOrUpdate:f.result}},f.transferList)})})};c.prototype.tileAdded=function(b){};c.prototype.tileRemoved=function(b){var a=this._visualSetPromises;a.has(b)&&(a.get(b).cancel(),a.delete(b),this.notifyChange("updating"))};c.prototype._createTileData=function(b){var a=this,c=[],d={},l=0;return x(function(){var e=b[l];l++;e=y.getDisplayObject(e,a.service.objectIdField,
a.rendererInfo,a.service.geometryType,a.configuration.devicePixelRatio,a._symbolToMosaicItemMap,d);c.push(e);return l===b.length}).then(function(){return z.create(c,d)})};c.prototype._getReturnCentroid=function(b){function a(a){if(!a)return!1;a=a.type;return"simple-marker"===a||"picture-marker"===a||"text"===a}if("esriGeometryPolygon"!==this.service.geometryType)return!1;switch(b.type){case "simple":return a(b.symbol);case "unique-value":return a(b.defaultSymbol)||b.uniqueValueInfos.some(function(b){return a(b.symbol)});
case "class-breaks":return a(b.defaultSymbol)||b.classBreakInfos.some(function(b){return a(b.symbol)});default:return!0}};c.prototype._getMosaicItems=function(b){var a=u.acquire(),c=q.acquire(),d=this.rendererInfo;F(d.renderer)&&A(d.renderer.backgroundFillSymbol,a);for(var l=0;l<b.length;l++){var f=d.getSymbol(b[l]);f&&(r.isTextSymbol(f)?G(f,c):A(f,a))}0===a.size&&0===c.size&&(u.release(a),q.release(c));var h=q.acquire(),g=[],m=this._symbolToMosaicItemMap,k=0;a.forEach(function(a){m.has(a)||(h.set(k,
a),g.push({symbol:a.toJSON(),id:k}),k++)});c.forEach(function(a,b){if(m.has(b)){var c=m.get(b).glyphMosaicItems,d=[];a.forEach(function(a){if(c&&c.length<a||!c[a])d[a]=a});0<d.length&&(h.set(k,b),g.push({symbol:b.toJSON(),id:k,glyphIds:d}),k++)}else{h.set(k,b);var e=Array(a.size);a.forEach(function(a){return e.push(a)});g.push({symbol:b.toJSON(),id:k,glyphIds:e});k++}});if(0<g.length)return this.remoteClient.invoke("getMaterialItems",g).then(function(a){for(var b=0;b<a.length;b++){var c=a[b],d=h.get(c.id);
if(d)if(r.isTextSymbol(d))if(m.has(d)){if(d=m.get(d).glyphMosaicItems,c=c.mosaicItem.glyphMosaicItems)for(var e=0;e<c.length;e++)null!=c[e]&&(d[e]=c[e])}else m.set(d,c.mosaicItem);else m.set(d,c.mosaicItem)}q.release(h)});u.release(a);q.release(c);return t.resolve()};p([n.property()],c.prototype,"configuration",void 0);p([n.property({constructOnly:!0})],c.prototype,"queryInfo",null);p([n.property({dependsOn:["configuration"]})],c.prototype,"rendererInfo",null);p([n.property({readOnly:!0})],c.prototype,
"updating",null);return c=p([n.subclass()],c)}(n.declared(E.default));w.default=v});