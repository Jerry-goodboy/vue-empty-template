// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports dojo/has dojo/promise/all ./fontUtils ./Rect ./RectangleBinPack ../../../webgl/Texture".split(" "),function(H,I,v,D,E,F,C,G){var r;v("stable-symbol-rendering")&&(r=new Set);return function(){function g(b,d,a){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;(0>=b||0>=d)&&console.error("Glyph mosaic width and height must be greater than zero!");this.width=b;this.height=d;this._glyphSource=
a;this._binPack=new C(b-4,d-4);this._glyphData.push(new Uint8Array(b*d));this._dirties.push(!0);this._textures.push(void 0)}g.prototype.getGlyphItems=function(b,d){var a=this,t=E.getFullyQualifiedFontName(b),k=[],g=this._glyphSource,A=new Set;b=1/256;for(var n=0;n<d.length;n++)A.add(Math.floor(d[n]*b));var B=[];A.forEach(function(b){if(256>=b){var c=t+b;a._rangePromises.has(c)?B.push(a._rangePromises.get(c)):(b=g.getRange(t,b).always(function(){a._rangePromises["delete"](c)}),a._rangePromises.set(c,
b),B.push(b))}});return D(B).then(function(b){b=a._glyphIndex[t];b||(b={},a._glyphIndex[t]=b);var c;if(v("stable-symbol-rendering")){r.clear();for(var f=0;f<d.length;f++)c=d[f],r.add(c);var w=[];A.forEach(function(a){w.push(a)});w.sort();c=[];for(f=0;f<w.length;f++)for(var x=w[f],e=0;256>e;++e)c.push(256*x+e)}else c=d;f=0;for(x=c;f<x.length;f++)if(c=x[f],e=b[c]){if(!v("stable-symbol-rendering")||r.has(c))k[c]={rect:e.rect,metrics:e.metrics,page:e.page}}else{var l=g.getGlyph(t,c);if(l&&l.metrics){var e=
l.metrics,h=void 0;if(0===e.width)h=new F(0,0,0,0);else{var p=e.width+6,u=e.height+6,q=p%4?4-p%4:4,m=u%4?4-u%4:4;1===q&&(q=5);1===m&&(m=5);h=a._binPack.allocate(p+q,u+m);h.isEmpty&&(a._dirties[a._currentPage]||(a._glyphData[a._currentPage]=null),a._currentPage=a._glyphData.length,a._glyphData.push(new Uint8Array(a.width*a.height)),a._dirties.push(!0),a._textures.push(void 0),a._binPack=new C(a.width-4,a.height-4),h=a._binPack.allocate(p+q,u+m));var q=a._glyphData[a._currentPage],l=l.bitmap,n=m=void 0;
if(l)for(var y=0;y<u;y++)for(var m=p*y,n=a.width*(h.y+y+1)+h.x,z=0;z<p;z++)q[n+z+1]=l[m+z]}b[c]={rect:h,metrics:e,tileIDs:null,page:a._currentPage};if(!v("stable-symbol-rendering")||r.has(c))k[c]={rect:h,metrics:e,page:a._currentPage};a._dirties[a._currentPage]=!0}}return k})};g.prototype.bind=function(b,d,a,g){this._textures[a]||(this._textures[a]=new G(b,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var k=this._textures[a];k.setSamplingMode(d);
this._dirties[a]&&k.setData(this._glyphData[a]);b.bindTexture(k,g);this._dirties[a]=!1};g.prototype.dispose=function(){this._binPack=null;for(var b=0,d=this._textures;b<d.length;b++){var a=d[b];a&&a.dispose()}this._textures.length=0};return g}()});