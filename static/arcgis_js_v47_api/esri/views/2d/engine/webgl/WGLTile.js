// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix/mat4 ../../../../core/libs/gl-matrix/vec2 ../DisplayObject ./DisplayRecordStore ./enums ./WGLBuffers ./WGLDisplayList ./WGLDisplayObject ./WGLDisplayRecord ../../tiling/TileKey".split(" "),function(B,C,t,u,v,w,p,b,q,x,y,r,z){function A(b,a){return b.sortKey-a.sortKey}var m=new Set;return function(k){function a(c,a){var d=k.call(this)||this;d.tileStatus=b.TileStatus.INITIALIZED;d._data=null;d.hlDisplayList=
null;d._wglBuffers=null;d.coords=[0,0];d.bounds=[0,0,0,0];d.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]};d._hasVisualVariables=!1;d.tileTransform.transform=u.create();d.tileTransform.displayCoord=v.create();d.key=z.pool.acquire(c);d.coords[0]=a[0];d.coords[1]=a[3];d.bounds=a;return d}t(a,k);Object.defineProperty(a.prototype,"iconGeometry",{get:function(){return this.getGeometry(b.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"textGeometry",{get:function(){return this.getGeometry(b.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"fillGeometry",{get:function(){return this.getGeometry(b.WGLGeometryType.FILL)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"lineGeometry",{get:function(){return this.getGeometry(b.WGLGeometryType.LINE)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this._data},
enumerable:!0,configurable:!0});a.prototype.getGeometry=function(c){return this._wglBuffers&&this._wglBuffers.has(c)?this._wglBuffers.get(c):null};a.prototype.getDisplayList=function(c){switch(c){case b.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._data.tileDisplayData.displayList}};Object.defineProperty(a.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0});a.prototype.setData=function(c,a,d){d?(this.clear(),this.tileStatus=b.TileStatus.INVALID):
c&&c.tileDisplayData?(this._dispRecStore=p.default.fromTileData(c),this._hasVisualVariables=a,this._geometryTypes=[b.WGLGeometryType.FILL,b.WGLGeometryType.LINE,b.WGLGeometryType.MARKER,b.WGLGeometryType.TEXT],this._data=c,this.tileStatus=this.tileStatus===b.TileStatus.READY||this.tileStatus===b.TileStatus.NO_DATA||this.tileStatus===b.TileStatus.INVALID?b.TileStatus.MODIFIED:b.TileStatus.READY):(this.clear(),this.tileStatus=b.TileStatus.NO_DATA)};a.prototype.patchData=function(c){this._data&&(this.tileStatus=
b.TileStatus.MODIFIED,this._patchData(c)||(this._data.reshuffle(),this._dispRecStore=p.default.fromTileData(this._data)),this.requestRender())};a.prototype.commitChanges=function(c){this._data&&this.tileStatus===b.TileStatus.MODIFIED&&(this._wglBuffers&&(35048!==this._wglBuffers.usage&&(this._wglBuffers.dispose(),this._wglBuffers=new q.default(35048)),this._wglBuffers.ensureBuffers(c.context,this._geometryTypes,this._hasVisualVariables),this._wglBuffers.upload(this._data.tileBufferData,this._geometryTypes,
["geometry","visibility"],!0)),this.tileStatus=b.TileStatus.READY)};a.prototype.setVisibility=function(c){if(this._data){m.clear();for(var a=0;a<c.length;a++){var d=c[a],b=this._data.tileDisplayData.displayObjectRegistry.get(d.id);if(b)for(var f=0,b=b.displayRecords;f<b.length;f++){var e=b[f];m.add(e.geometryType);var g=this._data.tileBufferData.geometries[e.geometryType];if(g.vertexBuffer.visibility)for(var g=g.vertexBuffer.visibility,h=0;h<e.vertexCount;++h)g.data[(e.vertexFrom+h)*g.stride/4]=d.visibility?
4294967295:0}}if(this._wglBuffers){var l=[];m.forEach(function(c){l.push(c)});this._wglBuffers.upload(this._data.tileBufferData,l,["visibility"],!1);this.requestRender()}}};a.prototype.clear=function(){this._data=null;this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null);this.hlDisplayList&&(this.hlDisplayList=null)};a.prototype.dispose=function(){this.clear()};a.prototype.attach=function(c){if(this.attached||this.tileStatus===b.TileStatus.INVALID)return!0;if(this.tileStatus===b.TileStatus.INITIALIZED)return!1;
this._wglBuffers||(this._wglBuffers=new q.default(35044));this._data&&(this._wglBuffers.ensureBuffers(c.context,this._geometryTypes,this._hasVisualVariables),this._wglBuffers.upload(this._data.tileBufferData,this._geometryTypes,["geometry","visibility"],!0));return!0};a.prototype.detach=function(c){k.prototype.detach.call(this,c)};a.prototype.doRender=function(c){var a=this;this.commitChanges(c);c.context.setStencilTestEnabled(!0);c.context.setStencilFunction(514,this.stencilRef,255);c.painter.getBrushes(c.drawPhase).forEach(function(d){return d.draw(c,
a)})};a.prototype.buildHLList=function(c){var a=this;this.hlDisplayList=new x;c.forEach(function(c){a._addToHLDisplayList(a.hlDisplayList,c)})};a.prototype._addToHLDisplayList=function(c,a){if(this._data){var d=this._data.tileDisplayData.displayObjectRegistry.get(a);if(d){a=[];for(var b=0,d=d.displayRecords;b<d.length;b++){var f=d[b],e=new r;e.id=f.id;e.geometryType=f.geometryType;e.vertexFrom=f.vertexFrom;e.vertexCount=f.vertexCount;e.indexFrom=f.indexFrom;e.indexCount=f.indexCount;e.materialInfo=
f.materialInfo;e.meshData=null;e.symbolLevel=0;e.zOrder=0;a.push(e)}a.sort(A);c.addToList(a)}}};a.prototype._patchData=function(a){for(var c=!0,d=0,b=a.remove||[];d<b.length;d++){var f=b[d],e=this._data.tileDisplayData.displayObjectRegistry.get(f);if(e){this._data.tileDisplayData.displayList.removeFromList(e.displayRecords);m.clear();for(var g=0,e=e.displayRecords;g<e.length;g++){var h=e[g];m.add(h.geometryType);this._dispRecStore.delete(h)}this._data.tileDisplayData.displayObjectRegistry.delete(f)}}var l=
[];a.addOrUpdate.tileDisplayData.displayObjectRegistry.forEach(function(a){l.push(a)});for(d=0;d<l.length;d++){b=l[d];if(e=this._data.tileDisplayData.displayObjectRegistry.get(b.id)){for(f=0;f<e.displayRecords.length;++f)if(g=e.displayRecords[f],h=b.displayRecords[f],f>=b.displayRecords.length||g.geometryType!==h.geometryType||g.symbolLevel!==h.symbolLevel||g.zOrder!==h.zOrder||g.materialInfo.materialKey!==h.materialInfo.materialKey)this._dispRecStore.delete(e.displayRecords[f]),f<b.displayRecords.length&&
(e.displayRecords[f]=void 0);e.displayRecords.length=b.displayRecords.length}else e=new y(b.id),this._data.tileDisplayData.displayObjectRegistry.set(b.id,e);for(f=0;f<b.displayRecords.length;++f){var h=b.displayRecords[f],g=e.displayRecords[f],k=h.geometryType;h.readMeshDataFromBuffers(a.addOrUpdate.tileBufferData.geometries[k].vertexBuffer,a.addOrUpdate.tileBufferData.geometries[k].indexBuffer);if(g)g.meshData=h.meshData,g.materialInfo=h.materialInfo;else{var g=new r,n;for(n in h)g[n]=h[n];g.vertexFrom=
void 0;g.indexFrom=void 0;e.displayRecords[f]=g}c=c&&this._dispRecStore.commit(g)}}return c};return a}(w)});