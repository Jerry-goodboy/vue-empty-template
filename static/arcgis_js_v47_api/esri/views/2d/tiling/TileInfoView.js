// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(x,y,u,v,m,q){var w=function(){function d(b,a,c,f,p,g,r,e){this.x=b;this.ymin=a;this.ymax=c;this.invM=f;this.leftAdjust=p;this.rightAdjust=g;this.leftBound=r;this.rightBound=e}d.create=function(b,a){b[1]>a[1]&&(e=[a,b],b=e[0],a=e[1]);e=b[0];b=b[1];var c=a[0];a=a[1];var f=c-e,p=a-b,p=0!==p?f/p:0,g=(Math.ceil(b)-b)*p,r=(Math.floor(b)-b)*p;return new d(e,Math.floor(b),Math.ceil(a),p,0>f?g:r,0>f?r:g,0>f?c:e,0>f?
e:c);var e};d.prototype.incrRow=function(){this.x+=this.invM};d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return d}(),h=[[0,0],[0,0],[0,0],[0,0]];return function(){function d(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel={};var f=b.lods.slice();f.sort(function(a,b){return b.scale-a.scale});
var p=this._lodInfos=f.map(function(c){return u.create(b,c,a)});f.forEach(function(a,b){c._infoByLevel[a.level]=p[b];c._infoByScale[a.scale]=p[b];c.scales[b]=a.scale},this);this._wrap=b.isWrappable}d.prototype.getTileBounds=function(b,a){var c=this._infoByLevel[a.level];return c?c.getTileBounds(b,a):b};d.prototype.getTileCoords=function(b,a){var c=this._infoByLevel[a.level];return c?c.getTileCoords(b,a):b};d.prototype.getTileCoverage=function(b,a){void 0===a&&(a=192);var c=this.getClosestInfoForScale(b.scale),
f=v.pool.acquire(c),p=this._wrap,g;g=Infinity;var d=-Infinity,e,n,m=f.spans;h[0][0]=h[0][1]=h[1][1]=h[3][0]=-a;h[1][0]=h[2][0]=b.size[0]+a;h[2][1]=h[3][1]=b.size[1]+a;for(a=0;a<h.length;a++){var k=h[a];b.toMap(k,k);k[0]=c.getColumnForX(k[0]);k[1]=c.getRowForY(k[1])}b=[];k=3;for(a=0;4>a;a++){if(h[a][1]!==h[k][1]){var l=w.create(h[a],h[k]);g=Math.min(l.ymin,g);d=Math.max(l.ymax,d);void 0===b[l.ymin]&&(b[l.ymin]=[]);b[l.ymin].push(l)}k=a}if(null==g||null==d||100<d-g)return null;for(k=[];g<d;){null!=
b[g]&&(k=k.concat(b[g]));e=Infinity;n=-Infinity;for(a=k.length-1;0<=a;a--)l=k[a],e=Math.min(e,l.getLeftCol()),n=Math.max(n,l.getRightCol());e=Math.floor(e);n=Math.floor(n);if(g>=c.first[1]&&g<=c.last[1])if(p)if(c.size[0]<c.worldSize[0])for(l=Math.floor(n/c.worldSize[0]),a=Math.floor(e/c.worldSize[0]);a<=l;a++)m.push(new q(g,Math.max(c.getFirstColumnForWorld(a),e),Math.min(c.getLastColumnForWorld(a),n)));else m.push(new q(g,e,n));else e>c.last[0]||n<c.first[0]||(e=Math.max(e,c.first[0]),n=Math.min(n,
c.last[0]),m.push(new q(g,e,n)));g+=1;for(a=k.length-1;0<=a;a--)l=k[a],l.ymax>=g?l.incrRow():k.splice(a,1)}return f};d.prototype.getTileIdAtParent=function(b,a){a=m.pool.acquire(a);var c=this._infoByLevel[a.level];if(b.resolution<c.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+b.resolution+" is not a parent resolution of "+c.resolution);return b.resolution===c.resolution?a.id:m.getId(b.level,Math.floor(a.row*c.resolution/b.resolution+.01),Math.floor(a.col*c.resolution/
b.resolution+.01),a.world)};d.prototype.getTileParentId=function(b){b=m.pool.acquire(b);var a=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;if(0>a)return m.pool.release(b),null;a=this.getTileIdAtParent(this._lodInfos[a],b);m.pool.release(b);return a};d.prototype.getTileResolution=function(b){return(b=this._infoByLevel[b.level])?b.resolution:-1};d.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1};d.prototype.intersects=function(b,a){var c=m.pool.acquire(a);
a=this._infoByLevel[c.level];var f=b.lodInfo;if(f.resolution>a.resolution){var d=m.pool.acquire(this.getTileIdAtParent(f,c)),g=f.denormalizeCol(d.col,d.world);a=b.spans.some(function(a){return a.row===d.row&&a.colFrom<=g&&a.colTo>=g});m.pool.release(c);m.pool.release(d);return a}if(f.resolution<a.resolution){var h=b.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]);
b=h[0];var e=h[1],n=h[2],h=h[3],t=a.denormalizeCol(c.col,c.world),k=f.getColumnForX(a.getXForColumn(t)),l=f.getRowForY(a.getYForRow(c.row)),t=f.getColumnForX(a.getXForColumn(t+1))-1;a=f.getRowForY(a.getYForRow(c.row+1))-1;m.pool.release(c);return!(k>h||t<n||l>e||a<b)}var q=f.denormalizeCol(c.col,c.world);a=b.spans.some(function(a){return a.row===c.row&&a.colFrom<=q&&a.colTo>=q});m.pool.release(c);return a};d.prototype.getClosestInfoForScale=function(b){var a=this.scales;this._infoByScale[b]||(b=a.reduce(function(a,
d,h,g){return Math.abs(d-b)<Math.abs(a-b)?d:a},a[0]));return this._infoByScale[b]};return d}()});