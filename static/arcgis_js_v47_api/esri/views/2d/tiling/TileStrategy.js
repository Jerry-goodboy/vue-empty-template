// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/tsSupport/extendsHelper","./TileKey"],function(y,z,A,m){var h=new m(0,0,0,0),f=new Map,g=[],k=[];return function(){function c(a){this._previousResolution=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.tileIndex=new Map;this.tiles=[];this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;a.cachePolicy&&(this.cachePolicy=a.cachePolicy)}c.prototype.destroy=function(){this.tileIndex.clear()};c.prototype.update=function(a){var n=
this,b=this.tileIndex,c=this.tileInfoView.getTileCoverage(a.state);if(c){var e=c.spans,p=c.lodInfo,q=p.level,d=a.state.resolution,r=!a.stationary&&d>this._previousResolution;this._previousResolution=d;b.forEach(function(a){return a.visible=!0});this.tiles.length=0;f.clear();var u=0,v=0;if(0<e.length)for(var t=0;t<e.length;t++){a=e[t];for(var m=a.row,w=a.colTo,l=a.colFrom;l<=w;l++)u++,a=h.set(q,m,p.normalizeCol(l),p.getWorldForColumn(l)).id,b.has(a)?(d=b.get(a),d.attached?(f.set(a,d),v++):d.attached||
r||this._addParentTile(a,f)):(d=this.acquireTile(h),this.tileIndex.set(a,d),r||this._addParentTile(a,f))}var x=v===u;k.length=0;g.length=0;b.forEach(function(a,b){h.set(b);if(!f.has(b)){var d=n.tileInfoView.intersects(c,h);!d||!r&&x?"purge"===n.cachePolicy?g.push(b):(h.level>q||!d)&&g.push(b):a.attached?k.push(b):h.level>q&&g.push(b)}});for(e=0;e<k.length;e++)a=k[e],(d=b.get(a))&&d.attached&&f.set(a,d);for(e=0;e<g.length;e++)a=g[e],d=b.get(a),this.releaseTile(d),b["delete"](a);f.forEach(function(a){return n.tiles.push(a)});
b.forEach(function(a){f.has(a.key.id)||(a.visible=!1)});k.length=0;g.length=0;f.clear()}};c.prototype.clear=function(){var a=this,c=this.tileIndex;c.forEach(function(b){a.releaseTile(b)});c.clear()};c.prototype._addParentTile=function(a,c){for(var b=null;;){a=this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)&&(b=this.tileIndex.get(a))&&b.attached){c.has(b.key.id)||c.set(b.key.id,b);break}}};return c}()});