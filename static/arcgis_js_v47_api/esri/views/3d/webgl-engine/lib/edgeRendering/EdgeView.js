// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/arrayUtils ../../../lib/glMatrix ../../../support/meshProcessing ../../../support/buffer/BufferView ../../../support/buffer/InterleavedLayout ../../../support/buffer/typedArrayUtil ../localOriginHelper ../LocalOriginManager ../PreinterleavedGeometryData ../RegularGridLocalOriginFactory ../Util ../TextureBackedBuffer/BufferManager ./EdgeRenderer ./RibbonEdgeRenderer ./strokes".split(" "),function(x,y,t,C,m,z,A,D,
E,F,G,B,H,I,J,K,r,L){Object.defineProperty(y,"__esModule",{value:!0});x=function(){function d(a,b){this.rctx=a;this.programRepository=b;this.debugSettings={antialiasing:!0,receiveShadows:!0};this.profilingCallback=null;this.gpuMemoryUsage=0;this.geometries=new Map;this.renderers=new Map;this.localOrigins=new G.LocalOriginManager(new H(1E4));this.tmpModelPosition=m.vec3d.create();this.tmpCameraPosition=m.vec3d.create();this.componentColorManager=new J.BufferManager(this.rctx)}d.isSupported=function(a){return!!a.capabilities.instancing};
d.prototype.computeModelTransformWithLocalOrigin=function(a,b,c){a.getCombinedStaticTransformation(b,c);b.origin?this.localOrigins.register(b.origin):(a=m.vec3d.set3(c[12],c[13],c[14],this.tmpModelPosition),b.origin=this.localOrigins.aquire(a));F.applyToModelMatrix(b.origin.vec3,c);return c};d.prototype.selectIndexData=function(a,b){if(b){b=E.slice(b);for(var c=0;c<b.length;c++)b[c]=a[b[c]];return b}return a};d.prototype.assignPerComponentAttributes=function(a,b,c,e){for(var k=[],g=this.componentColorManager.getBuffer(b.length),
f=!1,v=null,d=null,l=null,h=0;h<b.length;h++){var p=b[h],m=p.color,r=255*m[0],q=255*m[1],u=255*m[2],t=255*m[3],m=g.aquireIndex();k.push({index:m,material:p});g.textureBuffer.setData(m,r,q,u,t);q=c[h];r=c[h+1];null!=v&&v!==p.size&&(f=!0);null!=l&&l!==p.extensionLength&&(f=!0);null!=d&&d!==p.type&&(f=!0);v=p.size;d=p.type;l=p.extensionLength;p=void 0;switch(d){case "solid":p=0;break;case "sketch":p=1}if(e)for(;q<r;q++)u=e[q],a.colorIndexBuffer.set(u,m),a.lineWidthBuffer.set(u,v),a.extensionsBuffer.set(u,
l),a.typeBuffer.set(u,p);else for(;q<r;q++)a.colorIndexBuffer.set(q,m),a.lineWidthBuffer.set(q,v),a.extensionsBuffer.set(q,l),a.typeBuffer.set(q,p)}return{components:k,componentColorBuffer:g,requiresUberRenderer:f}};d.prototype.extractEdgeInformation=function(a,b){a=z.deduplicate(a.buffer,a.stride/4);b=this.selectIndexData(a.indices,b);var c=z.computeNeighbors(b,a.uniqueCount);return{faces:b,neighbors:c,vertices:w.createView(a.buffer)}};d.prototype.addGeometryNonPreinterleaved=function(a,b,c,e,k){var g=
c.getAttribute("position"),f=this.computeModelTransformWithLocalOrigin(a,e,m.mat4d.create());e=e.origin;c={position:g,indices:c.getIndices("position"),modelTransform:f,origin:e};a=this.addNonPreinterleaved(a,c,k);this.geometries.set(b,a)};d.prototype.addNonPreinterleaved=function(a,b,c){for(var e=b.position,k=e.data.length/e.strideIdx,g=new A.BufferViewVec3f64((new Float64Array(3*k)).buffer),f=0;f<k;f++)g.set(f,0,e.data[e.offsetIdx+f*e.strideIdx+0]),g.set(f,1,e.data[e.offsetIdx+f*e.strideIdx+1]),
g.set(f,2,e.data[e.offsetIdx+f*e.strideIdx+2]);e=w.createBuffer(g.count);for(f=0;f<g.count;f++)e.position.set(f,0,g.get(f,0)),e.position.set(f,1,g.get(f,1)),e.position.set(f,2,g.get(f,2));var f=this.assignPerComponentAttributes({colorIndexBuffer:e.componentIndex,lineWidthBuffer:e.lineWidth,typeBuffer:e.type,extensionsBuffer:e.extensions},[c],[0,e.componentIndex.count]),g=f.components,f=f.componentColorBuffer,k=this.extractEdgeInformation(e,b.indices),d={modelTransform:b.modelTransform,origin:b.origin,
componentBuffer:f};b=this.getRendererInfo(c);e=b.renderer;c=e.createInstance(d,k,c);a={renderInstance:c,object:a,visible:!0,components:g,componentColorBuffer:f,distanceToCamera:0};this.gpuMemoryUsage+=c.gpuMemoryUsage;b.objects.add(a);return{objectData:a,renderer:e}};d.prototype.addGeometryPreinterleaved=function(a,b,c,e,k){var g=c.getAttribute("position");if(g&&g.data instanceof Float32Array){for(var f=this.computeModelTransformWithLocalOrigin(a,e,m.mat4d.create()),d=e.origin,n=c.getIndices("position"),
g=new A.BufferViewVec3f(g.data.buffer,4*g.offsetIdx,4*g.strideIdx),l=w.createBuffer(g.count),h=0;h<g.count;h++)l.position.set(h,0,g.get(h,0)),l.position.set(h,1,g.get(h,1)),l.position.set(h,2,g.get(h,2));h=this.assignPerComponentAttributes({colorIndexBuffer:l.componentIndex,lineWidthBuffer:l.lineWidth,extensionsBuffer:l.extensions,typeBuffer:l.type},k,c.componentOffsets,n);c=h.components;g=h.componentColorBuffer;h=h.requiresUberRenderer;n=this.extractEdgeInformation(l,n);f={modelTransform:f,origin:d,
componentBuffer:g};l=h?null:k[0];k=this.getRendererInfo(l);d=k.renderer;f=d.createInstance(f,n,l);a={renderInstance:f,object:a,visible:!a.isHidden(e),components:c,componentColorBuffer:g,distanceToCamera:0};this.gpuMemoryUsage+=f.gpuMemoryUsage;this.geometries.set(b,{renderer:d,objectData:a});k.objects.add(a)}else console.warn("Geometry has no float32 `position` attribute, skipping it.")};d.prototype.addObject=function(a,b,c){if(c&&c.mergeGeometries&&1<a.geometries.length)this.addObjectMergedGeometries(a,
b);else for(c=0;c<a.geometries.length;c++){var e=a.geometries[c],k=a.geometryRecords[c];k.materials[0].supportsEdges&&(e.data instanceof B?this.addGeometryPreinterleaved(a,e,e.data,k,b):this.addGeometryNonPreinterleaved(a,e,e.data,k,b[0]))}};d.prototype.addObjectMergedGeometries=function(a,b){for(var c=new Map,e=0,k=null,g=null,f=null,d=0;d<a.geometries.length;d++){var n=a.geometries[d],l=a.geometryRecords[d],h=l.materials[0];if(h.supportsEdges){if(n.data instanceof B)return console.error("Cannot merge geometries with pre interleaved geometry data"),
this.addObject(a,b);if(!g)g=l.transformation;else if(!I.arraysEqual(g,l.transformation))return console.error("Cannot merge geometries with differing geometry transforms"),this.addObject(a,b);if(!f&&l.origin)f=l;else if(f&&l.origin&&f.origin.id!==l.origin.id)return console.error("Cannot merge geometries with differing origins"),this.addObject(a,b);n=n.data.getIndices("position");e+=n?n.length:0;if(n&&null==k||k===Uint16Array)k=n instanceof Uint16Array?Uint16Array:Uint32Array}}e=e?new k(e):null;k=[];
for(d=g=0;d<a.geometries.length;d++)if(n=a.geometries[d],h=a.geometryRecords[d].materials[0],h.supportsEdges){h=n.data.getAttribute("position");n=n.data.getIndices("position");l=c.get(h.data);if(null==l){for(var l=k.length/3,p=h.offsetIdx;p<h.data.length;p+=h.strideIdx)k.push(h.data[p+0]),k.push(h.data[p+1]),k.push(h.data[p+2]);c.set(h.data,l)}if(n)for(h=0;h<n.length;h++)e[g++]=l+n[h]}d=f||a.geometryRecords[0];c=this.computeModelTransformWithLocalOrigin(a,d,m.mat4d.create());f=d.origin;for(d=0;d<
a.geometryRecords.length;d++)a.geometryRecords[d].origin=f;b=this.addNonPreinterleaved(a,{position:{data:k,offsetIdx:0,strideIdx:3},indices:e,modelTransform:c,origin:f},b[0]);this.geometries.set(a.geometries[0],b)};d.prototype.hasObject=function(a){return this.geometries.has(a.geometries[0])};d.prototype.updateComponentColor=function(a,b,c){for(var e=0;e<a.geometries.length;e++){var d=this.geometries.get(a.geometries[e]);if(!d)break;d=d.objectData;d.componentColorBuffer.textureBuffer.setData(d.components[b].index,
255*c[0],255*c[1],255*c[2],255*c[3])}};d.prototype.updateComponentOpacity=function(a,b,c){for(var e=0;e<a.geometries.length;e++){var d=this.geometries.get(a.geometries[e]);if(!d)break;d=d.objectData;d.componentColorBuffer.textureBuffer.setDataElement(d.components[b].index,3,255*c)}};d.prototype.updateObjectVisibility=function(a,b){for(var c=0;c<a.geometries.length;c++){var e=this.geometries.get(a.geometries[c]);if(!e)break;e.objectData.visible=b}};d.prototype.getComponentMaterial=function(a,b){if(a=
this.geometries.get(a.geometries[0]))return a.objectData.components[b].material};d.prototype.removeObject=function(a){for(var b=0;b<a.geometries.length;b++){var c=a.geometries[b],e=this.geometries.get(c);e&&(this.removeGeometry(e),this.geometries.delete(c))}};d.prototype.removeGeometry=function(a){var b=a.objectData,c=this.renderers.get(a.renderer.key);c.objects.delete(a.objectData);this.localOrigins.release(b.renderInstance.origin);a.renderer.disposeInstance(b.renderInstance);this.gpuMemoryUsage-=
b.renderInstance.gpuMemoryUsage;for(var e=0,d=b.components;e<d.length;e++)b.componentColorBuffer.releaseIndex(d[e].index);0===c.objects.size&&(this.renderers.delete(c.renderer.key),a.renderer.dispose())};d.prototype.removeAll=function(){var a=this;this.geometries.forEach(function(b){a.removeGeometry(b)});this.geometries.clear()};d.prototype.createSolidEdgeMaterial=function(a){return t({},M,a,{type:"solid"})};d.prototype.createSketchEdgeMaterial=function(a){return t({},N,a,{type:"sketch"})};d.prototype.estimateLengthAtDistance=
function(a,b,c){return c/a.fullWidth*b*2*Math.tan(.5*a.fovX)};d.prototype.render=function(a,b){var c=this;this.localOrigins.updateViewMatrices(b.view);this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var e=b.view,d=0;this.geometries.forEach(function(a){d+=a.objectData.renderInstance.averageEdgeLength});var g={distanceFalloffFactor:d/this.geometries.size*40,minimumEdgeLength:this.estimateLengthAtDistance(a,1,3.5)};(a=this.rctx.capabilities.blendMinMax)?(this.rctx.setDepthWriteEnabled(!1),
this.rctx.setBlendingEnabled(!0),this.rctx.setBlendEquationSeparate(32774,a.MAX),this.rctx.setBlendFunctionSeparate(1,0,1,1)):(this.rctx.setDepthWriteEnabled(!0),this.rctx.setBlendingEnabled(!1));this.rctx.setDepthTestEnabled(!0);this.rctx.setDepthFunction(515);this.updateObjectCameraDistances(b);this.renderers.forEach(function(a){var e=a.renderer;a=a.objects;e.begin(b);c.renderEdges(e,a,b,g);c.renderSilhouettes(e,a,b,g);e.end(b)});this.rctx.setDepthWriteEnabled(!0);this.rctx.setDepthFunction(513);
this.rctx.setBlendEquationSeparate(32774,32774);this.rctx.setBlendFunctionSeparate(1,0,1,1);b.view=e};Object.defineProperty(d.prototype,"compositingMode",{get:function(){return"alpha"},enumerable:!0,configurable:!0});d.prototype.updateObjectCameraDistances=function(a){var b=this;a=a.viewInvTransp;m.vec3d.set3(a[3],a[7],a[11],this.tmpCameraPosition);this.renderers.forEach(function(a){a.objects.forEach(function(a){a.distanceToCamera=m.vec3d.dist(a.object.getCenter(),b.tmpCameraPosition)})})};d.prototype.findLowerBoundIndex=
function(a,b){var c=C.binaryIndexOf(a,b,!0);return-1===c?b<a[0]?0:a.length:c};d.prototype.computeEdgeCount=function(a,b,c){return a.length-this.findLowerBoundIndex(a,b*c.minimumEdgeLength)};d.prototype.renderEdges=function(a,b,c,e){var d=this;a.bindEdges(c,e);b.forEach(function(b){if(b.visible){var f=d.computeEdgeCount(b.renderInstance.edgeLoD.lengths,b.distanceToCamera,e);c.view=d.localOrigins.getViewMatrix(b.renderInstance.origin);a.renderEdges(b.renderInstance,c,f)}})};d.prototype.renderSilhouettes=
function(a,b,c,d){var e=this;a.bindSilhouettes(c,d);b.forEach(function(b){if(b.visible){var f=e.computeEdgeCount(b.renderInstance.silhouetteLoD.lengths,b.distanceToCamera,d);c.view=e.localOrigins.getViewMatrix(b.renderInstance.origin);a.renderSilhouettes(b.renderInstance,c,f)}})};d.prototype.rendererClassCreator=function(a){var b=this.debugSettings,c=b.antialiasing,b=b.receiveShadows;this.strokesTexture||(this.strokesTexture=L.generateStrokesTexture(this.rctx));var d={antialiasing:c,receiveShadows:b,
strokesTexture:this.strokesTexture};return a?{create:function(a,b,c){return new r.default(a,b,c,t({},d,{uber:!1}))},key:r.default.getKey(a)}:{create:function(a,b,c){return new r.default(a,b,null,t({},d,{uber:!0}))},key:r.default.getKey(a)}};d.prototype.getRendererInfo=function(a){var b=this.rendererClassCreator(a),c=this.renderers.get(b.key);if(c)return c;a=b.create(this.rctx,this.programRepository,a);c=new Set;a={renderer:a,objects:c};this.renderers.set(b.key,a);return a};d.loadShaders=function(a,
b,c){K.default.loadShaders(a,b,c);r.default.loadShaders(a,b,c)};d.prototype.getGpuMemoryUsage=function(){return this.gpuMemoryUsage/1048576};return d}();y.EdgeView=x;var w=D.newLayout().vec3f("position").u16("componentIndex").u8("lineWidth").u8("type").i8("extensions").vec2u8("_padding",{glPadding:!0}).u8("_padding2",{glPadding:!0}),M={color:m.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0},N={color:m.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0}});