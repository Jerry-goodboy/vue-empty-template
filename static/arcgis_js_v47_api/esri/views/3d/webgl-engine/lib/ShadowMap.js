// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("./Camera ./Util ./gl-matrix ./glUtil3D ../../../../core/Logger ../../../webgl/Texture ../../../webgl/FramebufferObject ../../../webgl/VertexArrayObject ../../../webgl/BufferObject ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ../../../webgl/Util".split(" "),function(wa,m,t,xa,aa,ya,za,Aa,Ba,Ca,Da,ha){var b=t.vec2d,G=t.vec3d,ba=t.vec4d,Ea=t.mat3d,D=t.mat4d,ia=t.mat4,Fa=aa.getLogger("esri.views.3d.webgl-engine.lib.ShadowMap");return function(t,k){function u(a,b){G.set3(a[b],
a[b+3],a[b+6],ja);return ja}var H=k.gl,v,L=4096,U,ca=xa.createEmptyTexture(k),I=1,da=2,M=[0,0,0,0,0];this.dispose=function(){ca.dispose();ca=null};var e=function(){this.camera=new wa;this.lightMat=D.create()},X=[],n,f,w;for(n=0;4>n;++n)X[n]=new e;this.getIsSupported=function(){return k.capabilities.standardDerivatives};this.setTextureResolution=function(a){L=a};this.getTextureResolution=function(){return L};this.setMaxNumCascades=function(a){da=m.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return da};
this.setEnableState=function(a){a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==v};this.getDepthTexture=function(){return v};this.enable=function(){this.getEnableState()||(this.getIsSupported()?(v=new ya(k,{target:H.TEXTURE_2D,pixelFormat:H.RGBA,dataType:H.UNSIGNED_BYTE,wrapMode:H.CLAMP_TO_EDGE,samplingMode:H.NEAREST,flipped:!0,width:L,height:L}),U=za.createWithAttachments(k,v,{colorTarget:0,depthStencilTarget:1,width:L,height:L})):Fa.warn("Shadow maps are not supported for this browser or hardware"))};
this.disable=function(){this.getEnableState()&&U&&(U.dispose(),v=U=void 0)};var ka=D.create(),la=D.create(),ma=ba.create(),x=Array(8);for(n=0;8>n;++n)x[n]=ba.create();var J=G.create(),K=G.create(),na=b.create(),oa=b.create(),aa=b.create(),pa=b.create(),qa=b.create(),ra=D.create(),sa=G.create();this.prepare=function(z,R,e,r){m.assert(this.getEnableState());D.multiply(z.projectionMatrix,z.viewMatrix,ka);var c=r[0],p=r[1];2>c&&(c=2);2>p&&(p=2);c>=p&&(c=2,p=4);I=Math.min(1+Math.floor(m.logWithBase(p/
c,4)),da);e=Math.pow(p/c,1/I);for(r=0;r<I+1;++r)M[r]=c*Math.pow(e,r);D.inverse(ka,la);D.lookAt([0,0,0],[-R[0],-R[1],-R[2]],[0,1,0],ra);e=z.viewMatrix;z=z.projectionMatrix;for(r=0;r<I;++r){var y=X[r],c=-M[r],p=-M[r+1],c=(z[10]*c+z[14])/Math.abs(z[11]*c+z[15]),p=(z[10]*p+z[14])/Math.abs(z[11]*p+z[15]);m.assert(c<p);for(f=0;8>f;++f)for(ba.set4(0===f%4||3==f%4?-1:1,0===f%4||1==f%4?-1:1,4>f?c:p,1,ma),D.multiplyVec4(la,ma,x[f]),w=0;3>w;++w)x[f][w]/=x[f][3];G.negate(x[0],sa);D.translate(ra,sa,y.camera.viewMatrix);
for(f=0;8>f;++f)D.multiplyVec3(y.camera.viewMatrix,x[f]);G.set(x[0],J);G.set(x[0],K);for(f=1;8>f;++f)for(w=0;3>w;++w)J[w]=Math.min(J[w],x[f][w]),K[w]=Math.max(K[w],x[f][w]);J[2]-=200;K[2]+=200;y.camera.near=-K[2];y.camera.far=-J[2];c=1/x[0][3];p=1/x[4][3];m.assert(c<p);var h=c+Math.sqrt(c*p),l=Math.sin(Math.acos(e[2]*R[0]+e[6]*R[1]+e[10]*R[2])),h=h/l,c=x,t=h,n=l,l=na,A=oa,g=aa,E=pa,h=qa;b.set2(0,0,C);for(var d=void 0,d=0;4>d;++d)b.add(C,c[d],C);b.scale(C,.25);b.set2(0,0,V);for(d=4;8>d;++d)b.add(V,
c[d],V);b.scale(V,.25);b.lerp(c[4],c[5],.5,Q[0]);b.lerp(c[5],c[6],.5,Q[1]);b.lerp(c[6],c[7],.5,Q[2]);b.lerp(c[7],c[4],.5,Q[3]);for(var N=0,F=b.dist2(Q[0],C),d=1;4>d;++d){var v=b.dist2(Q[d],C);v<F&&(F=v,N=d)}b.subtract(Q[N],c[N+4],q);d=q[0];q[0]=-q[1];q[1]=d;b.subtract(V,C,ta);b.lerp(q,ta,n);b.normalize(q);N=n=void 0;n=N=b.dot(b.subtract(c[0],C,O),q);for(d=1;8>d;++d)F=b.dot(b.subtract(c[d],C,O),q),F<n?n=F:F>N&&(N=F);b.set(C,l);b.scale(q,n-t,O);b.add(l,O,l);for(var v=-1,ea=1,d=t=F=0;8>d;++d){b.subtract(c[d],
l,Y);b.normalize(Y);var W=q[0]*Y[1]-q[1]*Y[0];0<W?W>v&&(v=W,F=d):W<ea&&(ea=W,t=d)}m.verify(0<v,"leftArea");m.verify(0>ea,"rightArea");b.scale(q,n,S);b.add(S,C,S);b.scale(q,N,T);b.add(T,C,T);Z[0]=-q[1];Z[1]=q[0];A=m.rayRay2D(l,c[t],T,b.add(T,Z,O),1,A);g=m.rayRay2D(l,c[F],T,O,1,g);E=m.rayRay2D(l,c[F],S,b.add(S,Z,O),1,E);c=m.rayRay2D(l,c[t],S,O,1,h);m.verify(A,"rayRay");m.verify(g,"rayRay");m.verify(E,"rayRay");m.verify(c,"rayRay");g=na;c=oa;l=pa;E=qa;h=y.camera.projectionMatrix;b.scale(b.subtract(l,
E,B),.5);a[0]=B[0];a[1]=B[1];a[2]=0;a[3]=B[1];a[4]=-B[0];a[5]=0;a[6]=B[0]*B[0]+B[1]*B[1];a[7]=B[0]*B[1]-B[1]*B[0];a[8]=1;a[6]=-b.dot(u(a,0),g);a[7]=-b.dot(u(a,1),g);g=b.dot(u(a,0),l)+a[6];A=b.dot(u(a,1),l)+a[7];d=b.dot(u(a,0),E)+a[6];E=b.dot(u(a,1),E)+a[7];g=-(g+d)/(A+E);a[0]+=a[1]*g;a[3]+=a[4]*g;a[6]+=a[7]*g;g=1/(b.dot(u(a,0),l)+a[6]);A=1/(b.dot(u(a,1),l)+a[7]);a[0]*=g;a[3]*=g;a[6]*=g;a[1]*=A;a[4]*=A;a[7]*=A;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;g=b.dot(u(a,1),c)+a[7];A=b.dot(u(a,2),c)+a[8];d=b.dot(u(a,
1),l)+a[7];E=b.dot(u(a,2),l)+a[8];g=-.5*(g/A+d/E);a[1]+=a[2]*g;a[4]+=a[5]*g;a[7]+=a[8]*g;g=b.dot(u(a,1),c)+a[7];A=b.dot(u(a,2),c)+a[8];d=-A/g;a[1]*=d;a[4]*=d;a[7]*=d;h[0]=a[0];h[1]=a[1];h[2]=0;h[3]=a[2];h[4]=a[3];h[5]=a[4];h[6]=0;h[7]=a[5];h[8]=0;h[9]=0;h[10]=1;h[11]=0;h[12]=a[6];h[13]=a[7];h[14]=0;h[15]=a[8];y.camera.projectionMatrix[10]=2/(J[2]-K[2]);y.camera.projectionMatrix[14]=-(J[2]+K[2])/(J[2]-K[2]);D.multiply(y.camera.projectionMatrix,y.camera.viewMatrix,y.lightMat);c=L/2;y.camera.viewport[0]=
0===r%2?0:c;y.camera.viewport[1]=0===Math.floor(r/2)?0:c;y.camera.viewport[2]=c;y.camera.viewport[3]=c}P=void 0;M[I]=100*p;k.bindFramebuffer(U);k.bindTexture(null,7);k.setClearColor(1,1,1,1);k.clear(H.COLOR_BUFFER_BIT|H.DEPTH_BUFFER_BIT);k.setBlendingEnabled(!1)};var fa=[];this.getCascades=function(){for(var a=0;a<I;++a)fa[a]=X[a];fa.length=I;return fa};this.finish=function(a){m.assert(this.getEnableState());k.bindFramebuffer(a)};this.bind=function(a){var b=this.getEnableState();k.bindTexture(b?v:
ca,7);k.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",b?.5/L:-1);a.setUniform1i("shadowMapNum",I);a.setUniform4f("shadowMapDistance",M[0],M[1],M[2],M[3])};this.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};var ua=ia.create(),va=new Float32Array(64),P;this.bindView=function(a,b){if(this.getEnableState()){if(!P||P[0]!==b[0]||P[1]!==b[1]||P[2]!==b[2]){var e;P=P||G.create();G.set(b,P);for(f=0;f<I;++f)for(ia.translate(X[f].lightMat,
b,ua),e=0;16>e;++e)va[16*f+e]=ua[e]}a.setUniformMatrix4fv("shadowMapMatrix",va)}};e=new Float32Array(16);e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=256;e[5]=0;e[6]=1;e[7]=0;e[8]=0;e[9]=256;e[10]=0;e[11]=1;e[12]=256;e[13]=256;e[14]=1;e[15]=1;var ga=new Aa(k,Ca.Default3D,{geometry:Da.Pos2Tex},{geometry:Ba.createVertex(k,H.STATIC_DRAW,e)});this.drawDebugQuad=function(a){m.assert(this.getEnableState());var b=t.get("showDepth");k.setDepthTestEnabled(!1);k.bindProgram(b);b.setUniformMatrix4fv("proj",a);b.setUniform1i("depthTex",
0);k.bindTexture(v,0);k.bindVAO(ga);ha.assertCompatibleVertexAttributeLocations(ga,b);k.drawArrays(H.TRIANGLE_STRIP,0,ha.vertexCount(ga,"geometry"));k.setDepthTestEnabled(!0)};var C=b.create(),V=b.create(),Q=[b.create(),b.create(),b.create(),b.create()],q=b.create(),ta=b.create(),O=b.create(),Y=b.create(),S=b.create(),T=b.create(),Z=b.create(),ja=G.create(),B=b.create(),a=Ea.create()}});