// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/Logger","../layers/support/MemoryManagedLayerView","./Evented"],function(m,n,h,f,k){var l=h.getLogger("esri.views.3d.support.MemoryController");return function(){function b(a){this._view=a;this._minQuality=.1;this._memoryHWM=this._maxQuality=1;this._memoryLWM=.8;this._divideRate=1.5;this.events=new k.Evented;this._maxMemory=500;this._quality=1;this._memoryCached=this._memoryCommitted=this._memoryUsed=this._stableQuality=0;this.updating=!1}b.prototype.setMaxGpuMemory=
function(a){a&&0<a&&(this._maxMemory=a,this.setDirty())};b.prototype.getMemoryFactor=function(){return this._quality};b.prototype._updateQuality=function(a){a=Math.min(Math.max(a,this._minQuality),this._maxQuality);if(a===this._quality)return!1;this._quality=a;this.events.emit("quality-changed",this._quality);return!0};b.prototype.getUsedMemory=function(){return this._memoryUsed};b.prototype.setDirty=function(){this._stableQuality=0};b.prototype.update=function(){this._updateMemory();if(!(0>=this._memoryCommitted)){this._unloadSuspended();
var a=this._layersUpdating();if(a){if(this._quality<=this._minQuality)return;if(this._memoryCommitted>1.1*this._memoryHWM||this._memoryUsed>this._memoryHWM)0<this._stableQuality?this._updateQuality(this._stableQuality):this._updateQuality(this._quality/this._divideRate)}else{if(this._memoryCommitted>this._memoryHWM||this._memoryUsed>this._memoryHWM)this._stableQuality=0,a=this._updateQuality(this._quality/this._divideRate);this._memoryCommitted<this._memoryLWM&&this._quality<this._maxQuality&&this._stableQuality!==
this._quality&&(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.1*(this._memoryLWM-this._memoryCommitted+.1)))}this.updating!==a&&(this.updating=a,this.events.emit("updating-changed",this.updating))}};b.prototype._layersUpdating=function(){var a=!1;this._view.allLayerViews.forEach(function(b){a=a||b.updating});return a};b.prototype._unloadSuspended=function(){var a=this,b=function(){return 0===a._memoryCached?!1:a._memoryCommitted>1.1*a._memoryHWM||a._memoryUsed>a._memoryHWM||
a._memoryUsed>=a._memoryLWM&&.9>a._quality};if(b())for(var c=this._view.allLayerViews.toArray().filter(function(a){return a.suspended}),d=function(){var a=null,b=0;c.forEach(function(c){if(f.isMemoryManagedLayerView(c)){var e=c.getUsedMemory();e>b&&(b=e,a=c)}});if(!a)return{value:void 0};a.removeCachedData();c.splice(c.indexOf(a),1);e._updateMemory()},e=this;b()&&0<c.length;){var g=d();if("object"===typeof g)return g.value}};b.prototype._updateMemory=function(){var a=0,b=0,c=0;this._view.basemapTerrain&&
this._view.basemapTerrain.getUsedMemory&&(a+=this._view.basemapTerrain.getUsedMemory());var d=this._view._stage&&this._view._stage.view&&this._view._stage.view.getEdgeView();d&&(a+=d.getGpuMemoryUsage());this._view.allLayerViews&&this._view.allLayerViews.forEach(function(e){if(f.isMemoryManagedLayerView(e)){var d=e.getUsedMemory();a+=d;e.suspended&&(c+=d);b+=e.getUnloadedMemory()}});a>this._maxMemory&&a!==this._warnMemoryUsage&&(this._warnMemoryUsage=a,d=function(a){return a.toLocaleString(void 0,
{maximumFractionDigits:1})+" Mb"},l.warn("GPU Memory Limit exceeded! Limit: "+d(this._maxMemory)+" Current: "+d(a)+" Projected: "+d(a+b)));this._memoryUsed=a/this._maxMemory;this._memoryCommitted=(a+b-c)/this._maxMemory;this._memoryCached=c/this._maxMemory};return b}()});