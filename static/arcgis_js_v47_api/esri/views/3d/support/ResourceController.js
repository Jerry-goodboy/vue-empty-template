// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("../../../core/declare ../../../core/Handles ../../../core/Logger ../../../core/scheduling ./MemoryController ./StreamDataSupplier ./StreamDataLoader ./PreallocArray ../webgl-engine/lib/Performance ../webgl-engine/lib/Util".split(" "),function(k,n,p,q,r,t,u,v,w,x){function f(a){this.budget=this.begin=0;this.performance=a;this.enabled=!0}var l=x.assert,g={TERRAIN:"terrain",SCENE:"scene",SYMBOLOGY:"symbols"},h=new v(20),y=p.getLogger("esri.views.support.ResourceController");f.prototype.now=function(){return this.performance.now()};
f.prototype.reset=function(a){this.begin=this.now();this.budget=this.enabled?a:Number.MAX_VALUE};f.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget};f.prototype.remaining=function(){return Math.max(this.budget-this.elapsed(),0)};f.prototype.elapsed=function(){return this.now()-this.begin};k=k(null,{constructor:function(a,b,c){c=c||w;this._clients=[];this._frameWorkers=[];this._nextFrameWorker=0;this._budget=new f(c);this._idleFrameWorkers=[];this._idleFrameWorkerRobin=0;
this._idleUpdatesStartFired=!1;this._lastTargetChangeTime=c.now();this._memoryController=new r(a);this.navigationTimeout=300;this.animatingFrameTimeBudget=10;this.idleFrameWorkerBudget=30;this.idleFrameTimeBudget=50;c={};for(var e in g)c[g[e]]=0;c[g.TERRAIN]=15;c[g.SCENE]=20;c[g.SYMBOLOGY]=5;this.streamDataLoader=new u(c);this._cameraListeners=new n;this._cameraListeners.add([a.watch("state.camera",this._cameraChangedHandler.bind(this),!0)]);b||(b=q);this._frameTask=b.addFrameTask({update:this._frameUpdate.bind(this)});
this._view=a;this.stats={frameUpdateTime:new m,idleUpdateTime:new m};this.frameUpdateNavigation=null},destroy:function(){this._frameTask.remove();this._frameTask=null;this._cameraListeners.remove();this.streamDataLoader.destroy();this.streamDataLoader=null},setEnableBudget:function(a){this._budget.enabled=!!a},isUpdating:function(){return this._memoryController.updating},registerClient:function(a,b,c){this._clients.push({client:a,type:b});this._memoryController.setDirty();return new t(b,this.streamDataLoader,
c)},deregisterClient:function(a){for(var b=0;b<this._clients.length;b++)if(this._clients[b].client===a){this._clients[b]=this._clients[this._clients.length-1];this._clients.pop();this._memoryController.setDirty();return}console.warn("deregistering an unregistered client.")},setMaxGpuMemory:function(a){this._memoryController.setMaxGpuMemory(a)},setMemoryDirty:function(){this._memoryController.setDirty()},getMemoryFactor:function(){return this._memoryController.getMemoryFactor()},getUsedMemory:function(){return this._memoryController.getUsedMemory()},
getMemoryEvents:function(){return this._memoryController.events},registerIdleFrameWorker:function(a,b){var c=this._idleFrameWorkers.some(function(b){return b.client===a});l(!c,"Can only register idle frame workers once per client/layer");l(!b.idleFrame||b.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");this._idleFrameWorkers.push({client:a,callbacks:b});this._isIdle()&&this._idleUpdatesStartFired&&b.idleBegin&&b.idleBegin.call(a)},deregisterIdleFrameWorker:function(a){for(var b=
this._idleFrameWorkers,c=0;c<b.length;c++){var e=b[c];if(e.client===a){this._idleUpdatesStartFired&&e.callbacks.idleEnd&&e.callbacks.idleEnd.call(a);b[c]=b[b.length-1];b.pop();break}}},registerFrameWorker:function(a){-1===this._frameWorkers.indexOf(a)&&this._frameWorkers.push(a)},deregisterFrameWorker:function(a){-1===this._frameWorkers.indexOf(a)?y.warn("Can't deregister unknown frame handler"):(this._frameWorkers.splice(this._frameWorkers.indexOf(a),1),this._nextFrameWorker=0)},_cameraChangedHandler:function(){this._lastTargetChangeTime=
this._budget.now();this._memoryController.setDirty();this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._callWorkersNoScheduling("idleEnd"))},_frameUpdate:function(a){var b=this._isIdle()?this.idleFrameWorkerBudget:this.animatingFrameTimeBudget;this._budget.reset(b-a.elapsedFrameTime);this._view.stateManager&&this._view.stateManager.step(a.deltaTime/1E3);this._view.inputManager&&this._view.inputManager._pinchNavigation&&this._view.inputManager._pinchNavigation.momentum.doFrameUpdate(a.deltaTime);
this._memoryController.update();for(a=0;a<this._frameWorkers.length;++a)if(b=(this._nextFrameWorker+a)%this._frameWorkers.length,this._frameWorkers[b](this._budget),3>this._budget.remaining()){this._nextFrameWorker=(b+1)%this._frameWorkers.length;break}this.stats.frameUpdateTime.addSample(this._budget.elapsed());this._isIdle()&&(this._idleUpdatesStartFired||(this._callWorkersNoScheduling("idleBegin"),this._idleUpdatesStartFired=!0),this._budget.reset(this.idleFrameTimeBudget-this._budget.elapsed()),
3<this._budget.remaining()&&(this._callWorkersStrictScheduling("idleFrame",this._budget),this.stats.idleUpdateTime.addSample(this._budget.elapsed())))},_isIdle:function(){return this._budget.now()-this._lastTargetChangeTime>this.navigationTimeout},_callWorkersNoScheduling:function(a){for(var b=this._idleFrameWorkers,c=0;c<b.length;c++){var e=b[c];e.callbacks[a]&&e.callbacks[a].call(e.client)}},_callWorkersStrictScheduling:function(a,b){var c=this._idleFrameWorkers,e=c.length,d,f,g;h.clear();f=0;for(g=
this._idleFrameWorkerRobin;f<e;f++)d=c[g++%e],d.callbacks.needsUpdate&&d.callbacks.needsUpdate.call(d.client)&&(0===h.length&&(this._idleFrameWorkerRobin=g),h.push(d));d=b.now();for(c=d+b.remaining();0<h.length&&d<c;)b.reset((c-d)/h.length),d=h.pop(),d.callbacks[a].call(d.client,b),d=b.now()}});k.ClientType=g;var m=function(){this.addSample=function(a){this.min=Math.min(this.min,a);this.max=Math.max(this.max,a);this.total+=a;this.numSamples++};this.getAverage=function(){return this.total/this.numSamples};
this.reset=function(){this.numSamples=this.total=0;this.min=Number.MAX_VALUE;this.max=-Number.MAX_VALUE};this.reset()};return k});