// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../geometry ../../../Graphic ../../../core/Collection ../../../core/Handles ../../../core/Logger ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/support/contains ../../../renderers/support/renderingInfoUtils ./LayerView3D ./graphics/Graphics3DLayerViewCore ./i3s/I3SQueryEngine ./i3s/I3SUtil ./support/LayerViewUpdatingPercentage ../lib/glMatrix ../support/aaBoundingBox ../support/PreallocArray ../support/projectionUtils".split(" "),
function(w,ba,L,r,M,I,N,O,P,C,Q,g,R,S,T,U,V,t,W,X,h,x,J){function Y(d,b){d.xmin-=b;d.ymin-=b;d.xmax+=b;d.ymax+=b;d.hasZ&&(d.zmin-=b,d.zmax+=b);d.hasM&&(d.mmin-=b,d.mmax+=b);return d}var D=P.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D");w=function(d){function b(a){a=d.call(this)||this;a._queryEngine=null;a.supportsHeightUnitConversion=!0;a._isUpdating=!1;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;a._nodesAddedToStage={};a.loadedGraphics=new N;a.supportsDraping=
!0;a._overlayUpdating=null;a._controllerCreated=!1;a._handles=new O;return a}L(b,d);b.prototype.initialize=function(){var a=this;t.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this._handles.add([Q.init(this.layer,"rangeInfos",function(c){return a._rangeInfosChanged(c)}),this.layer.watch("renderer",function(c,k){return a._rendererChange(c,k)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",
function(){return a._definitionExpressionChange()})]);this._layerViewCore=new U({owner:this,layer:this.layer,spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,verticalScaleEnabled:this.supportsHeightUnitConversion,highlightsEnabled:!0,updateSuspendResumeExtent:function(){return a._updateSuspendResumeExtent()},updateClippingExtent:function(c){return a._updateClippingExtent(c)},getGraphicsInExtent:function(c,k,b){return a._getGraphicsInExtent(c,
k,b)}});this.addResolvingPromise(this._layerViewCore.initialize());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);this._createController()};b.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null);this._controller&&(this._controller.destroy(),this._controller=null);this._nodesAddedToStage=this._intersectingGraphicIds=this._elevationUpdateNodes=null;this._handles&&(this._handles.destroy(),this._handles=null)};Object.defineProperty(b.prototype,
"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},enumerable:!0,configurable:!0});b.prototype.whenGraphicAttributes=function(a,c){var b=this;return t.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),c,function(){var c=b._findGraphicNodeAndIndex(a);return{node:c.node,indices:[c.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};b.prototype.getGraphicsFromStageObject=function(a,c){if(!this.loadedGraphics)return C.reject();
var b=a.getMetadata().graphicId;a=this.loadedGraphics.find(function(a){return a.uid===b});c=this._getObjectIdField();return a&&a.attributes&&a.attributes[c]?C.resolve(a):C.reject()};b.prototype.whenGraphicBounds=function(a,c){return this._layerViewCore.graphicsCore.whenGraphicBounds(a,c)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this._isUpdating||!this._controllerCreated?!0:!(!this._controller||
!this._controller.updating)};b.prototype.getRenderingInfo=function(a){if((a=S.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var c=a.color;c[0]/=255;c[1]/=255;c[2]/=255}return a};b.prototype.getSymbolUpdateType=function(){return this._layerViewCore.graphicsCore.getSymbolUpdateType()};b.prototype._findGraphicNodeAndIndex=function(a){a=a.attributes[this.layer.objectIdField];for(var c=0,b=Object.keys(this._nodesAddedToStage);c<b.length;c++)for(var e=b[c],u=this._nodesAddedToStage[e].bundles,
f=0;f<u.length;f++){var m=this._findGraphicIndex(u[f],a);if(0<=m)return{node:this._controller.nodeIndex[e],nodeId:e,bundleNr:f,index:m}}return null};b.prototype._forAllFeatures=function(a,c){for(var b=0,e=Object.keys(this._nodesAddedToStage);b<e.length;b++)for(var u=e[b],f=this._nodesAddedToStage[u].bundles,m=0;m<f.length;m++){for(var d=f[m],n=0;n<d.length;n++)for(var y=d[n].graphics,E=0;E<y.length;E++){var h=y[E],g=d[n].featureIds[E];h.visible&&a(g,n,h)}null!=c&&c({nodeId:u,bundleNr:m})}};b.prototype._getGraphicIndices=
function(a,c,b){a=this._nodesAddedToStage[a].bundles[c];c=this._getObjectIdField();for(var e=[],k=0;k<b.length;k++){var f=this._findGraphicIndex(a,b[k].attributes[c]);0<=f&&e.push(f)}return e};b.prototype._findGraphicIndex=function(a,c){for(var b=0;b<a.length;b++)for(var e=0,u=a[b].featureIds;e<u.length;e++)if(u[e]===c)return b;return-1};b.prototype._getGraphicsInExtent=function(a,c,b){h[2]=-Infinity;h[3]=Infinity;var e=h.fromRect(Z,a);null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=
new x(10));a=this._elevationUpdateNodes;a.clear();this._controller&&this._controller.updateElevationChanged(e,c,a);c=a.length;this._intersectingGraphicIds||(this._intersectingGraphicIds=new x(10));e=this._intersectingGraphicIds;e.clear();for(var k=0;k<c;k++){var f=this._nodesAddedToStage[a.data[k].id];if(null!=f)for(var f=f.bundles,d=0;d<f.length;d++)for(var K=f[d],n=0;n<K.length;n++)for(var y=K[n].graphics,g=0;g<y.length;g++)e.push(y[g].uid)}b(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)};
b.prototype._evaluateUpdatingState=function(){var a=!1;if(this._layerViewCore.elevationAlignment)var a=0+this._layerViewCore.elevationAlignment.numNodesUpdating(),a=a+this._layerViewCore.graphicsCore.numNodesUpdating(),c=!this._controllerCreated||this._overlayUpdating||this._layerViewCore.graphicsCore.needsIdleUpdate(),a=0<a||c;this._isUpdating!==a&&(this._isUpdating=a,this.notifyChange("updating"))};b.prototype._notifySuspendedChange=function(){};b.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped");
this.emit("draped-data-change")};b.prototype.highlight=function(a,c){return this._layerViewCore.highlight(a,c,this.layer.objectIdField)};b.prototype._createController=function(){var a=this;this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addBundle:function(c,b){return a._addBundle(c,b)},isBundleLoaded:function(c){return a._isBundleLoaded(c)},getMemoryUsage:function(){return a.view.resourceController.getUsedMemory()},removeNodeData:function(c){return a._removeNodeData(c)},
getAddedNodeIDs:function(){return a._getAddedNodeIDs()}},layerViewOptionalFunctions:{traversalOptions:{errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"]},getLoadedAttributes:function(c){return a._getLoadedAttributes(c)},getAttributeData:function(c){return a._getAttributeData(c)},setAttributeData:function(c,b,e){return a._setAttributeData(c,b,e)}}}).then(function(c){a._controller=c;c.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=
!0;a._evaluateUpdatingState()})};b.prototype._addBundle=function(a,c){var b=c.allGeometryData,e=c.attributeDataInfo;c=[];var d=this._controller.crsIndex,f=this.view.spatialReference,m=[0,0,0],g=this._getObjectIdField();a.memory=0;null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]={bundles:[],attributeData:e?e.attributeData:null,loadedAttributes:e?e.loadedAttributes:null});this._nodesAddedToStage[a.id].bundles[0]=c;var n;if(this.layer.objectIdFilter){var h=this.layer.objectIdFilter.ids,
r="include"===this.layer.objectIdFilter.method;n=function(a){return 0<=h.indexOf(a)===r}}for(var e=this.layer.fullExtent&&Y(this.layer.fullExtent.clone(),.5),t=[],G=0;G<b.length;G++){var F=b[G],H=F.featureDataPosition,z=H.length,w=F.geometries||[aa[z]],x=F.featureIds;e&&!R.extentContainsCoords3D(e,H)&&D.error("Service Error: Coordinates outside of layer extent");for(var A=0;A<w.length;A++){var l=w[A],B=[],p=x[A<x.length?A:0],v={};if(null!=p){if(n&&!n(p))continue;v[g]=p}var q=l.params.type,p=void 0;
"Embedded"===l.type&&(p=l.params.vertexAttributes.position);if("lines"===q){q=[];for(l=0;l<p.length;l+=z)q.push([p[l]+a.mbs[0],p[l+1]+a.mbs[1]]);l=new M.Polyline(d);l.addPath(q);B.push(new I(l,null,v));a.memory+=16*p.length/1048576}else if("points"===q)for(l=0;l<p.length;l+=z){for(q=0;q<z;q++)m[q]=H[q]+p[l+q];q=J.vectorToPoint(m,d,f);3>z&&(q.z=void 0);B.push(new I(q,null,v));a.memory+=12*p.length/1048576}v=0;for(p=B;v<p.length;v++)l=p[v],l.layer=this.layer,l.sourceLayer=this.layer;t.push.apply(t,
B);c.push({featureIds:F.featureIds,graphics:B})}}this.loadedGraphics.addMany(t);a=this._nodesAddedToStage[a.id];this._setBundleAttributes(a.bundles[0],a.loadedAttributes,a.attributeData);this._filterNode(a);return C.resolve()};b.prototype._isBundleLoaded=function(a){return null!=this._nodesAddedToStage[a.id]&&null!=this._nodesAddedToStage[a.id].bundles[0]};b.prototype._removeNodeData=function(a){var c=this._nodesAddedToStage[a.id];if(null!=c){var c=c.bundles,b=[],e;for(e in c)for(var d in c[e])b.push.apply(b,
c[e][d].graphics);this.loadedGraphics.removeMany(b);delete this._nodesAddedToStage[a.id]}};b.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype._getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.loadedAttributes};b.prototype._getAttributeData=function(a){if(a=this._nodesAddedToStage[a.id])return a.attributeData};b.prototype._setAttributeData=function(a,c,b){if(a=this._nodesAddedToStage[a.id])a.loadedAttributes=c,a.attributeData=
b,this._setNodeAttributes(a,c,b),this._filterNode(a),this._layerViewCore.labeling.layerLabelsEnabled()&&this._layerViewCore.labeling.updateLabelingInfo()};b.prototype._setNodeAttributes=function(a,b,k){a=a.bundles;for(var c in a)this._setBundleAttributes(a[c],b,k)};b.prototype._setBundleAttributes=function(a,b,k){for(var c=0;c<a.length;c++)for(var d=0,f=a[c].graphics;d<f.length;d++){var m=f[d];m.attributes||(m.attributes={});if(b)for(var g=0,n=b;g<n.length;g++){var h=n[g].name;k[h]&&(m.attributes[h]=
t.getCachedAttributeValue(k[h],c))}}};b.prototype._updateSuspendResumeExtent=function(){this.layer.fullExtent?(this._suspendResumeExtent||(this._suspendResumeExtent=X.vec4d.create()),J.extentToBoundingRect(this.layer.fullExtent,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)):this._suspendResumeExtent=null;return this._suspendResumeExtent};b.prototype._updateClippingExtent=function(a){this._controller&&this._controller.updateClippingArea(a);return!1};b.prototype._getObjectIdField=
function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=function(a,b){var c=a?a.requiredFields:[],e=b?b.requiredFields:[];c.length===e.length&&c.every(function(a,b){return c[b]===e[b]})||this._reloadAllNodes()};b.prototype._rangeInfosChanged=function(a){null!=a&&0<a.length&&D.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};b.prototype._objectIdFilterChange=function(){this._reloadAllNodes()};b.prototype._reloadAllNodes=
function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){a._removeNodeData({id:b})});this._controller&&this._controller.restartNodeLoading()};b.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=0};b.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(k){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&D.error("Error while evaluating definitionExpression: "+k),this._definitionExpressionErrors++,
this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&D.error("Further errors are ignored"),!1}};b.prototype._filterNode=function(a){var b=this._controller.parsedDefinitionExpression,d;for(d in a.bundles)for(var e=0,g=a.bundles[d];e<g.length;e++)for(var f=0,m=g[e].graphics;f<m.length;f++){var h=m[f];h.visible=null!=b?this._evaluateClause(b,h):!0}};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};
b.prototype.queryFeatures=function(a){var b=this;return this._ensureQueryEngine().queryFeatures(a).then(function(a){for(var c=0,d=a.features;c<d.length;c++){var f=d[c];f.layer=b.layer;f.sourceLayer=b.layer}return a})};b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};b.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b={id:0,
index:0,graphic:null};return new V({forAll:function(c,e){a._forAllFeatures(function(a,e,d){b.id=a;b.index=e;b.graphic=d;c(b)},e)},createGraphic:function(a){return a.graphic.clone()},requestFields:function(b,c,d){return t.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),d,function(){var d=a._getGraphicIndices(b.nodeId,b.bundleNr,c);return{node:a._controller.nodeIndex[b.nodeId],indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var b=h.create(h.NEGATIVE_INFINITY),c=a.layer.spatialReference;
return{add:function(a){return h.expand(b,a.graphic.geometry)},getExtent:function(){return h.toExtent(b,c)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};b.prototype.getUsedMemory=function(){var a=this,b=0;Object.keys(this._nodesAddedToStage).forEach(function(c){b+=a._controller.nodeIndex[c].memory});return b};b.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};b.prototype.removeCachedData=function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){a._removeNodeData({id:b})})};
b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.nodecount=Object.keys(this._nodesAddedToStage).length;a.featurecount=this.loadedGraphics.length;return a};r([g.property()],b.prototype,"loadedGraphics",void 0);r([g.property()],b.prototype,"layer",void 0);r([g.property()],b.prototype,"hasDraped",null);r([g.property()],b.prototype,"_controller",void 0);r([g.property({dependsOn:["_controller.updating"]})],b.prototype,"updating",void 0);r([g.property({aliasOf:"_controller.updatingPercentage"})],
b.prototype,"updatingPercentageValue",void 0);return b=r([g.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],b)}(g.declared(T,W));var aa={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},Z=h.create(h.POSITIVE_INFINITY);return w});