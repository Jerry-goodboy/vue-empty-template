// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper dojo/has dojo/_base/lang dojo/errors/CancelError ../../../Graphic ../../../core/arrayUtils ../../../core/Collection ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../geometry/support/scaleUtils ../../../layers/IntegratedMeshLayer ../../../renderers/support/diffUtils ../../../symbols/FillSymbol3DLayer ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ../../../tasks/support/Query ./LayerView3D ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SQueryEngine ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/LayerViewUpdatingPercentage ../lib/glMatrix ../support/aaBoundingBox ../support/orientedBoundingBox ../support/projectionUtils ../webgl-engine/Stage ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/DefaultMaterial module".split(" "),
function(X,M,Y,v,Z,aa,ba,C,ca,da,ea,fa,D,ga,ha,x,ia,p,ja,N,ka,la,O,P,ma,na,oa,Q,pa,qa,ra,sa,t,ta,H,ua,va,F,y,wa,G,xa,ya,za,Aa,K,L,r,Ba,R,Ca){function Da(q,c,a,b,d){var e=!1,h;c.encoding===t.DDS_ENCODING_STRING?h=L.DDS_ENCODING:e=!(r.isPowerOfTwo(q.width)&&r.isPowerOfTwo(q.height));a=((q=c.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||c.atlas)?b:a)&&!e;return{mipmap:a,wrapClamp:q||!c.wrap,disableAnisotropy:q&&a&&d,encoding:h,noUnpackFlip:!0}}function S(q){return q.data instanceof
ArrayBuffer}function Ea(q,c){for(var a=1024,b=0;b<q.length;b++)var d=q[b],a=a+(d.interleavedVertexData.byteLength+(d.indices?d.indices.byteLength:0));for(q=0;q<c.length;q++)b=c[q],b.data instanceof ArrayBuffer&&(a+=b.data.byteLength);return a}var u=xa.ModelContentType,l=fa.getLogger("esri.views.3d.layers.SceneLayerView3D"),T=[1,1,1,1],Fa=[.8,.8,.8],Ga=[.5,.5,.5];M=function(q){function c(){var a=null!==q&&q.apply(this,arguments)||this;a._queryEngine=null;a._highlights=new pa(a);a._elevationProvider=
null;a._worker=new oa;a._workerThread=null;a._controllerCreated=!1;a._idbCache=new ta.IDBCache("esri-scenelayer-cache","geometries",8);a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.alwaysLoadEverythingModeEnabled=!1;a._cacheKeySuffix=null;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;return a}Y(c,q);Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererNeedsTextures",{get:function(){return t.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=ja.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=P.getMetersPerUnit(a.unit);return(a.offset||0)*d/b}return 0},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this._useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_useCompressedTextures",{get:function(){var a=this.layer.version,a=!Z("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.has("s3tc")&&a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",
{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps&&this.view._stage.has("standardDerivatives")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",
{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;ia.open(ga.getAbsMid("./SceneLayerWorker",X,Ca),{client:this}).then(function(b){a.destroyed?b.close():a._workerThread=b});t.checkSceneLayerValid(this.layer);t.checkSceneLayerCompatibleWithView(this.layer,this.view);this._initGraphicsController();this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._isIntegratedMesh()||
(this._edgeView=this._stage.view.getEdgeView());this._texId2Meta=new Map;this._nodeId2Meta=new Map;this._addThisLayerToStage();this._elevationProvider=new qa({layerView:this,stageLayer:this._stageLayer});this.handles.add([x.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),x.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),x.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),x.init(this.layer,"elevationInfo",function(){return a._elevationInfoChanged()}),
x.init(this.layer,"rangeInfos",function(b){return a._rangeInfosChanged(b)}),x.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),x.watch(this,"fullOpacity",function(b){return a._opacityChange(b)}),x.watch(this,["elevationOffset","rendererNeedsTextures"],function(){return a._reloadAll()}),x.watch(this,"uncompressedTextureDownsamplingEnabled",function(){return a._reloadAll()}),x.init(this,"suspended",function(b){return a.setVisibility(!b)})],"sceneLayerHandles");
this._idbCache.init();this._cacheKeySuffix=t.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._componentColorManager=this._hasSymbolColors()?new Ba.BufferManager(this._stage.view.renderingContext):null};c.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeThisLayerFromStage();this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);null!=
this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=this._texId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};c.prototype.isUpdating=function(){return this._controllerCreated?
!(!this._controller||!this._controller.updating):!0};c.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a;9.5367431640625E-7>this.gpuMemoryEstimate&&(this.texMemoryEstimate=this.gpuMemoryEstimate=0)};c.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/
1048576;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};c.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1048576;this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a;9.5367431640625E-7>this.gpuMemoryEstimate&&(this.texMemoryEstimate=this.gpuMemoryEstimate=0)};c.prototype._isBundleLoaded=function(a){return this._nodeId2Meta.has(a.id)};c.prototype._initGraphicsController=function(){var a=this;this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addBundle:function(b,
d){return a._addBundle(b,d)},isBundleLoaded:function(b){return a._isBundleLoaded(b)},getMemoryUsage:function(){return a.view.resourceController.getUsedMemory()},removeNodeData:function(b){return a._removeNodeDataFromStage(b.id)},getAddedNodeIDs:function(){return a._getAddedNodeIDs()}},layerViewOptionalFunctions:{setPolygonOffset:function(b,d){return a._setPolygonOffset(b,d?!0:!1)},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(b){return a._getLoadedAttributes(b)},
getAttributeData:function(b){return a._getAttributeData(b)},setAttributeData:function(b,d,e){return a._setAttributeData(b,d,e)},additionalCancelNodeLoadingHandler:function(){return a._cancel()},loadCachedBundle:function(b,d){return a._loadCachedBundle(b,d)},addCachedBundle:function(b,d,e){return a._addCachedBundle(b,d,e)}}}).then(function(b){a._controller=b;b.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};
c.prototype.getUsedMemory=function(){return this.gpuMemoryEstimate};c.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};c.prototype.removeCachedData=function(){this._removeAllNodeDataFromStage()};c.prototype.setVisibility=function(a){var b=this;this._nodeId2Meta.forEach(function(d){d=d.engineObject;d.setHidden(d.geometryRecords[0],!a);b._edgeView&&b._edgeView.updateObjectVisibility(d,a)});if(a){var d=this._isIntegratedMesh()?"im":"scene";
this.view.elevationProvider.register(d,this._elevationProvider);this.visibleGeometryChanged()}else this.visibleGeometryChanged(),this.view.elevationProvider.unregister(this._elevationProvider)};c.prototype.getStats=function(){var a={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};if(!this._controller)return a;a.nodesInIndex=Object.keys(this._controller.nodeIndex).length;
return a};c.prototype._addThisLayerToStage=function(){for(var a=this._stage,b=new Uint8Array(256),d=0;d<b.length;d++)b[d]=255;this._whiteTexture=new L(b,"white",{width:8,height:8});a.add(u.TEXTURE,this._whiteTexture);b=this.layer.id;this._stageLayer=b=new za(b,{},b);a.add(u.LAYER,b);this._stage.addToViewContent([b.id])};c.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=this._stage;a.remove(u.TEXTURE,this._whiteTexture.id);this._removeAllNodeDataFromStage();r.assert(0===
this._nodeId2Meta.size);r.assert(0===this._texId2Meta.size);a.remove(u.LAYER,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};c.prototype._getLoadedAttributes=function(a){if(a=this._nodeId2Meta.get(a.id))return a.loadedAttributes};c.prototype._getAttributeData=function(a){if(a=this._nodeId2Meta.get(a.id))return a.attributeData};c.prototype._setAttributeData=function(a,b,d){var e=this._nodeId2Meta.get(a.id);e&&(e.loadedAttributes=b,e.attributeData=d,this._setObjectSymbology(e),
this._applyFilters(a),this.visibleGeometryChanged(e.engineObject))};c.prototype._getAddedNodeIDs=function(){return t.mapToKeys(this._nodeId2Meta)};c.prototype._calcEngineMaterialTransparencyParams=function(a,b,d){var e=this.fullOpacity,h=1-r.clamp(r.fallbackIfUndefined(b.transparency,0),0,1);a=1>h||1>e||a&&ea.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||d;return{opacity:h,layerOpacity:e,transparent:a}};c.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?
a.doubleSided:!0};c.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};c.prototype._getMaterialParameters=function(a,b,d,e){var h;null!=a&&(h=(h=this._texId2Meta.get(b))&&h.engineTex?h.engineTex.id:this._whiteTexture.id);b=d.params;var c=r.fallbackIfUndefined(b.diffuse,Fa);"standard"!==d.type&&l.warn("Unknown material type '"+d.type+"', must be 'standard'");d=this._isIntegratedMesh();e={ambient:c,diffuse:c,specular:r.fallbackIfUndefined(b.specular,
Ga),atlasRegions:b.vertexRegions,textureId:h,vertexColors:this._hasVertexColors(),componentIndices:this._hasSymbolColors(),componentColorBuffer:this._hasSymbolColors()&&e?e.textureBuffer:null,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(b),cullFace:this._calcEngineMaterialCullFaceParams(b),writeStencil:d,receiveSSAO:!d,groundNormalShading:d,compressedNormals:!d};d||(a=this._calcEngineMaterialTransparencyParams(a,b),aa.mixin(e,a));return e};c.prototype._createEngineMaterial=function(a,
b,d,e,h,c,f){var g=null!=b?this._getI3STexEncoding(b):null;f=this._getMaterialParameters(b,d,e,f);f=new R(f,h);f.metadata={i3sMatId:h,i3sTexId:d,i3sTex:b,i3sMatParams:e.params};if(null!=b){(e=this._texId2Meta.get(d))?e.usedByEngineMats.push(f):(e={id:d,usedByEngineMats:[f],images:b.images,encoding:g,atlas:!0===b.atlas,wrap:"none"!==b.wrap[0]||"none"!==b.wrap[1]},this._texId2Meta.set(d,e));a:{for(b=0;b<c.length;b++)if(g=c[b],g.i3sTexId===d){d=g.data;break a}d=null}null!=d&&null==e.engineTex&&(c=Da(d,
e,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),e.engineTex=new L(d,e.id,c),this._stage.add(u.TEXTURE,e.engineTex),a.memory+=this.memEstimateTextureAdded(e.engineTex));if(null!=e.engineTex)for(a=e.engineTex.id,d=0,c=e.usedByEngineMats;d<c.length;d++)c[d].setParameterValues({textureId:a})}return f};c.prototype._getI3STexEncoding=function(a){var b=t.getAppropriateTextureEncoding(a.encoding,this._useCompressedTextures);return-1<b?a.encoding[b]:a.encoding};c.prototype._getVertexBufferLayout=
function(a,b){var d=a.params.materialID,e=b.materialDefinitions[d];r.assert(void 0!==e,"geometry wants unknown material "+d);a=a.params.textureID||"none";var c;"none"!==a&&(null!=b.textureDefinitions&&null!=b.textureDefinitions[a]||l.warn("textureDefinitions missing in shared resource"),c=b.textureDefinitions[a]);b=this._getMaterialParameters(c,a,e);return R.getVertexBufferLayout(b)};c.prototype._createEngineMat=function(a,b,d,e,c){var h=b.params.materialID,f=d.materialDefinitions[h];r.assert(void 0!==
f,"geometry wants unknown material "+h);b=b.params.textureID||"none";var k;"none"!==b&&(null!=d.textureDefinitions&&null!=d.textureDefinitions[b]||l.warn("textureDefinitions missing in shared resource"),k=d.textureDefinitions[b]);return this._createEngineMaterial(a,k,b,f,h,e,c)};c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=H.attributeLookup(a.attributes,this._getObjectIdField()),d=null;this._nodeId2Meta.forEach(function(a,
c){var e=null==d?a.featureIds.indexOf(b):-1;-1!==e&&(d={node:a.node,nodeId:c,index:e})});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.id);if(!a)return[];for(var d=[],e=this._getObjectIdField(),c=0;c<b.length;c++){var g=H.attributeLookup(b[c].attributes,e),g=a.featureIds.indexOf(g);-1!==g&&d.push(g)}return d};c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(null!=a){var b=this._nodeId2Meta.get(a.nodeId).engineObject;a=this._boundingBoxCornerPoints(a.index,
b,new Float64Array(24));if(G.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=y.create(y.NEGATIVE_INFINITY),y.expandBuffer(b,a,0,8),D.resolve({boundingBox:b,screenSpaceObjects:[]})}return D.reject()};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return t.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),b,function(){var b=d._findGraphicNodeAndIndex(a);return{node:b.node,indices:[b.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};
c.prototype.getGraphicsFromStageObject=function(a,b){if(this.layer instanceof N)return D.reject();var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,b);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?(d=this._createGraphic(a,d),D.resolve(d)):D.reject()};c.prototype._getMetadata=function(a){a=a.getMetadata();return this._nodeId2Meta.get(a.i3sNode)};c.prototype._getCacheKey=function(a){return a.baseUrl+this._cacheKeySuffix};c.prototype._cachingEnabled=function(){return!this._controller.disableCache&&
0===this.elevationOffset&&null!=this._cacheKeySuffix};c.prototype._cancel=function(){this._cancelCount=this._cancelCount+1|0};c.prototype._handleCancelled=function(a){if(0<(this._cancelCount-a|0))throw new ba;};c.prototype._loadCachedBundle=function(a,b){var d=this,e=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(a)).then(function(c){if(null==c)return null;d._handleCancelled(e);if(c.nodeVersion!==a.version)return d._idbCache.remove(d._getCacheKey(a)),null;a.obb=
wa.clone(c.nodeObb);var h=function(a){if(null==a.data)return!0;var b=d._getI3STexEncoding(c.sharedResource.textureDefinitions[a.i3sTexId]);return a.encoding!==b};return d.rendererNeedsTextures&&c.textureData.some(h)?b(c.allGeometryData,c.sharedResource).then(function(b){c.textureData=b;b.every(S)&&d._idbCache.put(d._getCacheKey(a),c).catch(function(b){return l.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+b)});d._handleCancelled(e);return c}):c}):D.resolve(null)};c.prototype._addBundle=
function(a,b){var d=this;return this._transformBundle(a,b).then(function(e){a.obb=e.obb;e={allGeometryData:b.allGeometryData,transformedGeometries:e.transformedGeometries,textureData:b.textureData,sharedResource:b.sharedResource,nodeVersion:a.version,nodeObb:a.obb,byteSize:Ea(e.transformedGeometries,b.textureData)};if(d._cachingEnabled()){var c=e.textureData.map(function(a){return S(a)?a:{i3sTexId:a.i3sTexId,encoding:a.encoding,data:null}});d._idbCache.put(d._getCacheKey(a),{allGeometryData:e.allGeometryData,
transformedGeometries:e.transformedGeometries,textureData:c,sharedResource:e.sharedResource,nodeVersion:e.nodeVersion,nodeObb:e.nodeObb,byteSize:e.byteSize}).catch(function(b){return l.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)})}return d._addCachedBundle(a,e,b.attributeDataInfo)})};c.prototype._transformBundle=function(a,b){for(var d=[],e=[b.geometryBuffer],c=0,g=b.allGeometryData;c<g.length;c++)for(var f=0,k=g[c].geometries;f<k.length;f++)d.push(this._getVertexBufferLayout(k[f],
b.sharedResource));a={geometryBuffer:b.geometryBuffer,geometryData:b.allGeometryData,layouts:d,center:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,hasColors:this._hasColors,needNormals:!this._isIntegratedMesh()&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",
a,e):D.resolve(this._worker.transform(a))};c.prototype._addCachedBundle=function(a,b,d){var e=b.allGeometryData,c=b.transformedGeometries,g=b.textureData,f=b.sharedResource;if(!this.rendererNeedsTextures)for(b=0;b<g.length;b++)g[b].data=null;b=this._stage;var k={};k[u.OBJECT]={};k[u.GEOMETRY]={};k[u.MATERIAL]={};k[u.TEXTURE]={};var Ha=this._stageLayer;if(this._nodeId2Meta.has(a.id))return this._applyFilters(a),D.resolve();if(!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(a))return D.resolve();
for(var q=a.memory=0,t=this._hasColors,w=0;w<e.length;w++){var m=e[w],n=m.componentOffsets,U=m.geometries,m=m.featureIds,p=null,r=null;if(this._hasSymbolColors())for(var p=this._componentColorManager.getBuffer(m.length),r=new Uint16Array(m.length),l=0;l<m.length;l++)r[l]=p.aquireIndex();for(var l=a.id+"|"+m[0],v=[],x=[],y=[],z=void 0,B=0;B<U.length;B++){var A=U[B],C=this._createEngineMat(a,A,f,g,p),z=c[q++],t=t||z.hasNonWhiteColors,E=ra.extractPositionData(z.interleavedVertexData,z.layout,z.indices),
E=new K(new Float32Array(z.interleavedVertexData),z.layout,E,n||K.DefaultOffsets,z.indices||K.DefaultIndices);this._hasSymbolColors()&&this._setComponentIndices(E,r);var z=z.corMatrices,G=F.mat4d.create(z.localTrafo);null!=A.transformation&&F.mat4d.multiply(G,A.transformation,G);A=v.length;A=new ya(E,l+(0<A?"_"+A:""));v.push(A);x.push(G);y.push([C]);a.memory+=this.memEstimateGeometryAdded(A.getData());k[u.MATERIAL][C.id]=C;k[u.GEOMETRY][A.id]=A}n=new Aa({idHint:a.id,name:l,geometries:v,materials:y,
transformations:x,castShadow:!0,metadata:{i3sNode:a.id,layerUid:this.layer.uid}});l=F.mat4d.create();F.mat4d.identity(l);F.mat4d.multiply(l,z.globalTrafo,l);n.setObjectTransformation(l);k[u.OBJECT][n.id]=n;m={node:a,engineObject:n,featureIds:m,attributeData:d?d.attributeData:null,loadedAttributes:d?d.loadedAttributes:null,componentColorBuffer:p,componentIndices:r};this._nodeId2Meta.set(a.id,m);this._setObjectSymbology(m);this._applyFilters(a);this._highlights.objectCreated(n);this.visibleGeometryChanged(n)}b.beginMod();
d=k[u.OBJECT];for(var I in d)d.hasOwnProperty(I)&&Ha.addObject(d[I]);for(var J in k)if(k.hasOwnProperty(J)){I=k[J];for(var H in I)I.hasOwnProperty(H)&&null==b.get(J,H)&&b.add(J,I[H])}b.endMod();!this._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(this._hasTextures=!0);this._hasColors=t;this._hasData=!0;this.notifyChange("hasTexturesOrVertexColors");return D.resolve()};c.prototype._clippingAreaChanged=function(){var a=this,b=[];G.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?
this._clippingArea=b:this._clippingArea=null;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)});this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){var a=this;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)})};c.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var d=new Float64Array(this.layer.objectIdFilter.ids),e="include"===
this.layer.objectIdFilter.method;d.sort();b.push(function(b,c){return a._objectIdFilter(d,e,c)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var c=this._controller.parsedDefinitionExpression,g=this._controller.definitionExpressionFields;b.push(function(b,d){return a._sqlFilter(b,c,g,d)})}this._clippingArea&&b.push(function(b,d){return a._boundingboxFilter(b,a._clippingArea,d)});this._filters=b};c.prototype._sqlFilter=
function(a,b,d,e){var c={},g=new C(null,null,c);g.layer=this.layer;g.sourceLayer=this.layer;var f=this.layer.objectIdField,k=0,l=0,q=this._nodeId2Meta.get(a.id);a=q.featureIds;for(var p=q.attributeData,q=d.every(function(a){return null!=p[a]||a===f}),w=0;w<a.length&&k<e.length;w++)if(e[k]===a[w]){var m=!0;if(q){c[f]=a[w];for(var m=0,n=d;m<n.length;m++){var r=n[m];r!==f&&(c[r]=t.getCachedAttributeValue(p[r],w))}m=this._evaluateClause(b,g)}m&&(e[l]=e[k],l++);k++}e.length=l};c.prototype._evaluateClause=
function(a,b){try{return a.testFeature(b)}catch(d){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&l.error("Error while evaluating definitionExpression: "+d),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&l.error("Further errors are ignored"),!1}};c.prototype._objectIdFilter=function(a,b,d){for(var e=0,c=0;e<d.length;)0<=ca.binaryIndexOf(a,d[e])===b&&(d[c]=d[e],c++),e++;d.length=c};c.prototype._boundingboxFilter=
function(a,b,d){var e=[0,0,0,0];G.mbsToMbs(a.mbs,this._controller.crsIndex,e,this.view.renderSpatialReference);e=null!=b?t.intersectBoundingBoxWithMbs(b,e):2;if(2!==e)if(0===e)d.length=0;else{var c=e=0,g=this._nodeId2Meta.get(a.id);a=g.featureIds;var f=g.engineObject.getObjectTransformation(),k=g.engineObject.getGeometryRecords()[0].getShaderTransformation();F.mat4d.multiply(f,k);if(0===f[1]&&0===f[2]&&0===f[3]&&0===f[4]&&0===f[6]&&0===f[7]&&0===f[8]&&0===f[9]&&0===f[11]&&1===f[15]){k=V;k[0]=(b[0]-
f[12])/f[0];k[1]=(b[1]-f[13])/f[5];k[2]=(b[2]-f[14])/f[10];k[3]=(b[3]-f[12])/f[0];k[4]=(b[4]-f[13])/f[5];k[5]=(b[5]-f[14])/f[10];b=g.engineObject.getGeometryRecords()[0].geometry;g=b.getComponentCount();for(f=0;f<g&&e<d.length;f++)if(d[e]===a[f]){var l=b.getComponentAABB(f,Ia);y.intersects(k,l)&&(d[c]=d[e],c++);e++}d.length=c}}};c.prototype._updateEdgeMaterialPartial=function(a,b,d){if(this._edgeView){var e=this._edgeView.getComponentMaterial(a,b),e=ka.diff(e,d);return e?"partial"===e.type&&(e=Object.keys(e.diff),
1===e.length&&"color"===e[0])?(this._edgeView.updateComponentColor(a,b,d.color),!0):!1:!0}};c.prototype._addOrUpdateEdgeRendering=function(a){if(this._edgeView){var b=a.engineObject,d=this._edgeView.hasObject(b),e=this._extractObjectEdgeMaterials(a),c=e.hasNonTransparent,e=e.edgeMaterials;if(d&&c)for(a=a.featureIds,d=0;d<a.length;d++){if(!this._updateEdgeMaterialPartial(b,d,e[d])){this._edgeView.removeObject(b);this._edgeView.addObject(b,e);break}}else d?this._edgeView.removeObject(b):c&&this._edgeView.addObject(b,
e);e=b.isHidden(b.geometryRecords[0]);this._edgeView.updateObjectVisibility(b,!e)}};c.prototype._applyFilters=function(a){var b=this._nodeId2Meta.get(a.id);b&&(this._applyFiltersToObjects(a,b),this._addOrUpdateEdgeRendering(b))};c.prototype._applyFiltersToObjects=function(a,b){var d=b.engineObject;d.unhideAllComponents();if(0!==this._filters.length){b=b.featureIds;for(var e=b.slice(),c=0,g=this._filters;c<g.length;c++)(0,g[c])(a,e);if(e.length!==b.length)for(a=0,c=d.getGeometryRecords()[0],g=0;g<
b.length;g++){var f=b[g];a>=e.length||e[a]!==f?d.setComponentVisibility(c,g,!1):a++}}};c.prototype._removeAllNodeDataFromStage=function(){var a=this;this._nodeId2Meta.forEach(function(b,d){a._removeNodeDataFromStage(d)})};c.prototype._removeNodeDataFromStage=function(a){var b=this._nodeId2Meta.get(a);if(b){var d=this._stage,e=this._stageLayer,c=b.engineObject;this._highlights.objectDeleted(c);this._edgeView&&this._edgeView.removeObject(c);this.visibleGeometryChanged(c);e.removeObject(c);for(var e=
0,g=c.getGeometryRecords();e<g.length;e++){var f=g[e];this.memEstimateGeometryRemoved(f.geometry.getData());d.remove(u.GEOMETRY,f.geometry.id);for(var k=0,f=f.materials;k<f.length;k++)this._removeMaterial(f[k],d)}if(b.componentIndices){for(e=0;e<b.componentIndices.length;e++)b.componentColorBuffer.releaseIndex(b.componentIndices[e]);this._componentColorManager.garbageCollect()}d.remove(u.OBJECT,c.id);this._nodeId2Meta.delete(a)}};c.prototype._removeMaterial=function(a,b){b.remove(u.MATERIAL,a.id);
var d=a.metadata.i3sTexId||"none";if("none"!==d){var c=this._texId2Meta.get(d),h=c.usedByEngineMats;a=h.indexOf(a);-1<a?(h[a]=h[h.length-1],h.pop()):l.error("Missing reference from material to texture");0===h.length&&((h=c.engineTex)&&h!==this._whiteTexture&&(this.memEstimateTextureRemoved(h),b.remove(u.TEXTURE,c.engineTex.id)),this._texId2Meta.delete(d))}};c.prototype._setPolygonOffset=function(a,b){var d=this._nodeId2Meta.get(a.id);if(d)for(a=0,d=d.engineObject.getGeometryRecords();a<d.length;a++)for(var c=
0,h=d[a].materials;c<h.length;c++)h[c].setParameterValues({polygonOffset:b})};c.prototype._rendererChange=function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&l.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.");if(a){var b=0;for(a=a.getSymbols();b<a.length;b++){var d=a[b];"mesh-3d"!==d.type&&l.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.")}}this.view.resourceController.setMemoryDirty()};
c.prototype._getRenderingInfo=function(a,b){var d=this._currentRenderer,c=d&&d.getSymbol(a);if(!(c instanceof O&&this._hasSymbolColors()))return null;var h,g;if(d&&d.visualVariables)for(a=d.getVisualVariableValues(a),d=0;d<a.length;d++){var f=a[d],k=f.variable.type;"color"===k?h=f.value:"opacity"===k&&(g=f.value)}b.symbol=c;b.color=h?[h.r/255,h.g/255,h.b/255]:null;b.opacity=null!=g?g:h&&null!=h.a?h.a:null;return b};c.prototype._getSymbolFillMaterial=function(a,b){var d=0;for(a=a.symbolLayers.items;d<
a.length;d++){var c=a[d];if("fill"===c.type){d=c.material;a=null!=d?d.color:null;null!=a?(E[0]=a.r/255,E[1]=a.g/255,E[2]=a.b/255,E[3]=a.a,b.color=E):b.color=null;b.colorMixMode=null!=d?d.colorMixMode:null;return}}b.color=null;b.colorMixMode=null};c.prototype._hasSymbolColors=function(){if(this._isIntegratedMesh()||!this.layer.store.defaultGeometrySchema)return!1;var a=this.layer.store.defaultGeometrySchema.featureAttributes;return!!(a&&a.faceRange&&a.id)};c.prototype._isIntegratedMesh=function(){return this.layer instanceof
N};c.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)};c.prototype._extractObjectEdgeMaterials=function(a){for(var b=[],d=a.featureIds?a.featureIds.length:1,c=this.layer.objectIdField,h=new C(null,null,{}),g=h.attributes,f=this._currentRenderer&&this._currentRenderer.requiredFields,k,l=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0]}),q=0,r=this.fullOpacity,
w=0;w<d;w++){k=l;null!=c&&null!=a.featureIds&&(g[c]=a.featureIds[w]);if(null!=f&&null!=a.attributeData)for(var m=0,n=Object.keys(a.attributeData);m<n.length;m++){var p=n[m];g[p]=t.getCachedAttributeValue(a.attributeData[p],w)}n=this._getRenderingInfo(h,W);m=a.engineObject;if(m.getComponentVisibility(m.getGeometryRecords()[0],w)&&0<r&&n&&n.symbol instanceof O)for(m=0,n=n.symbol.symbolLayers.items;m<n.length;m++)if(p=n[m],p instanceof la&&(p=ua.createMaterial(this._edgeView,p,r))){k=p;break}b.push(k);
q+=k.color[3]}return{hasNonTransparent:0<q,edgeMaterials:b}};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors()){for(var b=a.featureIds?a.featureIds.length:1,d=new C(null,null,{}),c=d.attributes,h=this.layer.objectIdField,g=this._currentRenderer&&this._currentRenderer.requiredFields,f=!1,k=new Uint8Array(4),l={color:null,colorMixMode:null},p=[0,0,0,0],q=null,r=0;r<b;r++){null!=h&&null!=a.featureIds&&(c[h]=a.featureIds[r]);if(null!=g&&null!=a.attributeData)for(var m=0,n=Object.keys(a.attributeData);m<
n.length;m++){var u=n[m];c[u]=t.getCachedAttributeValue(a.attributeData[u],r)}(n=this._getRenderingInfo(d,W))?(n.symbol!==q&&(q=n.symbol,this._getSymbolFillMaterial(n.symbol,l)),m=n.color,n=n.opacity,m=null==m||null==n?Q.overrideColor(m,n,l.color,l.color&&l.color[3],T,p):Q.overrideColor(m,n,null,null,T,p),1>m[3]&&(f=!0),t.encodeSymbolColor(m,l.colorMixMode,k)):t.encodeSymbolColor(null,null,k);a.componentColorBuffer.textureBuffer.setData(a.componentIndices[r],k[0],k[1],k[2],k[3])}this._updateObjectOpacity(a.engineObject,
f)}};c.prototype._setComponentIndices=function(a,b){for(var d=a.getAttribute(r.VertexAttrConstants.COMPONENTINDEX),c=d.data,h=d.offsetIdx,d=d.strideIdx,g=a.getIndices(r.VertexAttrConstants.COMPONENTINDEX),f=0;f<b.length;f++)for(var k=a.componentOffsets[f+1],l=a.componentOffsets[f];l<k;l++)c[h+g[l]*d]=b[f]};c.prototype._elevationInfoChanged=function(){var a=this.layer.elevationInfo&&this.layer.elevationInfo.unit;a&&!P.supportsUnit(a)&&l.warn("elevationInfo.unit","'"+a+"' is not a valid unit")};c.prototype._rangeInfosChanged=
function(a){null!=a&&0<a.length&&l.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};c.prototype._reloadAll=function(){this._removeAllNodeDataFromStage();null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._nodeId2Meta.forEach(function(a){b._updateObjectOpacity(a.engineObject);b._addOrUpdateEdgeRendering(a)})};c.prototype._updateObjectOpacity=function(a,b){var d=
0;for(a=a.getGeometryRecords();d<a.length;d++)for(var c=0,h=a[d].materials;c<h.length;c++){var g=h[c],f=g.metadata;void 0!==b&&(f.symbolIsTransparent=b);var k=g.getParams(),f=this._calcEngineMaterialTransparencyParams(f.i3sTex,f.i3sMatParams,f.symbolIsTransparent);k.transparent===f.transparent&&k.layerOpacity===f.layerOpacity||g.setParameterValues(f)}};c.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};c.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};
c.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};c.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};c.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new sa({forAll:function(d,c){a._forAllFeatures(function(c,e,f){b.id=c;
b.index=e;b.meta=f;a._boundingBoxCornerPoints(e,f.engineObject,b.bbCorners);d(b)},c)},createGraphic:function(b){return a._createGraphic(b.index,b.meta)},requestFields:function(b,c,h){return t.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),h,function(){var d=a._getGraphicIndices(b,c);return{node:b,indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return a._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};c.prototype._createExtentBuilder=
function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,c=y.create(y.NEGATIVE_INFINITY),e=new Float64Array(24);return{add:function(d){G.bufferToBuffer(d.bbCorners,a,0,e,b,0,8)&&y.expandBuffer(c,e,0,8)},getExtent:function(){return y.toExtent(c,b)}}};c.prototype._forAllFeatures=function(a,b,c){var d=this;this._nodeId2Meta.forEach(function(e,g){d._forAllFeaturesOfNode(e,a,c);b&&b(e.node)})};c.prototype._forAllFeaturesOfNode=function(a,b,c){for(var d=a.featureIds,h=a.engineObject.getGeometryRecords()[0],
g=0;g<d.length;g++)(c||a.engineObject.getComponentVisibility(h,g))&&b(d[g],g,a,h)};c.prototype._createGraphic=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);if(null!=b.attributeData)for(var e=0,h=Object.keys(b.attributeData);e<h.length;e++){var g=h[e];c[g]=t.getCachedAttributeValue(b.attributeData[g],a)}a=new C(null,null,c);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].getComponentAABB(a,
V);for(var d=0;8>d;++d)B[0]=d&1?a[0]:a[3],B[1]=d&2?a[1]:a[4],B[2]=d&4?a[2]:a[5],F.mat4d.multiplyVec3(b.objectTransformation,B),c[3*d]=B[0],c[3*d+1]=B[1],c[3*d+2]=B[2];return c};c.prototype.highlight=function(a,b){var c=this,e=this._highlights;if(a instanceof ma){b=e.acquireSet(b);var h=b.set,g=b.handle;this.queryObjectIds(a).then(function(a){return e.setFeatureIds(h,a)});return g}if("number"===typeof a||a instanceof C)return this.highlight([a],b);a instanceof da&&(a=a.toArray());if(Array.isArray(a)&&
0<a.length){if(a[0]instanceof C)return a=a.map(function(a){return H.attributeLookup(a.attributes,c._getObjectIdField())}),g=e.acquireSet(b),b=g.set,g=g.handle,e.setFeatureIds(b,a),g;if("number"===typeof a[0])return g=e.acquireSet(b),b=g.set,g=g.handle,e.setFeatureIds(b,a),g}return{remove:function(){}}};c.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=
ha.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null}))};v([p.property()],c.prototype,"layer",void 0);v([p.property()],c.prototype,"_controller",void 0);v([p.property({dependsOn:["_controller.updating"]})],c.prototype,"updating",void 0);v([p.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0);v([p.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);v([p.property({readOnly:!0,
dependsOn:["layer.renderer"]})],c.prototype,"rendererNeedsTextures",null);v([p.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);v([p.property()],c.prototype,"alwaysLoadEverythingModeEnabled",void 0);v([p.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","_useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);v([p.property({dependsOn:["layer.version"]})],c.prototype,"_useCompressedTextures",
null);return c=v([p.subclass("esri.views.3d.layers.SceneLayerView3D")],c)}(p.declared(na,va));var B=F.vec3d.create(),V=y.create(),Ia=y.create(),E=[0,0,0,0],W={symbol:null};return M});