// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../geometry/Polygon ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/ColorMaterial".split(" "),
function(y,R,F,G,H,z,I,J,K,L,l,x,M,t,A,r,u,B,N,O,C,P,Q){var v=P.VertexAttrConstants;y=A.vec3d;var q=A.mat4d;x=function(w){function m(){var a=null!==w&&w.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};return a}F(m,w);m.prototype._prepareResources=function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()};m.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),b=
{color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new Q(b,a+"_colormat");this._context.stage.add(u.ModelContentType.MATERIAL,this._material)};m.prototype._prepareOutlineResources=function(){var a=this.symbol.outline;if(this._hasOutline=!!(a&&a.size&&0<a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:H.pt2px(a.size)},this._outlineMaterial=1.5<=a.width?t.createRibbonMaterial(a):t.createNativeMaterial(a),
this._context.stage.add(u.ModelContentType.MATERIAL,this._outlineMaterial)};m.prototype.destroy=function(){w.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)};m.prototype.createGraphics3DGraphic=function(a,b){var k=this._validateGeometry(a.geometry);
if("polyline"!==k.type&&"polygon"!==k.type&&"extent"!==k.type)return this._logWarning("unsupported geometry type for fill symbol: "+k.type),null;k="graphic"+a.uid;b=this._getVertexOpacityAndColor(b,Uint8Array,255);var h=this.getGraphicElevationContext(a);return"on-the-ground"===h.mode?this._createAsOverlay(a,b,h,k):this._createAs3DShape(a,b,h,k,a.uid)};m.prototype.layerPropertyChanged=function(a,b,k){if("opacity"===a)return b=this._material.getColor(),k=this._getMaterialOpacity(),this._material.setColor([b[0],
b[1],b[2],k]),this._material.setTransparent(1>k),this._outlineMaterial&&(b=this._outlineMaterial.getColor(),this._outlineMaterial.setColor([b[0],b[1],b[2],this._getOutlineOpacity()])),!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var h=this._elevationContext.mode;if(null==a||null==h)return!1;if("on-the-ground"===a&&"on-the-ground"===h)return!0;if(a!==h&&("on-the-ground"===a||"on-the-ground"===h))return!1;a=l.needsElevationUpdates2D(h);for(var g in b){var c=
b[g];(h=k(c))&&!h.isDraped()&&(c=c.graphic,h.needsElevationUpdates=a,h.elevationContext.set(this.getGraphicElevationContext(c)))}return!0}return!1};m.prototype.setDrawOrder=function(a,b,k){this._material&&(this._material.renderPriority=a+b/2,k[this._material.id]=!0);this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,k[this._outlineMaterial.id]=!0)};m.prototype._createAs3DShape=function(a,b,k,h,g){var c=this._getPolyGeometry(a),d=c.hasZ;a=c.rings;var f=this._getOutlineGeometry(c,a),c=l.getGeometryVertexData3D(f,
d,c.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,k);e.idHint=h;e.color=b;e.data=c;var D;this._hasOutline&&(D=new c.vertexData.constructor(c.vertexData));e.outNum=0;e.outGeometries=[];e.outTransforms=[];e.outMaterials=[];this._createAs3DShapeFill(e);e.data.vertexData=D;this._createAs3DShapeOutline(e);this._logGeometryCreationWarnings(e.data,a,"rings","FillSymbol3DLayer");if(0===e.outNum)return null;b=new O({geometries:e.outGeometries,
materials:e.outMaterials,transformations:e.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicId:g},idHint:h});b=new L(this,b,e.outGeometries,null,null,J.perVertexElevationAligner,k);b.alignedTerrainElevation=c.terrainElevation;b.needsElevationUpdates=l.needsElevationUpdates2D(k.mode);return b};m.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,k=a.data.eleVertexData,h=a.data.vertexData,g=function(f){var d=b[f];f=d.count;var g=d.index;if(c._context.clippingExtent&&
(l.computeBoundingBox(k,g,f,n),l.boundingBoxClipped(n,c._context.clippingExtent)))return"continue";var e=new Float64Array(k.buffer,3*g*k.BYTES_PER_ELEMENT,3*f),m=new Float64Array(h.buffer,3*g*h.BYTES_PER_ELEMENT,3*f),d=d.holeIndices.map(function(a){return a-g}),d=z(e,d,3);if(0===d.length)return"continue";l.chooseOrigin(h,g,f,p);l.subtractCoordinates(h,g,f,p);f=c._createFillGeometry(d,0,m,e,a.color);f=new B(f,a.idHint);f.singleUse=!0;e=q.identity();q.translate(e,p,e);a.outGeometries.push(f);a.outMaterials.push([c._material]);
a.outTransforms.push(e);a.outNum++},c=this,d=0;d<b.length;++d)g(d)};m.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,k=a.data.eleVertexData,h=a.data.vertexData,g=0;g<b.length;++g){var c=b[g],d=c.index,f=c.count;if(this._context.clippingExtent&&(l.computeBoundingBox(k,d,f,n),l.boundingBoxClipped(n,this._context.clippingExtent)))continue;l.chooseOrigin(h,d,f,p);l.subtractCoordinates(h,d,f,p);c=new Float64Array(k.buffer,3*d*k.BYTES_PER_ELEMENT,
3*f);d=new Float64Array(h.buffer,3*d*h.BYTES_PER_ELEMENT,3*f);d=t.createPolylineGeometry(d,c,a.isRings,E,0);d=new B(d,a.idHint+"outline"+g);d.singleUse=!0;c=q.identity();q.translate(c,p,c);a.outGeometries.push(d);a.outMaterials.push([this._outlineMaterial]);a.outTransforms.push(c);a.outNum++}};m.prototype._createAsOverlay=function(a,b,k,h){var g=this._getPolyGeometry(a);a=g.rings;var c=this._getOutlineGeometry(g,a);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;
this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);g=l.getGeometryVertexDataDraped(c,g.spatialReference,this._context.overlaySR);e.idHint=h;e.color=b;e.data=g;var d;this._hasOutline&&(d=new g.vertexData.constructor(g.vertexData));e.outNum=0;e.outGeometries=[];e.outBoundingBox=r.create(r.NEGATIVE_INFINITY);this._createAsOverlayFill(e);e.data.vertexData=d;this._createAsOverlayOutline(e);this._logGeometryCreationWarnings(e.data,a,"rings","FillSymbol3DLayer");return 0<e.outNum?
new K(this,e.outGeometries,null,null,e.outBoundingBox,k):null};m.prototype._createAsOverlayFill=function(a){for(var b=a.data.vertexData,k=a.data.geometryData.polygons,h=function(d){var f=k[d];d=f.count;var c=f.index,h=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*d),f=f.holeIndices.map(function(a){return a-c}),h=z(h,f,3);if(0===h.length)return"continue";l.computeBoundingBox(b,c,d,n);if(l.boundingBoxClipped(n,g._context.clippingExtent))return"continue";r.expand(a.outBoundingBox,n);l.chooseOrigin(b,
c,d,p);l.subtractCoordinates(b,c,d,p);l.setZ(b,c,d,g._getDrapedZ());d=q.identity();q.translate(d,p,d);h=g._createFillGeometry(h,c,b,null,a.color);f=new C(h);f.material=g._material;var e=n;f.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];f.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));f.transformation=d;f.name=a.idHint;f.uniqueName=a.idHint+"#"+h.id;a.outGeometries.push(f);a.outNum++},g=this,c=0;c<k.length;++c)h(c)};m.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=
a.data.vertexData,e=a.data.geometryData.outlines,h=0;h<e.length;++h){var g=e[h],c=g.index,g=g.count;l.computeBoundingBox(b,c,g,n);if(!l.boundingBoxClipped(n,this._context.clippingExtent)){r.expand(a.outBoundingBox,n);l.chooseOrigin(b,c,g,p);l.subtractCoordinates(b,c,g,p);l.setZ(b,c,g,this._getDrapedZ());g=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*g);c=q.identity();q.translate(c,p,c);var g=t.createPolylineGeometry(g,null,!0,E,0),d=new C(g);d.material=this._outlineMaterial;var f=n;d.center=
[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];d.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));d.transformation=c;d.name=a.idHint+"outline";d.uniqueName=a.idHint+"outline#"+g.id;a.outGeometries.push(d);a.outNum++}}};m.prototype._getOutlineGeometry=function(a,b){return b};m.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbol.outline.color.a};m.prototype._getOutlineColor=function(){var a=this.symbol.outline.color,b=this._getOutlineOpacity();return M.mixinColorAndOpacity(G.toUnitRGB(a),
b)};m.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?I.fromExtent(a):a};m.prototype._createFillGeometry=function(a,b,e,h,g){for(var c=a.length,d=new Uint32Array(c),f=new Uint32Array(c),k=0;k<c;k++)d[k]=a[k]+b,f[k]=0;a={};b={};a[v.POSITION]=d;a[v.COLOR]=f;b[v.POSITION]={size:3,data:e};b[v.COLOR]={size:4,data:g};h&&(b.mapPos={size:3,data:h},a.mapPos=d);return new N(b,a)};return m}(x);var n=r.create(),p=y.create(),E=new Float32Array([255,255,255,255]),e={idHint:null,color:null,
data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return x});