// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/earcut/earcut ../../../../geometry/Point ../../../../geometry/Polygon ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../support/edgeUtils ../../lib/glMatrix ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(L,qa,ba,ca,da,ea,fa,C,ga,ha,ia,P,ja,Q,ka,la,ma,na,oa){function pa(f,d,a,b,c,p,h,r,n,l,D,t,g,C){var x=a.length/3,v=0;D+=2*b.count;var k=b.index,B=b.count,m=n,u=D;q.set(g,e);var w=0<t?1:-1,k=3*k,y=m;g=3*y;for(var z=m+B,m=3*z,A=0;A<B;++A)C&&(e[0]=f[k+0],e[1]=f[k+1],e[2]=f[k+2],q.normalize(e)),c[g+0]=f[k+0],c[g+1]=f[k+1],c[g+2]=f[k+2],p[g+0]=d[k+0],p[g+1]=d[k+1],p[g+2]=d[k+2],h[g+0]=-w*e[0],h[g+1]=-w*e[1],h[g+2]=-w*e[2],r[y]=0,c[m+0]=f[k+0]+t*e[0],c[m+1]=f[k+1]+t*e[1],c[m+2]=f[k+2]+t*e[2],p[m+
0]=d[k+0],p[m+1]=d[k+1],p[m+2]=d[k+2],h[m+0]=w*e[0],h[m+1]=w*e[1],h[m+2]=w*e[2],r[z]=t,g+=3,m+=3,k+=3,y+=1,z+=1;k=0;g=3*u;m=3*(u+x);g=3*(u+x);m=3*u;f=R;d=S;0>t&&(f=S,d=R);for(A=0;A<x;++A)l[g+0]=a[k+f[0]],l[g+1]=a[k+f[1]],l[g+2]=a[k+f[2]],l[m+0]=a[k+d[0]]+B,l[m+1]=a[k+d[1]]+B,l[m+2]=a[k+d[2]]+B,g+=3,m+=3,k+=3;n+=2*b.count;D=D+2*x-(2*b.count+2*x);T(c,p,r,h,v,b.pathLengths[0],b.count,n,l,D,t);n+=4*b.pathLengths[0];D+=2*b.pathLengths[0];v+=b.pathLengths[0];for(a=1;a<b.pathLengths.length;++a)T(c,p,r,h,
v,b.pathLengths[a],b.count,n,l,D,t),n+=4*b.pathLengths[a],D+=2*b.pathLengths[a],v+=b.pathLengths[a]}function H(f,d,a,b,c,p,h){b[p]=b[h];h*=3;p*=3;f[p+0]=f[h+0];f[p+1]=f[h+1];f[p+2]=f[h+2];d[p+0]=d[h+0];d[p+1]=d[h+1];d[p+2]=d[h+2];a[p+0]=c[0];a[p+1]=c[1];a[p+2]=c[2]}function T(f,d,a,b,c,p,h,r,n,l,D){var t=c,g=c+1,e=c+h,x=c+h+1,v=r,k=r+1,B=r+2*p;r=r+2*p+1;0>D&&(t=c+h+1,x=c);l*=3;for(var m=0;m<p;++m){m===p-1&&(0<D?(g=c,x=c+h):(g=c,t=c+h));var u=f,w=t,y=g,z=e,A=G,w=3*w,y=3*y,z=3*z;q.set3(u[w++],u[w++],
u[w++],J);q.set3(u[y++],u[y++],u[y++],U);q.set3(u[z++],u[z++],u[z++],V);q.subtract(U,J,W);q.subtract(V,J,X);q.cross(X,W,A);q.normalize(A,A);H(f,d,b,a,G,v,t);H(f,d,b,a,G,k,g);H(f,d,b,a,G,B,e);H(f,d,b,a,G,r,x);n[l++]=v;n[l++]=B;n[l++]=r;n[l++]=v;n[l++]=r;n[l++]=k;t++;g++;e++;x++;v+=2;k+=2;B+=2;r+=2}}var E=na.VertexAttrConstants,q=P.vec3d,Y=P.mat4d,I=q.create(),e=q.create(),R=[0,2,1],S=[0,1,2],M=new da,Z={verticalDistanceToGround:0,terrainElevation:0};L=function(f){function d(){var a=null!==f&&f.apply(this,
arguments)||this;a._edgeStageObjects=new Set;return a}ba(d,f);d.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var a=ha.validateSymbolLayerSize(this._getSymbolSize());if(a){this._logWarning(a);this.reject();return}}var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),c=q.create(b),b=b[3],c={diffuse:c,ambient:c,opacity:b,transparent:1>b||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new oa(c,a+"_3dlinemat");this._context.stage.add(Q.ModelContentType.MATERIAL,
this._material);this.resolve()};d.prototype.destroy=function(){f.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&this._context.stage.remove(Q.ModelContentType.MATERIAL,this._material.id)};d.prototype.createGraphics3DGraphic=function(a,b){var c=this._validateGeometry(a.geometry);if("polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for extrude symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",p="graphic"+
a.uid,d=this._getVertexOpacityAndColor(b,Float32Array,255),f=this.getGraphicElevationContext(a);return this._createAs3DShape(a,c,b,d,f,p,a.uid)};d.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a){b=this._getMaterialOpacity();c=1>b||this._isPropertyDriven("opacity");this._material.setParameterValues({opacity:b,transparent:c});if(0<this._edgeStageObjects.size){var p=this._context.stage.view.getEdgeView(),d=this._getLayerOpacity(),f=this.symbol.edges?this.symbol.edges.color.a:0;this._edgeStageObjects.forEach(function(a){p.updateComponentOpacity(a,
0,f*d)})}return!0}if("elevationInfo"===a){this._updateElevationContext();for(var n in b){var l=b[n];if(a=c(l))l=this.getGraphicElevationContext(l.graphic),a.needsElevationUpdates=C.needsElevationUpdates3D(l.mode),a.elevationContext.set(l)}return!0}return!1};d.prototype._getExtrusionSize=function(a){a=a.size&&this._isPropertyDriven("size")?C.getSingleSizeDriver(a.size,2):this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};d.prototype._getSymbolSize=function(){return this.symbol.size||
1};d.prototype._createAs3DShape=function(a,b,c,p,d,f,n){var l=this,h=a.geometry;"extent"===h.type&&(h=ea.fromExtent(h));a=h[b];var r=h.hasZ,g=[],e=[],x=[],v=q.create(),k=Array(6),B=this._context.renderSpatialReference===ja.SphericalECEFSpatialReference,m=this._getExtrusionSize(c),u=q.create();B||this._context.renderCoordsHelper.worldUpAtPosition(null,u);c=C.getGeometryVertexData3D(a,r,h.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,
d);this._logGeometryCreationWarnings(c,a,b,"ExtrudeSymbol3DLayer");if(0<a.length){var w=c.geometryData.polygons,y=c.eleVertexData,z=c.vertexData;b=z.length/3;var A=new Float64Array(18*b),G=new Float64Array(18*b),H=new Float64Array(18*b),J=new Float64Array(6*b),N=0;b=function(a){var b=w[a],c=b.count,d=b.index;if(O._context.clippingExtent&&(C.computeBoundingBox(y,d,c,k),C.boundingBoxClipped(k,O._context.clippingExtent)))return"continue";var h=new Float64Array(y.buffer,3*d*A.BYTES_PER_ELEMENT,3*c),l=
b.holeIndices.map(function(a){return a-d}),h=ca(h,l,3);if(0<h.length){C.chooseOrigin(z,d,c,v);var l=new Uint32Array(6*c+2*h.length),r=6*c,n=new Float64Array(A.buffer,3*N*A.BYTES_PER_ELEMENT,3*r),q=new Float64Array(G.buffer,3*N*G.BYTES_PER_ELEMENT,3*r),t=new Float64Array(H.buffer,3*N*H.BYTES_PER_ELEMENT,3*r),aa=new Float64Array(J.buffer,1*N*J.BYTES_PER_ELEMENT,1*r);pa(z,y,h,b,n,t,q,aa,0,l,0,m,u,B);C.subtractCoordinates(n,0,r,v);N+=6*c;b=O._createExtrudeGeometry(l,{positions:n,elevation:t,normals:q,
heights:aa},p);a=new ka(b,f+"path"+a);a.singleUse=!0;g.push(a);e.push([O._material]);a=Y.identity();Y.translate(a,v,a);x.push(a)}};var O=this;for(a=0;a<w.length;++a)b(a);if(0<g.length){n=new ma({geometries:g,materials:e,transformations:x,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:n},idHint:f});var L=function(a){var b=l._context.stage.view.getEdgeView();if(b){b.removeObject(a);l._edgeStageObjects.delete(a);var c=ia.createMaterial(b,l.symbol,l._getLayerOpacity());c&&(l._edgeStageObjects.add(a),
b.addObject(a,[c]))}};L(n);n=new fa(this,n,g,null,null,function(a,b,c,d){var p=d.setAltitude;M.spatialReference=c.spatialReference;for(var f=a.getGeometryRecords(),h=f.length,r="absolute-height"!==b.mode,l=0,k=0;k<h;k++){var g=f[k].geometry,n=f[k].transformation,m=g.getData();F[0]=n[12];F[1]=n[13];F[2]=n[14];g.invalidateBoundingInfo();for(var m=m.getVertexAttr(),g=m[E.POSITION].data,n=m[E.SIZE].data,m=m.mapPos.data,q=g.length/3,e=0,t=0,u=!1,w=0,x=0;x<q;x++){M.x=m[t];M.y=m[t+1];M.z=m[t+2];K[0]=g[e];
K[1]=g[e+1];K[2]=g[e+2];var v=C.computeElevation(c,M,b,d,r?Z:null);r&&(w+=Z.terrainElevation);I[0]=g[e]+F[0];I[1]=g[e+1]+F[1];I[2]=g[e+2]+F[2];p(v+n[e/3],I);g[e]=I[0]-F[0];g[e+1]=I[1]-F[1];g[e+2]=I[2]-F[2];v=.01/d.unitInMeters;if(Math.abs(K[0]-g[e])>v||Math.abs(K[1]-g[e+1])>v||Math.abs(K[2]-g[e+2])>v)u=!0;t+=3;e+=3}u&&a.geometryVertexAttrsUpdated(k);l+=w/q}b=l/h;L(a);return b},d);n.alignedTerrainElevation=c.terrainElevation;n.needsElevationUpdates=C.needsElevationUpdates3D(d.mode);return n}}return null};
d.prototype._createExtrudeGeometry=function(a,b,c){for(var d=a.length,f=new Uint32Array(d),e=0;e<d;e++)f[e]=0;d={};e={};d[E.POSITION]=a;d[E.NORMAL]=a;d[E.COLOR]=f;e[E.POSITION]={size:3,data:b.positions};e[E.NORMAL]={size:3,data:b.normals};e[E.COLOR]={size:4,data:c};e[E.SIZE]={size:1,data:b.heights};b.elevation&&(e.mapPos={size:3,data:b.elevation},d.mapPos=a);return new la(e,d)};return d}(ga);var G=q.create(),J=q.create(),U=q.create(),V=q.create(),W=q.create(),X=q.create(),K=q.create(),F=q.create();
return L});