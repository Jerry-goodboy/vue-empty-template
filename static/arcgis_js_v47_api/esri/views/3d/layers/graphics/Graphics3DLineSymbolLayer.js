// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/screenUtils ../../../../geometry/Polygon ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../lib/glMatrix ../../support/aaBoundingBox ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry".split(" "),function(Q,R,F,B,G,H,I,J,m,K,L,x,C,z,
D,M,N,O){var E=C.vec3d,y=C.mat4d;return function(p){function f(){return null!==p&&p.apply(this,arguments)||this}F(f,p);f.prototype._prepareResources=function(){var a=this.symbol,b=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),a={idHint:this._getStageIdHint(),width:this._getWidth(a),color:this._getMaterialOpacityAndColor()};if(!this._isPropertyDriven("size")){var c=L.validateSymbolLayerSize(a.width);if(c){this._logWarning(c);this.reject();return}}if(b||
1.5<=a.width)this._isPropertyDriven("size")&&(a.width=0),this._material=x.createRibbonMaterial(a);else if(0<a.width)this._material=x.createNativeMaterial(a);else{this.reject();return}this._context.stage.add(D.ModelContentType.MATERIAL,this._material);this.resolve()};f.prototype._getWidth=function(a){return null!=a.size?B.pt2px(a.size):1};f.prototype.destroy=function(){p.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(D.ModelContentType.MATERIAL,
this._material.id),this._material=null)};f.prototype.createGraphics3DGraphic=function(a,b){var c=this._validateGeometry(a.geometry);if("polyline"!==c.type&&"polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",d="graphic"+a.uid,f=this._getVertexOpacityAndColor(b,Float32Array,255),h=0;b.size&&this._isPropertyDriven("size")&&(h=m.getSingleSizeDriver(b.size),h=B.pt2px(h));b=
this.getGraphicElevationContext(a);return"on-the-ground"===b.mode?this._createAsOverlay(a,c,f,h,b,d):this._createAs3DShape(a,c,f,h,b,d,a.uid)};f.prototype.layerPropertyChanged=function(a,b,c){if("opacity"===a)return b=this._material.getColor(),this._material.setColor([b[0],b[1],b[2],this._getMaterialOpacity()]),!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var d=this._elevationContext.mode;if(null==a||null==d)return!1;if("on-the-ground"===a&&"on-the-ground"===
d)return!0;if(a!==d&&("on-the-ground"===a||"on-the-ground"===d))return!1;a=m.needsElevationUpdates2D(d);for(var f in b){var h=b[f];(d=c(h))&&!d.isDraped()&&(h=h.graphic,d.needsElevationUpdates=a,d.elevationContext.set(this.getGraphicElevationContext(h)))}return!0}return!1};f.prototype._getOutlineGeometry=function(a,b){return b};f.prototype._getGeometry=function(a){a=this._validateGeometry(a.geometry);"extent"===a.type&&(a=G.fromExtent(a));return a};f.prototype._createAs3DShape=function(a,b,c,f,A,
h,P){var g=this._getGeometry(a),d=g.hasZ,e=g[b],r=this._getOutlineGeometry(g,e);a=[];var t=[],k=[],n=E.create(),q=Array(6),g=m.getGeometryVertexData3D(r,d,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,A);this._logGeometryCreationWarnings(g,e,b,"LineSymbol3DLayer");if(0<r.length){for(var e=g.geometryData.outlines,r=g.eleVertexData,d=g.vertexData,p=0;p<e.length;++p){var v=e[p];if(!(1>=v.count)){var l=v.index,w=v.count;if(this._context.clippingExtent&&
(m.computeBoundingBox(r,l,w,q),m.boundingBoxClipped(q,this._context.clippingExtent)))continue;m.chooseOrigin(d,l,w,n);m.subtractCoordinates(d,l,w,n);v=new Float64Array(r.buffer,3*l*r.BYTES_PER_ELEMENT,3*w);l=new Float64Array(d.buffer,3*l*d.BYTES_PER_ELEMENT,3*w);l=x.createPolylineGeometry(l,v,"rings"===b,c,f);l=new M(l,h+"path"+p);l.singleUse=!0;a.push(l);t.push([this._material]);l=y.identity();y.translate(l,n,l);k.push(l)}}if(0<a.length)return b=new N({geometries:a,materials:t,transformations:k,
castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicId:P},idHint:h}),b=new J(this,b,a,null,null,H.perVertexElevationAligner,A),b.alignedTerrainElevation=g.terrainElevation,b.needsElevationUpdates=m.needsElevationUpdates2D(A.mode),b}return null};f.prototype._createAsOverlay=function(a,b,f,d,p,h){var c=this._getGeometry(a);this._material.renderPriority=this._symbolLayerOrder;var g=c[b],u=this._getOutlineGeometry(c,g);a=[];var e=Array(6),r=z.create(z.NEGATIVE_INFINITY),t=E.create(),c=m.getGeometryVertexDataDraped(u,
c.spatialReference,this._context.overlaySR);this._logGeometryCreationWarnings(c,g,b,"LineSymbol3DLayer");if(0<u.length){g=c.vertexData;u=c.geometryData.outlines;for(c=0;c<u.length;++c){var k=u[c],n=k.index,k=k.count;m.computeBoundingBox(g,n,k,e);if(!m.boundingBoxClipped(e,this._context.clippingExtent)){z.expand(r,e);m.chooseOrigin(g,n,k,t);m.subtractCoordinates(g,n,k,t);m.setZ(g,n,k,this._getDrapedZ());k=new Float64Array(g.buffer,3*n*g.BYTES_PER_ELEMENT,3*k);n=y.identity();y.translate(n,t,n);var k=
x.createPolylineGeometry(k,null,"rings"===b,f,d),q=new O(k);q.material=this._material;q.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];q.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]));q.transformation=n;q.name=h;q.uniqueName=h+"#"+k.id;a.push(q)}}return new I(this,a,null,null,r,p)}return null};return f}(K)});