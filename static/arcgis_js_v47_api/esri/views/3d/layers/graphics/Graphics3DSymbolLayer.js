// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/Logger ../../../../core/scheduling ./constants ./ElevationContext ./featureExpressionInfoUtils ./Graphics3DSymbolCommonCode ./graphicUtils ../../support/PromiseLightweight".split(" "),function(A,B,q,r,t,u,v,l,h,k,m,w){function n(c,a){c=null!=c?a.attributes[c]:0;null!=c&&isFinite(c)||(c=0);return c}var c=new l,x=t.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer"),y={mode:"on-the-ground",
offset:0,unit:"meters"},z={mode:"absolute-height",offset:0,unit:"meters"};return function(p){function a(b,d,g,e){var a=p.call(this)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};a.symbolContainer=b;a.symbol=d;a._context=g;a._symbolLayerOrder=g.layerOrder;a._symbolLayerOrderDelta=g.layerOrderDelta;a._elevationContext=new l;a._material=null;a._geometryCreationWarningHandle=null;a._updateDrivenProperties(e);a._updateElevationContext();a._prepareResources();return a}q(a,
p);a.prototype._logWarning=function(b){x.warn(b)};a.prototype._logGeometryCreationWarnings=function(b,d,a,e){var g=this;if(null==this._geometryCreationWarningHandle){var c=b.geometryData&&b.geometryData.polygons;e+=" geometry failed to be created";var f=null;b.projectionSuccess?!d.length||1===d.length&&!d[0].length?f=e+" (no "+a+" were defined)":Array.isArray(d)&&Array.isArray(d[0])?d.some(function(b){return 1===b.length})?f=e+" ("+a+" should contain at least 2 vertices)":c&&0===c.length&&"rings"===
a&&(f=e+" (filled "+a+" should use clockwise winding - try reversing the order of vertices)"):f=e+" ("+a+" should be defined as a 2D array)":f=e+" (failed to project geometry to view spatial reference)";f&&(this._geometryCreationWarningHandle=u.schedule(function(){return g._onNextTick()}),this._logWarning(f))}};a.prototype._onNextTick=function(){this._geometryCreationWarningHandle=null};a.prototype._getGeometryCentroid=function(b){b=this._validateGeometry(b.geometry);switch(b.type){case "extent":return b.center;
case "polyline":return k.placePointOnPolyline(b);case "polygon":return k.placePointOnPolygon(b);case "point":return b;case "mesh":return b.extent.center;default:return this._logWarning("unsupported geometry type: "+b.type),null}};a.prototype._validateGeometry=function(b){switch(b.type){case "point":if(null==b.x||null==b.y){this._logWarning("point coordinate is null - setting to default value");var a=b.clone();a.x=b.x||0;a.y=b.y||0;return a}}return b};a.prototype._prepareResources=function(b){throw Error("This is an abstract base class");
};a.prototype._defaultElevationInfoNoZ=function(){return y};a.prototype._defaultElevationInfoZ=function(){return z};a.prototype._updateElevationContext=function(){this._elevationContext.setDefaults();var b=this._context.layer.elevationInfo;b&&this._elevationContext.mixinApi(b);(b=this.symbol&&this.symbol.elevationInfo)&&this._elevationContext.mixinApi(b);this._elevationContext.featureExpressionInfoContext=this._context.featureExpressionInfoContext};a.prototype.getGraphicElevationContext=function(b){var a=
b.geometry.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ();c.setUnit(null!=this._elevationContext.unit?this._elevationContext.unit:a.unit);c.mode=this._elevationContext.mode||a.mode;c.setOffsetMeters(null!=this._elevationContext.meterUnitOffset?this._elevationContext.meterUnitOffset:a.offset);c.featureExpressionInfoContext=this._elevationContext.featureExpressionInfoContext;c.hasOffsetAdjustment=!1;this._elevationOptions.supportsOnTheGround||"on-the-ground"!==c.mode||(c.mode="relative-to-ground",
c.setOffsetMeters(0),c.featureExpressionInfoContext=h.zeroContext);a=h.createFeature(b);h.setContextFeature(c.featureExpressionInfoContext,a);k.needsOffsetAdjustment(c,this._elevationOptions,b.geometry,this.symbolContainer)&&(c.setOffsetRenderUnits(v.defaultIconElevationOffset),c.hasOffsetAdjustment=!0);return c};a.prototype._getDrapedZ=function(){return-2};a.prototype._updateDrivenProperties=function(b){var a={color:!1,opacity:!1,size:!1};!b&&(b=this._context.renderer)&&(a.color=!!b.colorInfo,a.size=
!!b.sizeInfo,b.visualVariables&&b.visualVariables.forEach(function(b){switch(b.type){case "color":a.color=!0;if(b.colors)for(var e=0;e<b.colors.length;e++){var d=b.colors[e];d&&(Array.isArray(d)&&3<d.length&&255!==d[3]||void 0!==d.a&&255!==d.a)&&(a.opacity=!0)}if(b.stops)for(e=0;e<b.stops.length;e++)(d=b.stops[e].color)&&(Array.isArray(d)&&3<d.length&&255!==d[3]||void 0!==d.a&&255!==d.a)&&(a.opacity=!0);break;case "opacity":a.opacity=!0;break;case "size":a.size=!0}}));this._drivenProperties=a};a.prototype._isPropertyDriven=
function(b){return this._drivenProperties[b]};a.prototype._getLayerOpacity=function(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;var b=this._context.layer.opacity;return null==b?1:b};a.prototype._getMaterialOpacity=function(){var b;b=1*this._getLayerOpacity();var a=this.symbol&&this.symbol.material;a&&!this._isPropertyDriven("opacity")&&a.color&&(b*=a.color.a);return b};a.prototype._getMaterialOpacityAndColor=function(){var b=this.symbol&&
this.symbol.material,a=this._getMaterialOpacity(),b=!this._isPropertyDriven("color")&&b&&b.color?r.toUnitRGB(b.color):null;return m.mixinColorAndOpacity(b,a)};a.prototype._getVertexOpacityAndColor=function(b,a,c){var d=this._isPropertyDriven("color")?b.color:null;b=this._isPropertyDriven("opacity")?b.opacity:null;d=m.mixinColorAndOpacity(d,b);c&&(d[0]*=c,d[1]*=c,d[2]*=c,d[3]*=c);return a?new a(d):d};a.prototype._getStageIdHint=function(){return this._context.layer.id+"_symbol"};a.prototype.isFastUpdatesEnabled=
function(){return this._fastUpdates&&this._fastUpdates.enabled};a.prototype.setDrawOrder=function(b,a,c){this._material&&(this._material.renderPriority=b,c[this._material.id]=!0)};a.prototype.createGraphics3DGraphic=function(b,a){for(var d=2;d<arguments.length;d++);throw Error("This is an abstract base class");};a.prototype.destroy=function(){this._geometryCreationWarningHandle&&(this._geometryCreationWarningHandle.remove(),this._geometryCreationWarningHandle=null)};a.prototype.layerPropertyChanged=
function(b,a,c){return!1};a.prototype.applyRendererDiff=function(b,a,c,e){return!1};a.prototype._getFastUpdateAttrValues=function(b){if(!this._fastUpdates.enabled)return null;var a=this._fastUpdates.visualVariables,c=a.size?n(a.size.field,b):0;b=a.color?n(a.color.field,b):0;return[c,b,0,0]};return a}(w.Promise)});