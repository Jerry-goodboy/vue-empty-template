// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/Error ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../tasks/QueryTask ../../../../tasks/support/Query ./I3SBinaryReader ../../lib/glMatrix ../../support/projectionUtils ../support/symbolColorUtils".split(" "),function(V,e,E,l,m,F,t,G,H,I,J,K,u,L){function q(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function v(a,
b,c,d,h,f){if(null!=c){var g=M;u.mbsToMbs(c.mbs,d,g,b);if(0!==w(a,g)){f.push(c);for(var g=null!=c.children?c.children.length:0,e=0;e<g;e++)v(a,b,h[c.children[e].id],d,h,f)}}}function w(a,b){var c=b[0],d=b[1],h=b[2];b=b[3];var f=0;if(c<a[0])var g=a[0]-c,f=f+g*g;d<a[1]&&(g=a[1]-d,f+=g*g);h<a[2]&&(g=a[2]-h,f+=g*g);c>a[3]&&(g=c-a[3],f+=g*g);d>a[4]&&(g=d-a[4],f+=g*g);h>a[5]&&(g=h-a[5],f+=g*g);if(f>b*b)return 0;if(0<f)return 1;f=Infinity;c-a[0]<f&&(f=c-a[0]);d-a[1]<f&&(f=d-a[1]);h-a[2]<f&&(f=h-a[2]);a[3]-
c<f&&(f=a[3]-c);a[4]-d<f&&(f=a[4]-d);a[5]-h<f&&(f=a[5]-h);return f>b?2:1}function r(a,b,c){var d=[],h=c&&c.missingFields;c=c&&c.originalFields;for(var f=0;f<a.length;f++){for(var g=a[f],e=g.toLowerCase(),k=!1,n=0,x=b;n<x.length;n++){var y=x[n];if(e===y.name.toLowerCase()){d.push(y.name);k=!0;c&&c.push(g);break}}!k&&h&&h.push(g)}return d}function N(a,b){return a.filter(function(a){return a.toLowerCase()!==b.toLowerCase()}).concat([b])}function O(a,b,c,d){b.sort(function(a,b){return a.attributes[c]-
b.attributes[c]});var h=b.map(function(a){return a.attributes[c]}),f=[],g=r(d,a.fields,{originalFields:f});return z(a,h,g).then(function(a){for(var c=0;c<b.length;c++){var d=b[c],h=a[c];d.attributes={};for(var e=0;e<f.length;e++)d.attributes[f[e]]=h[g[e]]}return b})}function P(a,b){for(var c=[],d=0;d<a.length;d++){var h=a[d];h in b.attributes||c.push(h)}return c}function z(a,b,c){if(null!=a.maxRecordCount&&b.length>a.maxRecordCount){var d=Q(b,a.maxRecordCount);return m.all(d.map(function(b){return z(a,
b,c)})).then(R)}d=new I({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return(new H(a.parsedUrl.path)).execute(d).then(function(a){return a&&a.features&&a.features.length===b.length?a.features.map(function(a){return a.attributes}):m.reject(new l("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function S(a,b,c,d,h){for(var f=[],g=0;g<b.attributeData.length;g++){var e=b.attributeData[g],k=a[g];k&&-1!==d.indexOf(k.name)&&(e=F.makeAbsolute(e.href,
b.baseUrl),f.push({url:e,storageInfo:k}))}return m.eachAlways(f.map(function(a){return E(a.url,{responseType:"array-buffer"}).then(function(b){return J.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){var b=[];if(!h.ignoreUnavailableFields&&a.some(function(a){return null==a.value})){for(var b=[],d=0;d<a.length;d++)null==a[d].value&&b.push({name:f[d].storageInfo.name,error:a[d].error});return m.reject(new l("scenelayer:attribute-request-failed","Request for scene layer attributes failed",
{failedAttributes:b}))}for(var g=0;g<c.length;g++){for(var e=c[g],k={},d=0;d<a.length;d++)null!=a[d].value&&(k[f[d].storageInfo.name]=A(a[d].value,e));b.push(k)}return b})}function A(a,b){b=a[b];return a instanceof Int16Array?b===T?null:b:a instanceof Int32Array?b===U?null:b:b!==b?null:b}function Q(a,b){var c=a.length;b=Math.ceil(c/b);for(var d=[],h=0;h<b;h++)d.push(a.slice(Math.floor(c*h/b),Math.floor(c*(h+1)/b)));return d}function R(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function B(a){var b=
new t(q(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function C(a){var b=new t(q(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function p(a,b,c){if(!G.canProject(a,b))throw new l("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new l("layerview:local-gcs-not-supported",
"Geographic coordinate systems are not supported in local scenes",{});}function D(a,b,c){var d=B(a);a=C(a);p(d,b,c);p(a,b,c)}Object.defineProperty(e,"__esModule",{value:!0});e.DDS_ENCODING_STRING="image/vnd-ms.dds";e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];e.extractWkid=q;e.getAppropriateTextureEncoding=function(a,b){if(Array.isArray(a)){if(b&&(b=a.indexOf(e.DDS_ENCODING_STRING),-1<b))return b;for(b=0;b<a.length;b++)if(-1<e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b]))return b;
throw Error("Could not find appropriate texture encoding (among "+a.toString()+")");}return-1};e.findIntersectingNodes=v;e.buildTopNodeMap=function(a,b,c,d){a.set(c,d);for(c=function(){var b=Number.POSITIVE_INFINITY,c;a.forEach(function(a,d){a<b&&(c=d,b=a)});a.delete(c)};a.size>b;)c()};var M=K.vec4d.create();e.intersectBoundingBoxWithMbs=w;e.findFieldsCaseInsensitive=r;e.whenGraphicAttributes=function(a,b,c,d,e,f){var g=!0===(f&&f.populateObjectId),h=f.ignoreUnavailableFields?void 0:[],k=1===d.length&&
"*"===d[0];!k&&g&&(d=N(d,c));d=k?d:r(d,a.fields,{missingFields:h});if(h&&0!==h.length)return m.reject(new l("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:h}));if(0===b.length)return m.resolve(b);var g=a.associatedLayer,h=a.attributeStorageInfo,n=k?a.fields.map(function(a){return a.name}):d;if(g)return O(g,b,c,n);a=P(n,b[0]);return 0===a.length?m.resolve(b):h?(e=e(),null==e?m.reject(new l("scenelayer:feature-not-loaded","Tried to query attributes for unloaded features")):
S(h,e.node,e.indices,a,f).then(function(a){for(var c=0;c<b.length;c++){for(var d=0,e=n;d<e.length;d++){var f=e[d];f in a[c]||(a[c][f]=b[c].attributes[f])}b[c].attributes=a[c]}return b})):m.reject(new l("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var T=-Math.pow(2,15),U=-Math.pow(2,31);e.getCachedAttributeValue=A;e.convertFlatRangesToOffsets=function(a,b,c){void 0===c&&(c=2);b=null!=b?b:a.length/c;for(var d=new Uint32Array(b+1),e=0;e<b;e++){var f=
a[e*c];d[e]=3*f;var g=(e-1)*c+1;if(0<=g&&f-1!==a[g])throw new l("Face ranges are not continuous");}d[d.length-1]=3*(a[(b-1)*c+1]+1);return d};e.getIndexCrs=B;e.getVertexCrs=C;e.getCacheKeySuffix=function(a,b){return b===u.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};e.checkSpatialReference=p;e.checkSpatialReferences=D;e.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null!=a.geometryType&&
"triangles"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new l("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{});};e.checkSceneLayerCompatibleWithView=function(a,b){D(a,b.spatialReference,b.viewingMode)};e.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==
a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new l("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};e.checkPointCloudLayerCompatibleWithView=function(a,b){p(a.spatialReference,b.spatialReference,b.viewingMode)};e.encodeSymbolColor=L.encodeSymbolColor;
e.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var d=0,c=c.symbolLayers.items;d<c.length;d++){var e=c[d];if("fill"!==e.type||null==e.material||"replace"!==e.material.colorMixMode)return!0}}return!1};e.mapToKeys=
function(a){var b=[];a.forEach(function(a,d){return b.push(d)});return b};e.setToKeys=function(a){var b=[];a.forEach(function(a){return b.push(a)});return b}});