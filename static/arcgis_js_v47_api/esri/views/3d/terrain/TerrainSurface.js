// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Handles ../../../core/Logger ../../../core/ObjectPool ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/Point ../lib/glMatrix ../support/aaBoundingRect ../support/Evented ../support/mathUtils ../support/PreallocArray ../support/projectionUtils ../support/PromiseLightweight ../support/ResourceController ./OverlayManager ./PlanarTile ./SphericalTile ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./TileGeometryFactory ./TilemapOnlyTile ./tileUtils ./tileUtils ../../vectorTiles/VectorTileDisplayObject ../../webgl/Texture".split(" "),
function(H,oa,Q,n,R,C,S,T,U,V,W,p,X,y,z,Y,Z,aa,E,I,ba,ca,da,ea,J,fa,k,ga,r,ha,ia,A,K,ja,ka){function L(k,c){return k[0]===c[0]&&k[1]===c[1]&&k[2]===c[2]}function M(k){return k&&("cancel"===k||"cancel"===k.dojoType)}function N(k,c){var a=!1;c=c||k;var b=0;for(k=k.children;b<k.length;b++){var d=k[b];if(d){for(var g in d.layerInfo)for(var h in d.layerInfo[g]){var f=d.layerInfo[g][h].upsampleFromTile;if(f&&f.tile===c)return!0}a=a||N(d,c)}}return a}var O=y.vec3d,F=y.vec4d,P=y.mat4d,B=r.weakAssert,t=U.getLogger("esri.views.3d.terrain.TerrainSurface");
H=function(y){function c(a,b){a=y.call(this)||this;a.defaultTileBackground=k.DEFAULT_TILE_BACKGROUND;a.hideSkirtsDistanceFromExtentMargin=la;a.hideSkirtsMinimumCameraTilt=ma;a._clippingExtent=null;a._dataExtent=null;a._elevationBounds=[0,0];a._rootExtent=[0,0,0,0];a._iteratorPool=new V(K.IteratorPreorder);a._postorderIterator=new K.IteratorPostorder;a.visible=!1;a.suspended=!1;a._pendingUpdates=!1;a._lvPendingUpdates=!1;a._updateNextFrame=0;a._vectorTileLayerRequests=0;a._memoryUsage={};a._curOverlayOpacity=
1;a._curEyePos=O.create();a._curSplitLimits=[0,0,0,0,0,0];a._curFrustumPlanes=Array(6);a._viewProjectionMatrix=P.identity();a.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0};a._layerViews=[[],[]];a._layerIndexByLayerViewId=[{},{}];a._basemapLayerViewHandles={};a._handles=new T;a._frameLambda=null;a._frameUpdateLowerPrio=new aa(500);a._topLevelTilemapOnlyTiles=
Array(k.TILEMAP_SIZE_EXP+1);a.loaded=!1;a.maxTextureScale=1.2;a.rootTiles=null;for(b=0;b<a._topLevelTilemapOnlyTiles.length;b++)a._topLevelTilemapOnlyTiles[b]=new ia([b-k.TILEMAP_SIZE_EXP,0,0]);for(b=0;6>b;b++)a._curFrustumPlanes[b]=F.create();return a}Q(c,y);c.prototype.normalizeCtorArgs=function(a,b){this._view=a;this._stage=a._stage;this._set("manifold",b);return{}};c.prototype.initialize=function(){var a=this;this.tilePool="planar"===this.manifold?da.Pool:ea.Pool;this._renderer=new ga(this.manifold,
null,this._view.pointsOfInterest);this._renderer.loaded=this._setLoaded.bind(this);this._renderer.updateTileBackground(this.tileBackground);this._renderer.install(this._view._stage);this._set("overlayManager",new ca({terrainSurface:this,view:this._view}));this._handles.add(this.watch("overlayManager.hasHighlights",this._handleHasHighlights.bind(this)),"overlayManager");var b={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper=
"spherical"===this.manifold?new J.SurfaceExtentHelperGlobal(b):new J.SurfaceExtentHelperLocal(b);this._handles.add(W.init(this.extentHelper,"stencilEnabledExtents",function(b){a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this._view.defaultsFromMap?new S({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):this._view.map.allLayers;b=new fa({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,
viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._streamDataSupplier=this._view.resourceController.registerClient(this,ba.ClientType.TERRAIN);b={needsUpdate:this._needsIdleUpdate,idleFrame:this._idleUpdate};
this._frameLambda=this._frameUpdate.bind(this);this._view.resourceController.registerFrameWorker(this._frameLambda);this._view.resourceController.registerIdleFrameWorker(this,b);this._viewChangeUpdate=this._viewChangeUpdate.bind(this);this._view.resourceController.getMemoryEvents().on("quality-changed",function(){return a._viewChangeUpdate()});this._handles.add([this._view.on("resize",this._viewChangeUpdate),this._view.watch("state.camera",this._viewChangeUpdate,!0),this._view.watch("qualitySettings.tiledSurface.lodBias",
this._viewChangeUpdate),this._view.watch("clippingArea",this._clippingChanged.bind(this))],"view");this._handles.add(this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),"allLayerViews");this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[],target:this._view.allLayerViews});this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){this._handles.destroy();this._removeAllTiles();this.tilingSchemeLogic.destroy();
this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;for(var a in this._basemapLayerViewHandles)this._unregisterTiledLayerView(a);this._view.resourceController.deregisterFrameWorker(this._frameLambda);this._view.resourceController.deregisterIdleFrameWorker(this);this._view.resourceController.deregisterClient(this);this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._renderer.destroy(this._stage);this._streamDataSupplier=this._stage=
this._view=this._renderer=null};Object.defineProperty(c.prototype,"cullBackFaces",{set:function(a){this._renderer.setCullBackFaces(a);this._set("cullBackFaces",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"frontMostTransparent",{set:function(a){this._renderer.setFrontMostTransparent(a);this._set("frontMostTransparent",a)},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"opacity",{set:function(a){this._renderer.setOpacity(a);this._set("opacity",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.setRenderOrder(a);this._set("renderOrder",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"skirts",{set:function(a){this._renderer.setDrawSkirts(a);
this._set("skirts",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"tileBackground",{set:function(a){a!==this.tileBackground&&this._renderer.updateTileBackground(a);this._set("tileBackground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&this._renderer.setVelvetOverground(a);this._set("velvetOverground",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"wireframe",{set:function(a){this._renderer.setWireframe(a);
this._set("wireframe",a);this._view._stage.setRenderParams({earlyOcclusionPixelDraw:a})},enumerable:!0,configurable:!0});c.prototype.setVisibility=function(a){a!==this.visible&&(this.visible=a,this._renderer.setVisibility(a),this.setUpdatesDisabled(!a),a&&this._viewChangeUpdate())};c.prototype.isVisible=function(){return this.visible&&this.ready};c.prototype.isSeeThrough=function(){return this._renderer.isTransparent()};c.prototype.setUpdatesDisabled=function(a){(this.suspended=a)||this._viewChangeUpdate()};
c.prototype.intersect=function(a,b,d){this._renderer.intersect(a,b,d)};c.prototype.getElevation=function(a){if(!this.ready)return null;var b=this.rootTiles;if(0===b[0].layerInfo[k.LayerClass.ELEVATION].length)return null;if(a instanceof X){if(!E.pointToVector(a,x,this.tilingScheme.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;a=x}for(var d,g=0;g<b.length;g++){var c=b[g];if(A.isPosWithinTile(c,a)){for(;c&&!c.renderData;)b=
0,a[0]>.5*(c.extent[0]+c.extent[2])&&(b+=1),a[1]<.5*(c.extent[1]+c.extent[3])&&(b+=2),c=c.children[b];d=(b=c.renderData)&&b.geometryState?b.geometryState.samplerData:null;break}}return d?ha.elevationSampler(a[0],a[1],d):null};c.prototype.getElevationBounds=function(){return this._elevationBounds};c.prototype.getScale=function(a){if(this.tilingScheme){if(!E.pointToVector(a,x,this.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),
null;if(this.rootTiles)for(var b=0;b<this.rootTiles.length;b++)if(a=this.rootTiles[b],A.isPosWithinTile(a,x)){for(;a.children[0];)b=0,x[0]>a.children[0].extent[2]&&(b+=1),x[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.lij[0])}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,d,c){b=b?this.tilingScheme.levelAtScale(b):0;d=d?this.tilingScheme.levelAtScale(d):Infinity;var g=this._getLodBias();this._renderer.queryVisibleLevelRange(a,b+g,d+g,c)};
c.prototype._setLoaded=function(){this.loaded||this._set("loaded",!0)};c.prototype._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent,b=this.tilingSchemeLogic.tilingScheme,d=!1;a&&!z.equals(a,this._dataExtent)&&(d=!0,this._dataExtent?z.set(this._dataExtent,a):this._dataExtent=z.create(a));b!==this.tilingScheme&&(B(!!b,"tiling scheme cannot be reset to undefined"),d=!0,this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",b),this._updateClippingExtent(),b&&(this._updateTiledLayers(),
this._renderer.setTileSize(b.pixelSize[0]),this.overlayManager.setSpatialReference(b.spatialReference,"spherical"===this.manifold)));d&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,d,c){var g=this.tilePool.acquire();D[0]=a;D[1]=b;D[2]=d;g.init(D,c,this,this.tilingScheme);return g};c.prototype._releaseTile=function(a){a.dispose();a.parent=null;a.parentSurface=null;this.tilePool.release(a)};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,
d=this.tilingScheme;if(b&&d){var c=x,h=d.rootTilesInExtent(b,c,Infinity);if(this.rootTiles){if(h.length>G){t.warn(k.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),f=C.difference(b,h,L);if(0<f.removed.length||0<f.added.length){var e=this.rootTiles.filter(function(b){return-1<C.findIndex(f.removed,L.bind(null,b.lij))?(a._purgeChildTiles(b),a._purgeTile(b),!1):!0});f.added.forEach(function(b){b=a._acquireTile(0,b[1],b[2],null);e.push(b);a._loadTile(b)});
this._set("rootTiles",e);this._renderer.setRootTiles(this.rootTiles)}}else h.length>G&&(t.warn(k.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),h=d.rootTilesInExtent(b,c,G)),this._set("rootTiles",h.map(function(b){b=a._acquireTile(0,b[1],b[2],null);a._loadTile(b);return b})),this._renderer.setRootTiles(this.rootTiles);C.equals(c,this._rootExtent)||(this._rootExtent=F.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.setVisibility(!0);this._viewChangeUpdate();this.overlayManager.setOverlayDirty();
this.notifyChange("ready")}};c.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateOverlayOpacity(this._curEyePos),this._updateTiles(this.rootTiles))};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.pendingUpdates&l.UPDATE_GEOMETRY&&(this._renderer.updateTileGeometryNeedsUpdate(a),this._updateTileGeometry(a),a.pendingUpdates&=~l.UPDATE_GEOMETRY)};c.prototype._updateTiles=
function(a){var b=this._iteratorPool.acquire();b.reset(a);var d=this._curSplitLimits,c=this._curFrustumPlanes,h=this._curEyePos,f;A.hasVisibleSiblings(a)?(a=this._elevationBounds[0],f=this._elevationBounds[1]):(a=Infinity,f=-Infinity);for(;!b.done;){var e=b.next();this._updateClippingStatus(e);var m=!0;if(e.updateVisibility(c,h)){e.updateScreenDepth(this._viewProjectionMatrix);e.renderData&&(a=Math.min(e.elevationBounds[0],a),f=Math.max(e.elevationBounds[1],f));var v=e.shouldSplit(d,h);v===l.SPLIT?
(e.pendingUpdates&=~l.MERGE,e.renderData?(m=!1,e.pendingUpdates|=l.SPLIT,b.skip()):m=!1):(e.pendingUpdates&=~l.SPLIT,v===l.VSPLITMERGE&&e.updateAgents(k.LayerClass.ELEVATION),b.skip())}else b.skip();if(m&&!e.renderData){e.pendingUpdates|=l.MERGE;e.pendingUpdates&=~l.SPLIT;m=this._iteratorPool.acquire();for(m.reset(e);!m.done;)v=m.next(),this._updateClippingStatus(v),v.updateVisibility(c,h),v.visible&&v.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(m)}0!==e.pendingUpdates&&
(this._pendingUpdates=!0)}this._iteratorPool.release(b);isFinite(a)&&isFinite(f)&&(this._elevationBounds[0]!==a||this._elevationBounds[1]!==f)&&(this._elevationBounds[0]=a,this._elevationBounds[1]=f,this.emit("elevation-bounds-change",null))};c.prototype._updateViewDependentParameters=function(){var a=this._view.state.camera,b=Math.tan(.5*a.fovX),d=Math.tan(.5*a.fovY),c=this.tilingScheme.pixelSize,h=Math.pow(2,-this._getLodBias());this._curSplitLimits[0]=b;this._curSplitLimits[1]=c[0]/a.width*this.maxTextureScale*
h;this._curSplitLimits[2]=d;this._curSplitLimits[3]=c[1]/a.height*this.maxTextureScale*h;this._curSplitLimits[4]=this.tilingScheme.getMaxLod();this._curSplitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias;a.copyFrustumPlanes(this._curFrustumPlanes);P.multiply(a.projectionMatrix,a.viewMatrix,this._viewProjectionMatrix);O.set(a.eye,this._curEyePos);r.autoUpdateSkirtsVisibility(this,this._curEyePos)};c.prototype._setLayerViewsUpdating=function(){for(var a=0;a<k.LayerClass.LAYER_CLASS_COUNT;a++)for(var b=
this._layerViews[a],d=0;d<b.length;d++)b[d]._evaluateUpdatingState(this._pendingUpdates)};c.prototype._frameUpdateTraversal=function(a){if(this.suspended)return!1;this._frameUpdateLowerPrio.clear();var b=this._renderer.resourceCounter.numTileTexturesComposited,d=this._iteratorPool.acquire();d.reset(this.rootTiles);for(var c=!1,h=!1;!d.done&&(1<a.remaining()||!c)&&this._renderer.resourceCounter.numTileTexturesComposited-b<na;){var f=d.next();f.pendingUpdates&l.MERGE?(this._mergeTile(f),f.pendingUpdates&=
~l.MERGE,c=!0,d.skip()):f.pendingUpdates&l.SPLIT?(this._splitTile(f),f.pendingUpdates&=~l.SPLIT,c=!0,d.skip()):0<f.pendingUpdates&&this._frameUpdateLowerPrio.push(f);0!==f.pendingUpdates&&(h=!0)}this._pendingUpdates=h||!d.done;this._iteratorPool.release(d);return c};c.prototype._updateTileGeometry=function(a){this._renderer._updateTileGeometry(a);u.spatialReference=this.spatialReference;u.tile=a;u.extent=a.extent;this.emit("elevation-change",u)};c.prototype._updateTileTexture=function(a){this._renderer.updateTileTexture(a)};
c.prototype._frameUpdate=function(a){if(this.rootTiles){for(var b=this._frameUpdateTraversal(a);(1<a.remaining()||!b)&&0<this._frameUpdateLowerPrio.length;){var d=this._frameUpdateLowerPrio.pop();d.pendingUpdates&l.DECODE_ELEVATION?(this._decodeElevation(d),d.pendingUpdates&=~l.DECODE_ELEVATION,b=!0):d.pendingUpdates&l.UPDATE_GEOMETRY?(this._renderer.updateTileGeometryNeedsUpdate(d),this._updateTileGeometry(d),b=!0,d.pendingUpdates&=~l.UPDATE_GEOMETRY):d.pendingUpdates&l.UPDATE_TEXTURE&&(this._updateTileTexture(d),
d.pendingUpdates&=~l.UPDATE_TEXTURE,b=!0);0!==d.pendingUpdates&&(this._pendingUpdates=!0)}0<this._frameUpdateLowerPrio.length&&(this._pendingUpdates=!0);if(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)this._pendingUpdates=!0;this._pendingUpdates===this._lvPendingUpdates||!this._pendingUpdates&&20!==++this._updateNextFrame||(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0);b&&(this._memoryUsage={})}};c.prototype._needsIdleUpdate=
function(){return this.isVisible()&&this.overlayManager&&this.overlayManager.overlaysNeedUpdate()};c.prototype._idleUpdate=function(){this.overlayManager.updateOverlay();this._updateOverlayOpacity(this._curEyePos)};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=[0,0,0,0],b=null;E.extentToBoundingRect(this._view.clippingArea,a,this.spatialReference)&&(b=a);if(C.equals(b,this._clippingExtent))return!1;this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");
this.overlayManager.setOverlayDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};c.prototype._getLodBias=function(){var a=this._view.resourceController.getMemoryFactor();return Math.round(this._view.qualitySettings.tiledSurface.lodBias+2*a-2)};c.prototype._getLodBiasCorrectedScale=function(a){var b=this.tilingScheme.levels;a=Z.clamp(a-this._getLodBias(),0,b.length-1);return b[a].scale};c.prototype._cancelTilemapRequests=function(a){for(var b=
0;b<k.LayerClass.LAYER_CLASS_COUNT;b++){var d=a.layerInfo[b];if(d)for(var c=0;c<d.length;c++){var h=d[c];h.tilemapRequest&&(h.tilemapRequest.cancel(),h.tilemapRequest=null)}}};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){a._purgeChildTiles(b);a._purgeTile(b)}),this._set("rootTiles",null),this.notifyChange("ready"));for(var b=0;b<this._topLevelTilemapOnlyTiles.length;b++)this._cancelTilemapRequests(this._topLevelTilemapOnlyTiles[b]);this.setVisibility(!1)};
c.prototype._purgeChildTiles=function(a){var b=this._postorderIterator;for(b.reset(a);!b.done;){for(var d=b.next(),c=0;4>c;c++)d.children[c]=null;d!==a&&this._purgeTile(d)}};c.prototype._purgeTile=function(a){a.unload(this._renderer);this._cancelTilemapRequests(a);a.parent=null;this._releaseTile(a)};c.prototype._splitTile=function(a){var b=a.lij[0]+1,d=2*a.lij[1],c=2*a.lij[2];a.children[0]=this._createTile(b,d,c,a);a.children[1]=this._createTile(b,d,c+1,a);a.children[2]=this._createTile(b,d+1,c,a);
a.children[3]=this._createTile(b,d+1,c+1,a);a.unload(this._renderer);w.spatialReference=this.spatialReference;w.extent=a.extent;w.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",w)};c.prototype._createTile=function(a,b,c,g){B(!!g,"_createTile sanity check");a=this._acquireTile(a,b,c,g);a.updateClippingStatus(this._clippingExtent);a.updateVisibility(this._curFrustumPlanes,this._curEyePos);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),a.shouldSplit(this._curSplitLimits,
this._curEyePos)===l.SPLIT&&(a.pendingUpdates|=l.SPLIT,this._pendingUpdates=!0));this._loadTile(a);return a};c.prototype._mergeTile=function(a){B(!a.renderData,"_mergeTile sanity check");this._loadTile(a);this._purgeChildTiles(a);w.spatialReference=this.spatialReference;w.extent=a.extent;w.scale=this._getLodBiasCorrectedScale(a.lij[0]);this.emit("scale-change",w)};c.prototype._loadTile=function(a){a.load(this._renderer);this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(a,
a.renderData,this._curOverlayOpacity);u.spatialReference=this.spatialReference;u.tile=a;u.extent=a.extent;this.emit("elevation-change",u)};c.prototype._handleHasHighlights=function(a){this._renderer.setNeedsHighlight(a)};c.prototype._decodeElevation=function(a){var b=k.LayerClass.ELEVATION,c=a.layerInfo[b];if(c)for(var g=0;g<c.length;g++){var h=c[g];h.pendingUpdates&=~l.DECODE_ELEVATION;if(h.rawData){var f=a.decodeElevationData(h.rawData);h.rawData=null;if(f){h.data=f;var h=a.lij[0],e=this._iteratorPool.acquire();
for(e.reset(a);!e.done;){var m=e.next();m.findElevationBoundsForLayer(g,h);m.computeElevationBounds()}this._iteratorPool.release(e);a.dataArrived(g,b,f);this._updateTiles(a)}}}};c.prototype._handleLayerViewChanges=function(a){var b=this,c=!1;a.added.forEach(function(a){var d=a.layer;r.isTiledLayerView(a)?(b._registerTiledLayer(a),d.loaded&&(c=!0)):a.supportsDraping&&b.overlayManager&&b.overlayManager.registerLayerView(a)});a.removed.forEach(function(a){r.isTiledLayerView(a)?(c=!0,b._unregisterTiledLayerView(a.uid)):
a.supportsDraping&&b.overlayManager&&b.overlayManager.unregisterLayerView(a)});(c=c||0<a.moved.filter(r.isTiledLayerView).length)&&this._updateTiledLayers()};c.prototype._registerTiledLayer=function(a){var b=this,c=[];c.push(a.watch("suspended",function(){b._updateTiledLayers()}));c.push(a.watch("fullOpacity",function(){return b._updateTileTextures()}));a.on("data-changed",function(){var c=r.isElevationLayerView(a)?k.LayerClass.ELEVATION:k.LayerClass.MAP,d=b._layerIndexByLayerViewId[c][a.uid];null!=
d&&b._invalidateLayerData(d,c)});this._basemapLayerViewHandles[a.uid]=c};c.prototype._unregisterTiledLayerView=function(a){var b=this._basemapLayerViewHandles[a];if(b){for(var c=0;c<b.length;c++)b[c].remove();delete this._basemapLayerViewHandles[a]}};c.prototype._updateTiledLayers=function(){var a=this;if(this.tilingScheme){var b=this._view.allLayerViews,c=[[],[]],g=k.LayerClass,h=null,f=z.create(z.NEGATIVE_INFINITY);b.forEach(function(b){var d=b.layer;if(b.layer&&b&&!b.suspended&&r.isTiledLayerView(b)){var e=
b.fullExtent;e?a.tilingScheme.compatibleWith(b.tileInfo)?(z.expand(f,e),r.isElevationLayerView(b)?c[g.ELEVATION].push(b):(Infinity!==b.maxDataLevel&&(null===h||b.maxDataLevel>h)&&(h=b.maxDataLevel),c[g.MAP].push(b))):t.warn("Terrain: tiling scheme of layer "+d.id+" is incompatible with other tiled layers, will not be drawn"):t.warn("Terrain: Map or elevation layer does not have fullExtent: "+d.id)}},this);for(var b=function(a){var b=e._layerViews[a],d=c[a];d.reverse();var f=b.length!==d.length,h=
d.length,m=Array(h),v=Array(b.length);e._layerIndexByLayerViewId[a]={};for(var k=0;k<h;k++){e._layerIndexByLayerViewId[a][d[k].uid]=k;var l=b.indexOf(d[k]);m[k]=l;k!==l&&(f=!0);-1<l&&(v[l]=k)}if(f){e._topLevelTilemapOnlyTiles.forEach(function(b){return b.modifyLayers(v,m,a)});b=e._postorderIterator;if(e.rootTiles)for(b.reset(e.rootTiles);!b.done;)b.next().modifyLayers(v,m,a);e._layerViews[a]=d;if(e.rootTiles){for(b.reset(e.rootTiles);!b.done;)d=b.next(),d.restartAgents(a),a===g.ELEVATION&&d.computeElevationBounds();
e._updateTiles(e.rootTiles)}}},e=this,m=0;m<g.LAYER_CLASS_COUNT;m++)b(m);this.tilingScheme.levels.length-1<h&&(this.tilingScheme.ensureMaxLod(h),this._viewChangeUpdate())}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]};c.prototype.numLayers=function(a){return this._layerViews[a].length};c.prototype.numTotalLayers=function(){return this._layerViews.reduce(function(a,b){return b.length+a},0)};c.prototype._updateTileTextures=
function(){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)a.next().updateTexture();this._iteratorPool.release(a)};c.prototype._invalidateLayerData=function(a,b){var c=this._iteratorPool.acquire();for(c.reset(this.rootTiles);!c.done;)c.next().removeLayerAgent(a,b);for(c.reset(this.rootTiles);!c.done;)c.next().invalidateLayerData(a,b);this._iteratorPool.release(c)};c.prototype.requestTileData=function(a,b,c){var d=this;this.tilemapStats.tilesRequested++;var h=this.layerViewByIndex(b,
c),f=h.layer;if(f.tilemapCache&&!r.isVectorTileLayerView(h)){var e=this.getTilemapTile(a),m=e.layerInfo[c][b];if(m.tilemap){if(!e.tileDataAvailable(a,b,c))return this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(a,"dataMissing",c,h,{notInTilemap:!0}),b=new I.Promise,b.reject(),b}else{m.tilemapRequest||(m.tilemapRequest=this.requestTilemap(e,b,c,h,f));var k,l=new I.Promise(function(){k&&k.cancel()});m.tilemapRequest.always(function(){m.tilemapRequest=null;if(!l.isCancelled()){var b=d._layerIndexByLayerViewId[c][h.uid];
null!=b&&(e.tileDataAvailable(a,b,c)?(k=d._requestTileData(a,b,c,h),k.then(function(){return l.resolve()})):(d.tilemapStats.tilesNotPresent++,d._dispatchDataEvent(a,"dataMissing",c,h,{notInTilemap:!0}),l.reject()))}});return l}}return this._requestTileData(a,b,c,h)};c.prototype._requestTileData=function(a,b,c,g){this.tilemapStats.tileRequestsSent++;return c===k.LayerClass.ELEVATION?this._requestElevationTileData(a,b,c,g):this._requestMapTileData(a,b,c,g)};c.prototype._requestElevationTileData=function(a,
b,c,g){function d(b){var d=e._layerIndexByLayerViewId[c][g.uid];null!=d?(d=a.layerInfo[c][d],d.rawData=b,a.pendingUpdates|=l.DECODE_ELEVATION,d.pendingUpdates|=l.DECODE_ELEVATION,e._pendingUpdates=!0):t.warn("TerrainSurface: received data from unknown layer %d %s",c,a.lij.toString())}function f(b){M(b)||(e.tilemapStats.tileRequestErrors++,e._dispatchDataEvent(a,"dataMissing",c,g,b))}var e=this,m;r.isElevationLayerView(g)?(b=g.layer,r.useFetchTileForLayer(b)?(m=b.fetchTile(a.lij[0],a.lij[1],a.lij[2],
k.ELEVATION_NODATA_VALUE),m.then(function(a){return d(a)},f)):(b=g.getTileUrl(a.lij[0],a.lij[1],a.lij[2]),m=this._streamDataSupplier.request(b,"binary"),m.then(function(a,b){b.url=a;d(b)},f))):B(!1,"_requestElevationTileData can only be called for elevation layer views");return m};c.prototype._requestMapTileData=function(a,b,c,g){function d(b){e._dispatchDataEvent(a,"dataArrived",c,g,b)}function f(b){M(b)||(e._dispatchDataEvent(a,"dataMissing",c,g,b),e.tilemapStats.tileRequestErrors++)}var e=this;
if(r.isVectorTileLayerView(g)){var k=g.tileHandler;b=g.schemeHelper.getCompatibleLevelRowCol(a.lij);b=k.getVectorTileWithLRC(b[0],b[1],b[2],0);b.then(d).catch(f).always(function(){e._vectorTileLayerRequests=k.ongoingRequestCount});this._vectorTileLayerRequests=k.ongoingRequestCount}else r.useFetchTileForLayer(g.layer)&&r.isTileLayerView(g)?(b=g.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2]),b.then(d).catch(f)):(b=g.getTileUrl(a.lij[0],a.lij[1],a.lij[2]),null!=g.refreshInterval&&g.refreshTimestamp&&(b+=
(-1<b.indexOf("?")?"\x26":"?")+"_ts\x3d"+g.refreshTimestamp),b=this._streamDataSupplier.request(b,"image"),b.then(function(a,b){return d(b)},f));return b};c.prototype.requestTilemap=function(a,b,c,g,h){var d=this,e=a.lij[0]+k.TILEMAP_SIZE_EXP,m=a.lij[1]<<k.TILEMAP_SIZE_EXP,l=a.lij[2]<<k.TILEMAP_SIZE_EXP;this.tilemapStats.tilemapRequestsSent++;this.tilemapStats.tilemapRequestsPending++;return h.tilemapCache.fetchTilemap(e,m,l,{timeout:6E3}).then(function(e){d.tilemapStats.tilemapRequestsPending--;
b=d._layerIndexByLayerViewId[c][g.uid];null!=b&&(a.layerInfo[c][b].tilemap=e)}).catch(function(a){d.tilemapStats.tilemapRequestsPending--;d.tilemapStats.tilemapRequestErrors++})};c.prototype.getTilemapTile=function(a){var b=a.lij[0];return b>k.TILEMAP_SIZE_EXP?A.getTileNLevelsUp(a,k.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[b]};c.prototype._dispatchDataEvent=function(a,b,c,g,h){g=this._layerIndexByLayerViewId[c][g.uid];if(null!=g)a[b](g,c,h);else t.warn("TerrainSurface: received data from unknown layer")};
c.prototype._updateTileOverlayParams=function(){if(this.rootTiles){var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var b=a.next();b.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(b,b.renderData,this._curOverlayOpacity)}this._iteratorPool.release(a);this._renderer.setNeedsRender()}};c.prototype._updateOverlayOpacity=function(a){if(this.overlayManager&&(a=this.overlayManager.updateOpacity(a),!isNaN(a))){if(a!==this._curOverlayOpacity&&this.rootTiles){var b=
this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.renderData&&c.renderData.overlayTexId&&(c.renderData.overlayOpacity=a)}this._iteratorPool.release(b)}this._curOverlayOpacity=a;this._renderer.setNeedsRender()}};c.prototype.getStats=function(){var a=0,b=0,c=0,g=[],h=this._iteratorPool.acquire();for(h.reset(this.rootTiles);!h.done;){var f=h.next();a++;f.renderData&&(b++,f.visible&&(c++,f=f.lij[0],g[f]=null!=g[f]?g[f]+1:1))}this._iteratorPool.release(h);return{numNodes:a,
numLeaves:b,numVisible:c,numVisiblePerLevel:g}};c.prototype.getUsedMemory=function(){if(!this._view||!this._view.basemapTerrain)return 0;var a=this._view.basemapTerrain.getMemoryUsage(),b=0,c;for(c in a)b+=a[c];return b/1024/1024};c.prototype.getMemoryUsage=function(){0===Object.keys(this._memoryUsage).length&&this._updateMemoryUsage();return this._memoryUsage};c.prototype._updateMemoryUsage=function(){if(this.tilingScheme){var a=0,b=0,c=0,g=0,h=0,f=0,e=this._iteratorPool.acquire();e.reset(this.rootTiles);
for(var m=this.tilingScheme.pixelSize,m=m[0]*m[1]*4;!e.done;){for(var l=e.next(),p=N(l),n=0,r=l.layerInfo[k.LayerClass.MAP];n<r.length;n++){var q=r[n],q=q.data,t=0,u=0;q instanceof ka?t+=1.3*q.descriptor.width*q.descriptor.height*4:q instanceof HTMLImageElement?u+=m:q instanceof ja&&(f+=q.getGpuMemoryUsage(),c+=q.getCpuMemoryUsage());l.renderData||p?(a+=u,g+=t):(b+=u,h+=t)}p=0;for(n=l.layerInfo[k.LayerClass.ELEVATION];p<n.length;p++)q=n[p],q=q.data,a+=q?m:0;l.renderData&&(q=l.renderData.texture,g+=
q&&q.descriptor?1.3*q.descriptor.width*q.descriptor.height*4:0,l=l.renderData.estimateGeometryMemoryUsage(),f+=l,c+=l)}this._iteratorPool.release(e);this._memoryUsage={cpuVisibleImageData:a,cpuInvisibleImageData:b,cpuGeometryData:c,gpuVisibleImageData:g,gpuInvisibleImageData:h,gpuGeometryData:f}}};c.prototype.getTile=function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return this.rootTiles.forEach(function(a){if(a.lij[1]===b[1]&&a.lij[2]===b[2])return a}),null;var c=Math.pow(2,b[0]),
g=Math.floor(b[1]/c),h=Math.floor(b[2]/c),f;this.rootTiles.some(function(a){return a.lij[1]===g&&a.lij[2]===h?(f=a,!0):!1});if(f){for(c=1<<b[0]-1;f.lij[0]<b[0];){var e=b[1]&c?2:0;0<(b[2]&c)&&e++;if(!f.children[e])return console.log("Tile "+a+" doesn't exist, smallest ancestor is "+A.tile2str(f)),null;f=f.children[e];c>>=1}B(f.lij[0]===b[0]&&f.lij[1]===b[1]&&f.lij[2]===b[2],"not the right tile?");return f}return null};c.prototype.hasPendingUpdates=function(){if(this._streamDataSupplier.hasPendingDownloads()||
0!==this._vectorTileLayerRequests)return!0;var a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;)if(0<a.next().pendingUpdates)return this._iteratorPool.release(a),!0;this._iteratorPool.release(a);return!1};c.prototype.setBorders=function(a){this._renderer.setBorders(a)};c.prototype.setDisableRendering=function(a){this._renderer.setDisableRendering(a)};n([p.property({value:!1})],c.prototype,"cullBackFaces",null);n([p.property({readOnly:!0})],c.prototype,"extent",null);n([p.property({value:!1})],
c.prototype,"frontMostTransparent",null);n([p.property({readOnly:!0})],c.prototype,"loaded",void 0);n([p.property({value:1})],c.prototype,"opacity",null);n([p.property({readOnly:!0})],c.prototype,"overlayManager",void 0);n([p.property({readOnly:!0})],c.prototype,"manifold",void 0);n([p.property()],c.prototype,"maxTextureScale",void 0);n([p.property({readOnly:!0})],c.prototype,"ready",null);n([p.property({value:1})],c.prototype,"renderOrder",null);n([p.property({readOnly:!0})],c.prototype,"rootTiles",
void 0);n([p.property({value:!0})],c.prototype,"skirts",null);n([p.property({readOnly:!0,aliasOf:"tilingScheme.spatialReference"})],c.prototype,"spatialReference",void 0);n([p.property({value:k.DEFAULT_TILE_BACKGROUND})],c.prototype,"tileBackground",null);n([p.property({readOnly:!0})],c.prototype,"tilingScheme",void 0);n([p.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);n([p.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],
c.prototype,"tilingSchemeDone",void 0);n([p.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);n([p.property({value:!0})],c.prototype,"velvetOverground",null);n([p.property({value:!1})],c.prototype,"wireframe",null);return c=n([p.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(p.declared(R,Y.Evented));var la=1.2,ma=80/180*Math.PI,G=k.MAX_ROOT_TILES,na=12,l=k.TileUpdateTypes,x=F.create(),D=[0,0,0],u={spatialReference:null,tile:null,extent:null},w={spatialReference:null,extent:null,
scale:0};return H});