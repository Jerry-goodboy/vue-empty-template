// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports @dojo/shim/array @dojo/shim/Set ../../../core/promiseUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./FeatureStoreItem ./projectionSupport".split(" "),function(t,u,v,w,h,r,x,y,z,A){function B(f){return f?JSON.parse(JSON.stringify(f)):f}Object.defineProperty(u,"__esModule",{value:!0});t=function(){function f(a,b){this.items=a;this.definitionExpression=b.definitionExpression;this.geometryType=b.geometryType;
this.hasM=b.hasM;this.hasZ=b.hasZ;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.fieldsMap=b.fieldsMap}Object.defineProperty(f.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0});f.prototype.createQueryResponse=function(a){return a.outStatistics?this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a)};f.prototype.executeAttributesQuery=function(a){var b=y.getWhereClause(a.where);if(!b)return h.resolve(this);
if(b.isStandardized()){for(var c=0,e=[],d=0,l=this.items;d<l.length;d++){var g=l[d];b.testFeature(g.getAttributes())&&(e[c++]=g)}b=this._createNew(e);b.definitionExpression=a.where;return h.resolve(b)}return h.reject(new TypeError("Where clause is not standardized"))};f.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return h.resolve(this);var b=new w.default(a.objectIds);return h.resolve(this._createNew(this.items.filter(function(a){return b.has(a.oid)})))};f.prototype.project=
function(a){var b=this;return!a||x.equals(this.spatialReference,a)?h.resolve(this):A.projectMany(this.items.map(function(a){return a.getGeometry()}),this.spatialReference,a).then(function(c){for(var e=[],d=0;d<b.items.length;d++)e[d]={attributes:b.items[d].getAttributes(),geometry:c[d]};c=z.createFromFeatureSet({fields:v.from(b.fieldsMap.values()),spatialReference:a,geometryType:b.geometryType,hasM:b.hasM,hasZ:b.hasZ,features:e,objectIdFieldName:b.objectIdField});return new f(c,{definitionExpression:b.definitionExpression,
geometryType:b.geometryType,hasM:b.hasM,hasZ:b.hasZ,objectIdField:b.objectIdField,spatialReference:a,fieldsMap:b.fieldsMap})})};f.prototype._createFeatureQueryResponse=function(a){var b=this,c=this.items,e=this.geometryType,d=this.hasM,l=this.hasZ,g=this.objectIdField,f=this.spatialReference,k=a.outFields,q=a.outSpatialReference,m=a.quantizationParameters,n=!1;if(null!=a.num&&null!=a.start)var h=a.start+a.num,n=c.length>h,c=c.slice(a.start,Math.min(c.length,h));return{exceededTransferLimit:n,features:this._createFeatures(a,
c),fields:k&&k.map(function(a){return b.fieldsMap.get(a)}),geometryType:e,hasM:d,hasZ:l,objectIdFieldName:g,spatialReference:B(q?q.toJSON():f),transform:m&&r.toTransform(m)}};f.prototype._createFeatures=function(a,b){var c=a.quantizationParameters,e=a.returnGeometry,d=a.returnCentroid;a=[];var l=0;if(e||d)if(c){var c=r.toTransform(c),g=r.getQuantizeX(c),f=r.getQuantizeY(c);if(e&&!d)for(d=0;d<b.length;d++)e=b[d],a[l++]={attributes:e.getAttributes(),geometry:e.getGeometryQuantized(c,g,f)};else if(!e&&
d)for(d=0;d<b.length;d++)e=b[d],a[l++]={attributes:e.getAttributes(),centroid:e.getCentroidQuantized(c,g,f)};else for(d=0;d<b.length;d++)e=b[d],a[l++]={attributes:e.getAttributes(),centroid:e.getCentroidQuantized(c,g,f),geometry:e.getGeometryQuantized(c,g,f)}}else if(e&&!d)for(c=0;c<b.length;c++)e=b[c],a[l++]={attributes:e.getAttributes(),geometry:e.getGeometry()};else if(!e&&d)for(c=0;c<b.length;c++)e=b[c],a[l++]={attributes:e.getAttributes(),centroid:e.getCentroid()};else for(c=0;c<b.length;c++)e=
b[c],a[l++]={attributes:e.getAttributes(),centroid:e.getCentroid(),geometry:e.getGeometry()};else for(c=0;c<b.length;c++)e=b[c],a[l++]={attributes:e.getAttributes()};return a};f.prototype._createNew=function(a){return new f(a,this)};f.prototype._createStatisticsQueryResponse=function(a){var b=a.outStatistics,c=[],e=[];if(a.groupByFieldsForStatistics&&a.groupByFieldsForStatistics.length)for(var d={},f=0;f<b.length;f++){var g=b[f];a=g.onStatisticField;var p=g.outStatisticFieldName,g=g.statisticType;
if("count"===g){d[a]||(d[a]=this._calculateUniqueValues(a));var g=d[a],k;for(k in g){var h=g[k],m={attributes:{}};m.attributes[p]=h.count;m.attributes[a]=h.data;c.push(m)}e.push({name:p,alias:p,type:"esriFieldTypeString"})}}else{k={};d={attributes:{}};for(f=0;f<b.length;f++)g=b[f],a=g.onStatisticField,p=g.outStatisticFieldName,g=g.statisticType,k[a]||(k[a]=this._calculateStatistics(a)),d.attributes[p]=k[a]["var"===g?"variance":g],e.push({name:p,alias:p,type:"esriFieldTypeDouble"});c.push(d)}return{fields:e,
features:c}};f.prototype._calculateStatistics=function(a){for(var b=this.items,c=b.length,e=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,f=null,g=null,h=null,k=null,q=[],m=0;m<c;m++)var n=q[m]=b[m].getAttributes()[a],f=f+n,e=Math.min(e,n),d=Math.max(d,n);if(c){g=f/c;for(b=a=0;b<q.length;b++)n=q[b],a+=Math.pow(n-g,2);k=1<c?a/(c-1):0;h=Math.sqrt(k)}else d=e=null;return{avg:g,count:c,max:d,min:e,stddev:h,sum:f,variance:k}};f.prototype._calculateUniqueValues=function(a){for(var b={},c=0,e=this.items;c<
e.length;c++){var d=e[c].getAttributes()[a];if(null==d||"string"===typeof d&&""===d.trim())d=null;null==b[d]?b[d]={count:1,data:d}:b[d].count++}return b};return f}();u.default=t});