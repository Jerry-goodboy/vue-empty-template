// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports @dojo/shim/array @dojo/shim/iterator @dojo/shim/Map @dojo/shim/Set ../../../core/Error ../../../core/promiseUtils ../../../core/libs/rbush/rbush ../../../geometry/support/contains ../../../geometry/support/intersects ../../../geometry/support/normalizeUtils ../../../geometry/support/scaleUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/webMercatorUtils ./attributeSupport ./FeatureSetReader ./FeatureStoreCapabilities ./FeatureStoreItem ./FeatureStoreResult ./projectionSupport ./SpatialQueryCache ../../../tasks/support/Query".split(" "),
function(x,y,D,q,z,A,h,n,E,F,G,H,B,I,J,v,K,L,M,w,t,N,u){function C(d){return d?JSON.parse(JSON.stringify(d)):d}Object.defineProperty(y,"__esModule",{value:!0});var O=new A.default(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),m={};x=function(){function d(a){var c=this;this._itemsMap=new z.default;this._itemsToIndex=new A.default;this._index=E(9,[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this.capabilities={query:L.queryCapabilities};
this.fieldsMap=new z.default;this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.gdbVersion=a.gdbVersion;this.historicMoment=a.historicMoment;this.cacheSpatialQueries&&(this._geometryQueryCache=new N.default);a.fields.forEach(function(a){c.fieldsMap.set(a.name.trim(),a);c.fieldsMap.set(a.name.trim().toLowerCase(),
a)})}d.prototype.destroy=function(){this.clear();this.fieldsMap.clear()};d.prototype.clear=function(){this._itemsMap.clear();this._itemsToIndex.clear();this._index.clear();this._geometryQueryCache&&this._geometryQueryCache.clear()};Object.defineProperty(d.prototype,"size",{get:function(){return this._itemsMap.size},enumerable:!0,configurable:!0});d.prototype.load=function(a,c){var b="getBounds"in a?a:K.createFeatureSetReader(a),g=this._itemsMap,d=this._itemsToIndex;this._clearCache();q.forOf(b.oids(),
function(a){var e;g.has(a)?(e=g.get(a),e.count++,c&&c.update(a)):(e=new M.default(b,a),g.set(a,e),d.add(a),c&&c.add(a))})};d.prototype.unload=function(a,c){var b=this._index,g=this._itemsMap,d=this._itemsToIndex;this._clearCache();q.forOf(a.oids(),function(a){var e;g.has(a)&&(e=g.get(a),e.count--,0===e.count&&(g.delete(a),e.bounds?(b.remove(e),e.bounds=null):d.delete(a),c&&c.remove(a)))})};d.prototype.keep=function(a,c){var b=this._index,g=this._itemsMap,d=this._itemsToIndex;this._clearCache();q.forOf(g,
function(e){var f=e[0];e=e[1];a.has(f)||(g.delete(f),e.bounds?(b.remove(e),e.bounds=null):d.delete(f),c&&c.remove(f))})};d.prototype.remove=function(a,c){var b=this._index,g=this._itemsMap,d=this._itemsToIndex;this._clearCache();for(var e=0;e<a.length;e++){var f=a[e];if(!g.has(f))break;var k=g.get(f);g.delete(f);k.bounds?(b.remove(k),k.bounds=null):d.delete(f);c&&c.remove(f)}};d.prototype.executeQuery=function(a){var c=this;void 0===a&&(a=new u);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).catch(function(a){if(a===
m)return new w.default([],c);throw a;}).then(function(a){return a.createQueryResponse(b)})};d.prototype.executeQueryForCount=function(a){var c=this;void 0===a&&(a=new u);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){return a.size}).catch(function(a){if(a===m)return 0;throw a;
})};d.prototype.executeQueryForExtent=function(a){var c=this;void 0===a&&(a=new u);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){var g=a.items.length;if(!g)return{count:g,extent:null};for(var e={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,
ymax:Number.NEGATIVE_INFINITY,spatialReference:C(c.spatialReference)},d=0,k=a.items;d<k.length;d++){var l=k[d].getBounds();l&&(e.xmin=Math.min(l[0],e.xmin),e.ymin=Math.min(l[1],e.ymin),e.xmax=Math.max(l[2],e.xmax),e.ymax=Math.max(l[3],e.ymax))}a=t.project(e,a.spatialReference,b.outSpatialReference);a.spatialReference=C(b.outSpatialReference&&b.outSpatialReference.toJSON()||c.spatialReference);0===a.xmax-a.xmin&&(e=B.getMetersPerUnitForSR(a.spatialReference),a.xmin-=e,a.xmax+=e);0===a.ymax-a.ymin&&
(e=B.getMetersPerUnitForSR(a.spatialReference),a.ymin-=e,a.ymax+=e);return{count:g,extent:a}}).catch(function(a){if(a===m)return{count:0,extent:null};throw a;})};d.prototype.executeQueryForIds=function(a){var c=this;void 0===a&&(a=new u);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){a=
a.items;for(var b=[],c=0;c<a.length;c++)b[c]=a[c].oid;return b}).catch(function(a){if(a===m)return[];throw a;})};d.prototype._clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._allItems=null};d.prototype._getAll=function(){this._allItems||(this._allItems=new w.default(D.from(this._itemsMap,function(a){return a[1]}),this));return this._allItems};d.prototype._normalizeQuery=function(a){var c=this,b=this.definitionExpression,d=a.where,h=a.geometry,e=a.outFields,f=
a.orderByFields,k=a.groupByFieldsForStatistics,l=a.outStatistics;a.where=d=d&&d.trim();if(!d||/^1 *= *1$/.test(d)||b&&b===d)a.where=null;if(e)for(b=0;b<e.length;b++)e[b]=e[b].trim();if(f)for(b=0;b<f.length;b++)f[b]=f[b].trim();if(k)for(b=0;b<k.length;b++)k[b]=k[b].trim();if(l)for(b=0;b<l.length;b++)l[b].onStatisticField=l[b].onStatisticField.trim();if(!h)return n.resolve(a);a.outSpatialReference||(a.outSpatialReference=h.spatialReference);return t.checkProjectionSupport(a,h.spatialReference,this.spatialReference).then(function(){return H.normalizeCentralMeridian(h)}).then(function(a){return t.project(a[0].toJSON(),
a[0].spatialReference,c.spatialReference)}).then(function(b){if(!b)throw m;return a.read({geometry:b})})};d.prototype._executeGeometryQuery=function(a){var c=this,b=a.geometry,d=a.outSpatialReference,h=d&&!I.equals(this.spatialReference,d),e=h?JSON.stringify({geometry:b,outSpatialReference:d}):JSON.stringify(b);if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(e))return this._geometryQueryCache.get(e);var f;if(b){this._updateSpatialIndex();f=[];for(var k=0,l=
this._getQueryBBoxes(b),n="esriGeometryPoint"===this.geometryType&&this._canQueryWithRBush(b),b=this._getSpatialOp("intersects",b,this.geometryType),m=0;m<l.length;m++){var p=l[m],r=this._index.search({minX:p[0],minY:p[1],maxX:p[2],maxY:p[3]});if(n)f=f.concat(r),k+=r.length;else if(b)for(p=0;p<r.length;p++){var q=r[p];b(q.getGeometry())&&(f[k++]=q)}else f=f.concat(r),k+=r.length}f=new w.default(f,this)}else f=this._getAll();if(h&&(a.returnGeometry||a.returnCentroid))return f.project(d).then(function(a){c.cacheSpatialQueries&&
c._geometryQueryCache.set(e,a);return a});this.cacheSpatialQueries&&this._geometryQueryCache.set(e,f);return f};d.prototype._canQueryWithRBush=function(a){switch(a.type){case "extent":return!0;case "polygon":return a.rings.every(function(a){return 5!==a.length?!1:a[0][0]===a[1][0]&&a[0][0]===a[4][0]&&a[2][0]===a[3][0]&&a[0][1]===a[3][1]&&a[0][1]===a[4][1]&&a[1][1]===a[2][1]});default:return!1}};d.prototype._updateSpatialIndex=function(){var a=this;if(this._itemsToIndex.size){var c=[];q.forOf(this._itemsToIndex,
function(b){b=a._itemsMap.get(b);b.getBounds()&&c.push(b)});this._index.load(c);this._itemsToIndex.clear()}};d.prototype._getQueryBBoxes=function(a){a=this._canQueryWithRBush(a)?a:a.extent;switch(a.type){case "extent":return[[a.xmin,a.ymin,a.xmax,a.ymax]];case "polygon":return a.rings.map(function(a){return[a[0][0],a[0][1],a[2][0],a[2][1]]})}};d.prototype._getSpatialOp=function(a,c,b){switch(c.type){case "polygon":switch(b){case "esriGeometryPoint":return F.polygonContainsPoint.bind(null,c.toJSON());
default:return null}case "extent":return G.getExtentIntersector(b).bind(null,c);default:return null}};d.prototype._checkQuerySupport=function(a){return null!=a.distance||null!=a.geometryPrecision||null!=a.maxAllowableOffset||a.multipatchOption||a.orderByFields&&a.orderByFields.length||a.pixelSize||a.relationParameter||a.text||a.timeExtent?n.reject(new h("feature-store:unsupported-query","Unsupported query options",{query:a})):n.all([this._checkGeometryQuerySupport(a),this._checkAttributesQuerySupport(a),
this._checkStatisticsQuerySupport(a),t.checkProjectionSupport(a,this.spatialReference,a.outSpatialReference)]).then(function(){return a})};d.prototype._checkAttributesQuerySupport=function(a){var c=a.outFields;if(c&&0<c.length&&(c=v.getMissingFields(this.fieldsMap,c),c.length))throw new h("feature-store:unsupported-query","outFields contains missing fields",{missingFields:c,query:a});v.validateWhere(this.fieldsMap,a.where)};d.prototype._checkGeometryQuerySupport=function(a){var c,b=a.geometry;if(!b)return null;
"intersects"!==a.spatialRelationship?c=new h("feature-store:unsupported-query","Unsupported query spatial relationship",{query:a}):"extent"!==b.type&&"polygon"!==b.type?c=new h("feature-store:unsupported-query","Unsupported query geometry type",{query:a}):"polygon"!==b.type||"esriGeometryPoint"===this.geometryType||this._canQueryWithRBush(b)?J.canProject(b.spatialReference,this.spatialReference)||(c=new h("feature-store:unsupported-query","Unsupported geometry spatialReference",{query:a})):c=new h("feature-store:unsupported-query",
"Unsupported polygon intersection",{query:a});return c?n.reject(c):n.resolve()};d.prototype._checkStatisticsQuerySupport=function(a){if(a.returnDistinctValues)return n.reject(new h("feature-store:unsupported-query","query with returnDistinctValues not supported",{query:a}));if(a.outStatistics&&a.outStatistics.length){var c=a.outStatistics.map(function(a){return a.onStatisticField.trim()}),b=v.getMissingFields(this.fieldsMap,c);if(b.length)return n.reject(new h("feature-store:unsupported-query","outStatistics contains missing fields",
{missingFields:b,query:a}));for(b=0;b<c.length;b++){var d=c[b],m=this.fieldsMap.get(d);if(!(a.groupByFieldsForStatistics&&a.groupByFieldsForStatistics.length||O.has(m.type)))return n.reject(new h("feature-store:unsupported-query","outStatistics contains non-numeric fields",{fieldName:d,query:a}))}}};return d}();y.default=x});