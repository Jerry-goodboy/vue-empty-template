// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.7/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper dojo/_base/lang ../../../../core/Error ../../../../core/Handles ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(K,L,B,C,r,n,D,h,z,E,p,m,F,G,k,H,v,t,I){var J=/(https?:)?\/\/services.*\.arcgis\.com/i;return function(A){function e(a){var c=A.call(this)||this;c._handles=new D;c._layer=a.layer;return c}B(e,A);e.prototype.destroy=function(){this._handles.destroy();this._hasLocalSource=this._layer=this._handles=null};e.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",
standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue}).then(function(a){var b,c,d;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(d=b.maxValue-b.minValue,c=b.minValue+d/2,d*=4);return k.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:d})})};e.prototype._summaryStatsFromQuery=function(a,c){var b=a.field,d=(this.supportsSQLExpression&&c?k.msSinceUnixEpochSQL(this,b):a.sqlExpression)||
b,b=d?m.getRangeExpr(d,a.minValue,a.maxValue):null;a={sqlFormat:a.sqlExpression?"standard":null,where:m.mergeWhereClauses(a.sqlWhere,b),outStatistics:k.statisticTypes.map(function(a){var b=new t;b.statisticType="variance"===a?"var":a;b.onStatisticField=d;b.outStatisticFieldName=a+"_value";return b})};return this._statisticsFromQuery(a).then(k.getSummaryStatisticsFromFeatureSet).then(function(a){c&&("min max avg stddev sum variance".split(" ").forEach(function(b){null!=a[b]&&(a[b]=Math.ceil(a[b]))}),
a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0));return k.processSummaryStatisticsResult(a)})};e.prototype._statisticsFromQuery=function(a){var c=this._layer;if(!c.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!E.isHostedAgolService(c.url)&&10.5>c.version)return h.reject(new n("feature-layer-adapter:not-supported","Layer does not support statistics query"));var b=c.createQuery();b.outStatistics=a.outStatistics;b.groupByFieldsForStatistics=a.groupByFieldsForStatistics;
b.orderByFields=a.orderByFields;b.where=m.mergeWhereClauses(b.where,a.where);b.sqlFormat=a.sqlFormat;return c.queryFeatures(b)};e.prototype._summaryStatsFromMemory=function(a,c){var b=a.field,d=a.valueExpression,f=(d||a.sqlExpression)&&!a.sqlExpression,g=a.view,d={field:b,valueExpression:d,normalizationField:a.normalizationField,view:g};return(this._hasLocalSource||a.features||"function"!==typeof b&&!f?a.features?h.resolve(a.features):this._fetchFeaturesFromMemory(g):this._fetchFeaturesForStats(d)).then(function(d){if(!d||
!d.length)return h.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var f=r.mixin({},a);if("percent-of-total"===f.normalizationType){var g=k.calculateStatsFromMemory({field:b},d).sum;if(null==g)return h.reject(new n("feature-layer-adapter:invalid","invalid normalizationTotal"));f.normalizationTotal=g}d=k.calculateStatsFromMemory(f,d,c);return k.processSummaryStatisticsResult(d)})};e.prototype._fetchFeaturesFromMemory=function(a){var c=this,
b=this._layer;return this._hasLocalSource?h.resolve(b.source):a?a.whenLayerView(b).then(function(a){var b=h.create(function(b,d){var f=a.watch("updating",function(){c._handles.remove("layerViewUpdate");a.queryFeatures().then(function(a){b(a)}).catch(function(a){d(a)})});c._handles.add(f,"layerViewUpdate")});h.timeout(b,1E4,null);return b}):h.reject(new n("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};e.prototype._fetchFeaturesForStats=function(a){var c=
this,b=this._layer,d=F.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),b=b.createQuery();b.returnGeometry=!1;b.outFields=d;return this._layer.queryFeatures(b).then(function(a){return a&&a.features}).catch(function(b){return c._fetchFeaturesFromMemory(a.view)})};e.prototype._uvFromQuery=function(a,c){var b=this,d=a.field,f=a.sqlExpression,g="countOF"+(d||"Expr"),l=new t;l.statisticType="count";l.onStatisticField=f?"*":d;l.outStatisticFieldName=
g;return this._statisticsFromQuery({sqlFormat:f?"standard":null,where:a.sqlWhere,outStatistics:[l],groupByFieldsForStatistics:[d||f]}).then(function(a){return k.getUniqueValuesFromFeatureSet(a,b,d)}).then(function(b){return k.createUVResult(b,"service-query",c,a.returnAllCodedValues)})};e.prototype._uvFromGenRenderer=function(a,c){var b=this,d=a.field,f=new I;f.attributeField=d;var g=new v;g.classificationDefinition=f;return this.generateRenderer(g).then(function(a){var c={},f=b.getField(d),g=-1<
p.numericTypes.indexOf(f&&f.type);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===r.trim(b)||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:g&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return k.createUVResult(b,"service-generate-renderer",c,a.returnAllCodedValues)})};e.prototype._uvFromMemory=function(a,c){var b=a.valueExpression,d=a.sqlExpression,f=a.view,g={field:a.field,valueExpression:b,
view:f};return(this._hasLocalSource||a.features||!b||d?a.features?h.resolve(a.features):this._fetchFeaturesFromMemory(f):this._fetchFeaturesForStats(g)).then(function(b){return k.calculateUniqueValuesFromMemory(a,b,c)})};e.prototype._calcBinsSQL=function(a,c){var b=[],d=c.length;c.forEach(function(c,g){c=m.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(g===d-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+c+") THEN "+(g+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};e.prototype._getNormalizationTotal=
function(a,c){return a&&"percent-of-total"===c?this.summaryStatistics({field:a}).then(function(a){return a.sum}):h.resolve()};e.prototype._getQueryParamsForExpr=function(a,c){if(!a.valueExpression&&!a.sqlExpression){var b=a.field,d=b?this.getField(b):null,d=p.isDateField(d);c={field:b,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:c};return{sqlExpression:d?k.msSinceUnixEpochSQL(this,b):k.getFieldExpr(c),sqlWhere:d?null:m.getSQLFilterForNormalization(a)}}return{valueExpression:a.valueExpression,
sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere}};e.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?h.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};e.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType).then(function(b){return c._getQueryParamsForExpr(a,b)}).then(function(b){return c._getDataRange(b,a.minValue,a.maxValue).then(function(d){var f=d.min,g=d.max,l=a.numBins||
10;d=k.getEqualIntervalBins(f,g,l);d=c._calcBinsSQL(b.sqlExpression,d);d={outStatistics:[new t({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"*"})],groupByFieldsForStatistics:[d],orderByFields:[d],where:b.sqlWhere,sqlFormat:"standard"};return c._statisticsFromQuery(d).then(function(a){return k.getHistogramFromFeatureSet(a,f,g,l)})})})};e.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?h.resolve({min:a.minValue,max:a.maxValue}):
this.summaryStatistics(a).then(function(a){return a.count?{min:a.min,max:a.max}:h.reject(new n("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field"))});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins)})};e.prototype._getBins=function(a,c,b){void 0===b&&(b=10);var d=a.min,f=a.max,g=a.normTotal,l=a.excludeZerosExpr,e=a.intervals||k.getEqualIntervalBins(d,f,b);return this._queryBins(e,a.sqlExpr||
c,l).then(function(a){return{bins:a.map(function(a,b){return{minValue:e[b][0],maxValue:e[b][1],count:a.value}}),minValue:d,maxValue:f,normalizationTotal:g}})};e.prototype._queryBins=function(a,c,b){for(var d=this,f=[],g=a.length,l=0;l<g;l++){var e=m.mergeWhereClauses(b,m.mergeWhereClauses(c+" \x3e\x3d "+a[l][0],null!==a[l][1]?c+(l===g-1?" \x3c\x3d ":" \x3c ")+a[l][1]:""));f.push(e)}return h.eachAlways(f.map(function(a){return d.queryFeatureCount(a)}))};e.prototype._binParamsFromGenRend=function(a,
c){var b=a.field,d=a.normalizationType,f=a.normalizationField,g=m.getSQLFilterForNormalization({field:b,normalizationType:d,normalizationField:f});a=new v({classificationDefinition:k.createCBDefn({field:b,normalizationType:d,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||10}),where:m.mergeWhereClauses(g,c)});return this.generateRenderer(a).then(function(a){return k.generateBinParams({field:b,normalizationType:d,
normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:g})})};e.prototype._histogramFromMemory=function(a){var c=this,b=a.field,d=a.normalizationType,f=a.valueExpression,g=a.classificationMethod,e=a.minValue,m=a.maxValue,w=a.view,p=f&&!a.sqlExpression,u={field:b,valueExpression:f,normalizationField:a.normalizationField,view:w};return(this._hasLocalSource||a.features||!p?a.features?h.resolve(a.features):this._fetchFeaturesFromMemory(w):this._fetchFeaturesForStats(u)).then(function(l){if(!l||
!l.length)return h.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"));var q=null!=e&&null!=m,p=null;g&&"equal-interval"!==g||d?(q=r.mixin({},a),q.features=l,p=c._getBinParamsFromMemory(q)):p=q?h.resolve({min:e,max:m,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:f,features:l,view:w}).then(function(a){return a.count?{min:a.min,max:a.max}:h.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});
return p.then(function(b){return k.calculateHistogramFromMemory(a,b,l)})})};e.prototype._getBinParamsFromMemory=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField;return this._classBreaksFromMemory({field:c,valueExpression:a.valueExpression,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,minValue:a.minValue,maxValue:a.maxValue,numClasses:a.numBins,features:a.features,view:a.view}).then(function(a){var f=
a.normalizationTotal;a=a.classBreakInfos;var e=m.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d});return k.generateBinParams({field:c,normalizationType:b,normalizationField:d,normalizationTotal:f,classBreaks:a,where:e})})};e.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField,f=a.normalizationTotal,g=m.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d}),f=k.getFieldExpr({field:c,normalizationType:b,
normalizationField:d,normalizationTotal:f}),f=m.getRangeExpr(f,a.minValue,a.maxValue),c=k.createCBDefn({field:c,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new v;b.classificationDefinition=c;b.where=m.mergeWhereClauses(g,f);return this.generateRenderer(b).then(function(b){return k.resolveCBResult(a,b)})};e.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,
b=a.maxValue,d=a.numClasses||5,f=[],g=(b-c)/d,e=0;e<d;e++){var m=c+e*g;f.push({minValue:m,maxValue:m+g})}f[d-1].maxValue=b;a=k.resolveCBResult(a,{classBreaks:f,normalizationTotal:a.normalizationTotal});return h.resolve(a)};e.prototype._classBreaksFromMemory=function(a){var c=a.field,b=a.valueExpression,d=a.view,f={field:c,valueExpression:b,normalizationField:a.normalizationField,view:d};return(this._hasLocalSource||a.features||!b?a.features?h.resolve(a.features):this._fetchFeaturesFromMemory(d):this._fetchFeaturesForStats(f)).then(function(b){if(!b||
!b.length)return h.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var d=r.mixin({},a);if("percent-of-total"===d.normalizationType){var f=k.calculateStatsFromMemory({field:c},b).sum;if(null==f)return h.reject(new n("feature-layer-adapter:invalid","invalid normalizationTotal"));d.normalizationTotal=f}return k.calculateClassBreaksFromMemory(d,b)})};e.prototype.getField=function(a){void 0===a&&(a="");return this._layer.getField(a)};e.prototype.getFieldUsageInfo=
function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null};e.prototype.getFieldDomain=function(a,c){return this._layer.getFieldDomain(a,c)};e.prototype.summaryStatistics=function(a){var c=this,b=a.field,d=b?this.getField(b):null,f=p.isDateField(d),e=(d=a.valueExpression||a.sqlExpression)&&!a.sqlExpression;return this._hasLocalSource||a.features||"function"===typeof b||e?this._summaryStatsFromMemory(a,
f):this.supportsSQLExpression||!f&&!d?(a.normalizationType?this._summaryStatsFromGenRend(a):this._summaryStatsFromQuery(a,f)).catch(function(b){return c._summaryStatsFromMemory(a,f)}):h.reject(new n("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};e.prototype.uniqueValues=function(a){var c=this,b=a.field,d=a.valueExpression,f=a.sqlExpression,e=(b?this.getField(b):null)&&this.getFieldDomain(b),b=d&&(!f||!this.supportsSQLExpression);return this._hasLocalSource||
a.features||b?this._uvFromMemory(a,e):this._uvFromQuery(a,e).catch(function(b){return a.field?c._uvFromGenRenderer(a,e):b}).catch(function(b){return c._uvFromMemory(a,e)})};e.prototype.histogram=function(a){var c=this,b=a.field,d=a.normalizationType,f=a.normalizationField,e=a.classificationMethod,l=b?this.getField(b):null,l=p.isDateField(l),q=a.valueExpression||a.sqlExpression,w=q&&!a.sqlExpression,r=this.supportsSQLExpression,u=!e||"equal-interval"===e,x=a.minValue,y=a.maxValue,v=null!=x&&null!=
y,t=a.numBins||10;return this._hasLocalSource||a.features||w?this._histogramFromMemory(a):(q||r)&&u?q&&!r?h.reject(new n("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):l&&u?h.reject(new n("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):d||!u?this._binParamsFromGenRend(a).then(function(e){if(!v)return c._getBins(e,
b,t);if(x>e.max||y<e.min)return h.reject(new n("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));if(u)return c._getBins({min:x,max:y,sqlExpr:e.sqlExpr,excludeZerosExpr:e.excludeZerosExpr},b,t);e=k.getFieldExpr({field:b,normalizationType:d,normalizationField:f,normalizationTotal:e.normTotal});e=m.getRangeExpr(e,x,y);return c._binParamsFromGenRend(a,e).then(function(a){return c._getBins(a,b,t)})}):this._histogramForField(a)};
e.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||a.features||a.valueExpression;return b&&d?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(b){return c._classBreaksFromMemory(a)})};e.prototype.queryFeatureCount=function(a){if(this._hasLocalSource)return h.reject(new n("feature-layer-adapter:not-supported","Layer does not support count query"));var c=this._layer,b=c.createQuery();b.where=
m.mergeWhereClauses(b.where,a);return c.queryFeatureCount(b)};e.prototype.generateRenderer=function(a){var c=this._layer;if(this._hasLocalSource||10.1>c.version)return h.reject(new n("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var b=new H({url:c.parsedUrl.path,source:c.dynamicDataSource,gdbVersion:c.gdbVersion}),c=c.createQuery();a.where=m.mergeWhereClauses(a.where,c.where);return b.execute(a)};e.prototype.load=
function(){var a=this,c=this._layer,b=c.load().then(function(){a.geometryType=c.geometryType;a.objectIdField=c.objectIdField;a.supportsSQLExpression=J.test(c.url);a._hasLocalSource=!c.url&&!!c.source});this.addResolvingPromise(b);return this.when()};return e=C([z.subclass()],e)}(z.declared(G))});